# Misc Grace events
# By Silverswee(e)per

namespace = soh

# soh.6401-6500 reserved

# Partially inspired by JD logic; MUST be JD-locked



##### Misc

### Yearly Grace for tributaries

# on_yearly_pulse event granting Grace
character_event = {
	id = soh.6401
	hide_window = yes
	
	is_triggered_only = yes # on_yearly_pulse
	
	only_independent = yes
	
	has_dlc = "Jade Dragon"
	
	trigger = {
		suzerain = {
			is_chinese_emperor_trigger = yes
		}
		NOT = {
			government = chinese_imperial_government
		}
	}
	
	immediate = {
		set_character_flag = grace_character
		
		any_tributary = {
			if = {
				limit = {
					is_tributary = {
						type = chinese_client_state
					}
				}
				
				if = {
					limit = {
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
							}
							
							controls_religion = yes
						}
					}
					
					change_variable = {
						which = grace
						value = 48
					}
				}
				
				else_if = {
					limit = {
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = yes
							}
							
							real_tier = king
						}
					}
					
					change_variable = {
						which = grace
						value = 36
					}
				}
				
				else_if = {
					limit = {
						real_tier = duke
					}
					
					change_variable = {
						which = grace
						value = 24
					}
				}
				
				else = {
					change_variable = {
						which = grace
						value = 12
					}
				}
			}
			
			else_if = {
				limit = {
					is_tributary = {
						type = chinese_protectorate
					}
				}
				
				if = {
					limit = {
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
							}
							
							controls_religion = yes
						}
					}
					
					change_variable = {
						which = grace
						value = 36
					}
				}
				
				else_if = {
					limit = {
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = yes
							}
							
							real_tier = king
						}
					}
					
					change_variable = {
						which = grace
						value = 27
					}
				}
				
				else_if = {
					limit = {
						real_tier = duke
					}
					
					change_variable = {
						which = grace
						value = 18
					}
				}
				
				else = {
					change_variable = {
						which = grace
						value = 9
					}
				}
			}
			
			else_if = {
				limit = {
					is_tributary = {
						type = chinese_imperial_tributary
					}
				}
				
				if = {
					limit = {
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
							}
							
							controls_religion = yes
						}
					}
					
					change_variable = {
						which = grace
						value = 24
					}
				}
				
				else_if = {
					limit = {
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = yes
							}
							
							real_tier = king
						}
					}
					
					change_variable = {
						which = grace
						value = 18
					}
				}
				
				else_if = {
					limit = {
						real_tier = duke
					}
					
					change_variable = {
						which = grace
						value = 12
					}
				}
				
				else = {
					change_variable = {
						which = grace
						value = 6
					}
				}
			}
			
			else = {
				if = {
					limit = {
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
							}
							
							controls_religion = yes
						}
					}
					
					change_variable = {
						which = grace
						value = 12
					}
				}
				
				else_if = {
					limit = {
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = yes
							}
							
							real_tier = king
						}
					}
					
					change_variable = {
						which = grace
						value = 9
					}
				}
				
				else_if = {
					limit = {
						real_tier = duke
					}
					
					change_variable = {
						which = grace
						value = 6
					}
				}
				
				else = {
					change_variable = {
						which = grace
						value = 3
					}
				}
			}
		}
	}
}

### Yearly Grace for vassals

# on_yearly_pulse event granting Grace
character_event = {
	id = soh.6402
	hide_window = yes
	
	is_triggered_only = yes # on_yearly_pulse
	
	only_independent = yes
	
	has_dlc = "Jade Dragon"
	
	trigger = {
		is_chinese_emperor_trigger = yes
	}
	
	immediate = {
		any_realm_lord = {
			limit = {
				is_playable = yes
				
				NOT = {
					character = ROOT
				}
			}
			
			if = {
				limit = {
					OR = {
						real_tier = king
						controls_religion = yes
						has_minor_title = title_grand_chancellor
					}
				}
				
				change_variable = {
					which = grace
					value = 36
				}
			}
			
			else_if = {
				limit = {
					OR = {
						real_tier = duke
						AND = {
							is_voter = yes
							liege = {
								is_chinese_emperor_trigger = yes
							}
						}
					}
				}
				
				change_variable = {
					which = grace
					value = 24
				}
			}
			
			else = {
				change_variable = {
					which = grace
					value = 12
				}
			}
		}
	}
}

### Grace penalties for usurpation

# on_new_holder_usurpation
character_event = {
	id = soh.6403
	hide_window = yes
	
	is_triggered_only = yes # on_new_holder_usurpation
	
	only_playable = yes
	
	trigger = {
		FROMFROM = {
			OR = {
				is_chinese_emperor_trigger = yes
				any_dynasty_member = { # TIANXIATODO: Improve?
					is_chinese_emperor_trigger = yes
				}
			}
		}
		
		FROM = {
			higher_tier_than = baron
		}
	}
	
	immediate = {
		FROM = {
			if = {
				limit = {
					OR = {
						tier = emperor
						tier = king
						controls_religion = yes
					}
				}
				
				ROOT = {
					# Grace penalty
				}
			}
			
			else_if = {
				limit = {
					tier = duke
				}
				
				ROOT = {
					# Grace penalty
				}
			}
			
			else = {
				ROOT = {
					# Grace penalty
				}
			}
		}
	}
}

### Grace penalties for divorce

# on_divorce penalty
character_event = {
	id = soh.6406
	hide_window = yes
	
	is_triggered_only = yes # on_divorce
	
	has_dlc = "Jade Dragon"
	
	trigger = {
		OR = {
			is_chinese_emperor_trigger = yes
			any_dynasty_member = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		NOT = {
			FROM = {
				is_chinese_emperor_trigger = yes
			}
		}
	}
	
	immediate = {
		# TIANXIATODO: Grace penalty
	}
}

### Grace penalties for imprisonment

# on_become_imprisoned_any_reason event penalizing imprisonment of the EoC and his relatives
character_event = {
	id = soh.6407
	hide_window = yes
	
	is_triggered_only = yes # on_become_imprisoned_any_reason, on_avoided_imprison_fled_country
	
	trigger = {
		OR = {
			is_chinese_emperor_trigger = yes
			any_dynasty_member = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		NOT = {
			FROM = {
				is_chinese_emperor_trigger = yes
			}
		}
	}
	
	immediate = {
		# TIANXIATODO: Grace penalty
	}
}

### Chinese Princess setup + updates

# on_startup for the EoC
character_event = {
	id = soh.6408
	hide_window = yes
	
	is_triggered_only = yes # on_startup
	
	has_dlc = "Jade Dragon"
	
	only_independent = yes
	
	trigger = {
		is_chinese_emperor_trigger = yes
		NOT = {
			has_global_flag = on_startup_chinese_princess_setup
		}
	}
	
	immediate = {
		set_global_flag = on_startup_chinese_princess_setup
		
		set_up_chinese_dynasty_effect = yes
	}
}

# on_yearly_pulse for the EoC
character_event = {
	id = soh.6409
	hide_window = yes
	
	is_triggered_only = yes # on_yearly_pulse
	
	has_dlc = "Jade Dragon"
	
	only_independent = yes
	
	trigger = {
		is_chinese_emperor_trigger = yes
	}
	
	immediate = {
		set_up_chinese_dynasty_effect = yes
	}
}

# on_birth
character_event = {
	id = soh.6410
	hide_window = yes
	
	is_triggered_only = yes # on_birth
	
	has_dlc = "Jade Dragon"
	
	only_women = yes
	
	trigger = {
		e_china = {
			has_law = agnatic_succession
			holder_scope = {
				is_chinese_emperor_trigger = yes
				dynasty = ROOT
			}
		}
		
		employer = {
			OR = {
				is_chinese_emperor_trigger = yes
				
				top_liege = {
					is_chinese_emperor_trigger = yes
				}
				
				liege_before_war = {
					is_chinese_emperor_trigger = yes
				}
			}
		}
				
		has_game_rule = {
			name = imperial_marriages
			value = enabled
		}
	}
	
	immediate = {
		add_trait = dragon_bride_unmarried
	}
}

# on_adolescende
character_event = {
	id = soh.6411
	hide_window = yes
	
	is_triggered_only = yes # on_adolescende
	
	has_dlc = "Jade Dragon"
	
	only_women = yes
	
	trigger = {
		e_china = {
			holder_scope = {
				is_chinese_emperor_trigger = yes
				dynasty = ROOT
			}
		}
		
		is_landed = no
		
		NOT = {
			has_character_flag = not_a_dragon_bride
		}
		
		employer = {
			OR = {
				is_chinese_emperor_trigger = yes
				
				top_liege = {
					is_chinese_emperor_trigger = yes
				}
				
				liege_before_war = {
					is_chinese_emperor_trigger = yes
				}
			}
		}
				
		has_game_rule = {
			name = imperial_marriages
			value = enabled
		}
	}
	
	immediate = {
		if = {
			limit = {
				e_china = {
					has_law = agnatic_succession
				}
			}
			
			add_trait = dragon_bride_unmarried
			
			if = {
				limit = {
					is_betrothed = yes
				}
				
				break_betrothal = yes
			}
			
		}
		
		else = {
			remove_trait = dragon_bride_unmarried
		}
	}
}

# on_adulthood
character_event = {
	id = soh.6412
	hide_window = yes
	
	is_triggered_only = yes # on_adulthood
	
	has_dlc = "Jade Dragon"
	
	only_women = yes
	
	trigger = {
		e_china = {
			holder_scope = {
				is_chinese_emperor_trigger = yes
				dynasty = ROOT
			}
		}
		
		is_landed = no
		
		NOT = {
			has_character_flag = not_a_dragon_bride
		}
		
		employer = {
			OR = {
				is_chinese_emperor_trigger = yes
				
				top_liege = {
					is_chinese_emperor_trigger = yes
				}
				
				liege_before_war = {
					is_chinese_emperor_trigger = yes
				}
			}
		}
				
		has_game_rule = {
			name = imperial_marriages
			value = enabled
		}
	}
	
	immediate = {
		if = {
			limit = {
				e_china = {
					has_law = agnatic_succession
				}
			}
			
			add_trait = dragon_bride_unmarried
			
			if = {
				limit = {
					is_betrothed = yes
				}
				break_betrothal = yes
			}
		}
		
		else = {
			remove_trait = dragon_bride_unmarried
		}
	}
}

### Grace inheritance

# Grace inheritance on_death
character_event= {
	id = soh.6413
	hide_window = yes
	
	is_triggered_only = yes # on_death
	
	has_dlc = "Jade Dragon"
	
	has_character_flag = grace_character
	
	immediate = {
		if = {
			limit = {
				player_heir = {
					is_chinese_emperor_trigger = no
				}
			}
			
			if = {
				limit = {
					top_liege = {
						government = chinese_imperial_government
						is_chinese_emperor_trigger = no
					}
				}
				
				player_heir = {
					set_character_flag = grace_character
					
					change_variable = {
						which = grace
						which = ROOT
					}
				}
			}
			
			else_if = {
				limit = {
					check_variable = {
						which = grace
						value < 0
					}
				}
				
				divide_variable = {
					which = grace
					value = 10
				}
				
				player_heir = {
					set_character_flag = grace_character
					
					change_variable = {
						which = grace
						which = ROOT
					}
				}
			}
			
			else = {
				divide_variable = {
					which = grace
					value = 5
				}
				
				player_heir = {
					set_character_flag = grace_character
					
					change_variable = {
						which = grace
						which = ROOT
					}
				}
			}
		}
	}
}



##### Revoke Chinese Peace Deal

### Inform target

# Inform target - target is EoC
letter_event = {
	id = soh.6414
	desc = EVTDESC_SOH_6414
	
	is_triggered_only = yes # break_chinese_nap targeted_decision; TIANXIATODO
	
	option = {
		name = EVTOPTA_SOH_6414 # The Dragon's memory is long...
		
		opinion = {
			who = FROMFROM
			modifier = china_peace_deal_breaker
		}
	}
}

# Inform target - sender is EoC
letter_event = {
	id = soh.6415
	desc = EVTDESC_SOH_6415
	
	is_triggered_only = yes # break_chinese_nap targeted_decision; TIANXIATODO
	
	option = {
		name = EVTOPTA_SOH_6415 # Dishonour on them, and their cow!
		
		opinion = {
			who = FROMFROM
			modifier = china_peace_deal_breaker
		}
	}
}



##### Bestow Grace

### Bestow Grace

# on_yearly_pulse for vassals and below of China, checking for an AI liege
character_event = {
	id = soh.6416
	hide_window = yes
	
	is_triggered_only = yes # on_yearly_pulse
	
	only_playable = yes
	
	has_dlc = "Jade Dragon"
	
	min_age = 16
	
	capable_only = yes # Works fine!
	
	prisoner = no
	
	trigger = {
		top_liege = {
			is_chinese_emperor_trigger = yes
			ai = yes
			
			NOT = {
				character = ROOT
			}
			
			is_inaccessible_or_incapable_trigger = no
			
			has_regent = no
			
			prestige >= 1000
		}
		
		is_inaccessible_or_incapable_trigger = no
		
		has_regent = no
		
		OR = { # Don't do it for silly people!
			government = chinese_vassal_government
			government = japanese_bureaucracy_government
		}
	}
	
	immediate = {
		top_liege = {
			character_event = { id = soh.6417 } # AI liege gets event
		}
	}
}

# AI liege might bestow Grace
character_event = {
	id = soh.6417
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		random_list = {
			95 = {
				# Do nothing
			}
			
			5 = {
				trigger = {
					prestige >= 1000
					NOT = {
						is_rival = FROM
					}
				}
				
				mult_modifier = {
					factor = 0.1
					FROM = {
						NOT = {
							government = chinese_vassal_government
						}
					}
				}
				
				mult_modifier = {
					factor = 0.1
					FROM = {
						liege = {
							NOT = {
								character = ROOT
							}
						}
					}
				}
				
				mult_modifier = {
					factor = 10
					is_friend = FROM
				}
				
				mult_modifier = {
					factor = 10
					is_lover = FROM
				}
				
				
				mult_modifier = {
					factor = 0.1
					FROM = {
						in_faction = yes
						opinion = {
							who = ROOT
							value < 25
						}
					}
				}
				
				mult_modifier = {
					factor = 0.1
					trait = paranoid
				}
				
				mult_modifier = {
					factor = 2
					trait = trusting
				}
				
				mult_modifier = {
					factor = 5
					trait = charitable
				}
				
				mult_modifier = {
					factor = 2
					trait = humble
				}
				
				mult_modifier = {
					factor = 0.5
					trait = proud
				}
				
				mult_modifier = {
					factor = 0.01
					FROM = {
						check_variable = {
							which = grace
							value >= 2000
						}
					}
				}
				
				# Bestow Grace
				FROM = {
					if = {
						limit = {
							OR = {
								real_tier = king
								controls_religion = yes
								AND = {
									liege = {
										character = ROOT
									}
									is_voter = yes
								}
								any_close_relative = {
									OR = {
										real_tier = emperor
										real_tier = king
										controls_religion = yes
									}
								}
							}
						}
						
						ROOT = {
							prestige = -500
						}
					}
					
					else_if = {
						limit = {
							OR = {
								real_tier = duke
								any_close_relative = {
									real_tier = duke
								}
							}
						}
						
						ROOT = {
							prestige = -250
						}
					}
					
					else = {
						ROOT = {
							prestige = -100
						}
					}
					
					ROOT = {
						save_event_target_as = eoc
					}
					
					letter_event = { id = soh.6419 } # Inform target
				}
			}
		}
	}
}

# Inform target
letter_event = {
	id = soh.6419
	desc = EVTDESC_SOH_6419
	
	is_triggered_only = yes # bestow_grace targeted_decision, and through events above; TIANXIATODO
	
	option = {
		name = EVTOPTA_SOH_6419 # This might be useful...
		
		log = "[From.GetBestName] bestowed Grace on [Root.GetBestName]!"
		
		set_character_flag = grace_character
		
		if = {
			limit = {
				OR = {
					real_tier = king
					controls_religion = yes
					
					AND = {
						liege = {
							character = event_target:eoc
							is_voter = yes
						}
					}
					
					any_close_relative = {
						OR = {
							real_tier = emperor
							real_tier = king
							controls_religion = yes
						}
					}
				}
			}
			
			change_variable = {
				which = grace
				value = 1000
			}
		}
		
		else_if = {
			limit = {
				OR = {
					real_tier = duke
					any_close_relative = {
						real_tier = duke
					}
				}
			}
			
			change_variable = {
				which = grace
				value = 500
			}
		}
		
		else = {
			change_variable = {
				which = grace
				value = 200
			}
		}
		
		opinion = {
			who = event_target:eoc
			modifier = opinion_bestowed_grace
		}
	}
}



##### Border Adjustment

### China

# on_five_year_pulse event for the AI
character_event = {
	id = soh.6420
	hide_window = yes
	
	is_triggered_only = yes # on_five_year_pulse
	
	only_independent = yes
	
	has_dlc = "Jade Dragon"
	
	min_age = 16
	
	capable_only = yes # Works fine!
	
	prisoner = no
	
	trigger = {
		is_chinese_emperor_trigger = yes
		is_inaccessible_or_incapable_trigger = no
		
		war = no
		has_regent = no
		
		prestige >= 5000
		wealth >= 2000
		
		any_tributary = {
			is_tributary = {
				type = chinese_client_state
			}
			
			is_nomadic = no
			
			war = no
			
			is_inaccessible_or_incapable_trigger = no
			
			NOR = {
				reverse_has_opinion_modifier = {
					who = ROOT
					modifier = opinion_grace_china_refused_border_adjustment_tribute
				}
				
				has_opinion_modifier = {
					who = ROOT
					modifier = opinion_grace_china_refused_border_adjustment_request
				}
				
				has_character_modifier = peace_deal_with_china
				
				government = chinese_imperial_government
			}
			
			any_realm_title = {
				tier = count
				
				OR = {
					de_jure_liege_or_above = e_china
					region = world_china
				}
				
				NOT = {
					de_jure_liege_or_above = PREV
				}
			}
		}
	}
	
	immediate = {
		random_tributary = {
			limit = {
				is_inaccessible_or_incapable_trigger = no
				
				war = no
				
				is_nomadic = no
				
				NOR = {
					reverse_has_opinion_modifier = {
						who = ROOT
						modifier = opinion_grace_china_refused_border_adjustment_tribute
					}
					
					has_opinion_modifier = {
						who = ROOT
						modifier = opinion_grace_china_refused_border_adjustment_request
					}
					
					has_character_modifier = peace_deal_with_china
					government = chinese_imperial_government
				}
				
				is_tributary = {
					type = chinese_client_state
				}
				
				any_realm_title = {
					tier = count
					
					OR = {
						de_jure_liege_or_above = e_china
						region = world_china
					}
					
					NOT = {
						de_jure_liege_or_above = PREV
					}
				}
			}
			
			preferred_limit = {
				is_rival = ROOT
			}
			
			preferred_limit = {
				NOR = {
					is_friend = ROOT
					is_lover = ROOT
				}
			}
			
			random_realm_title = {
				limit = {
					tier = count
					
					OR = {
						de_jure_liege_or_above = e_china
						region = world_china
					}
					
					NOT = {
						de_jure_liege_or_above = PREV
					}
				}
				
				preferred_limit = {
					de_jure_liege_or_above = e_china
					region = world_china
				}
				
				duchy = {
					save_event_target_as = border_adjustment_duchy
				}
			}
		}
		
		random_list = {
			75 = {
				# Do nothing
			}
			
			25 = {
				trigger = {
					NOT = {
						trait = content
					}
					wealth >= 5000
					prestige >= 10000
				}
				
				mult_modifier = {
					factor = 10
					trait = ambitious
				}
				
				mult_modifier = {
					factor = 2
					trait = greedy
				}
				
				mult_modifier = {
					factor = 0.5
					trait = charitable
				}
				
				mult_modifier = {
					factor = 5
					trait = proud
				}
				
				mult_modifier = {
					factor = 0.2
					trait = humble
				}
				
				mult_modifier = {
					factor = 5
					trait = envious
				}
				
				# Demand border adjustment
				prestige = -5000
				
				wealth = -2000
				
				random_tributary = {
					limit = {
						is_inaccessible_or_incapable_trigger = no
						
						war = no
						
						is_nomadic = no
						
						NOR = {
							reverse_has_opinion_modifier = {
								who = ROOT
								modifier = opinion_grace_china_refused_border_adjustment_tribute
							}
							
							has_opinion_modifier = {
								who = ROOT
								modifier = opinion_grace_china_refused_border_adjustment_request
							}
							
							has_character_modifier = peace_deal_with_china
							government = chinese_imperial_government
						}
						
						is_tributary = {
							type = chinese_client_state
						}
						
						any_realm_title = {
							tier = count
							
							OR = {
								de_jure_liege_or_above = e_china
								region = world_china
							}
							
							NOT = {
								de_jure_liege_or_above = PREV
							}
						}
					}
					
					random_realm_title = {
						limit = {
							tier = count
							
							OR = {
								de_jure_liege_or_above = e_china
								region = world_china
							}
							
							NOT = {
								de_jure_liege_or_above = PREV
							}
						}
						
						duchy = {
							save_event_target_as = border_adjustment_duchy
						}
					}
				}
				
				any_tributary = {
					limit = {
						is_inaccessible_or_incapable_trigger = no
						
						war = no
						
						is_nomadic = no
						
						NOR = {
							reverse_has_opinion_modifier = {
								who = ROOT
								modifier = opinion_grace_china_refused_border_adjustment_tribute
							}
							
							has_opinion_modifier = {
								who = ROOT
								modifier = opinion_grace_china_refused_border_adjustment_request
							}
							
							has_character_modifier = peace_deal_with_china
							government = chinese_imperial_government
						}
						
						is_tributary = {
							type = chinese_client_state
						}
						
						any_realm_title = {
							tier = count
							
							de_jure_liege = event_target:border_adjustment_duchy
						}
					}
						
					narrative_event = { id = soh.6422 } # Inform relevant characters
				}
			}
		}
	}
}

# Target gets request
narrative_event = {
	id = soh.6422
	title = EVTTITLE_SOH_6422
	desc = EVTDESC_SOH_6422
	picture = GFX_evt_chinese_bureaucrat
	window = EventWindowOffmap
	background = GFX_event_window_news_from_china
	
	is_triggered_only = yes
	
	immediate = {
		# TIANXIATODO: Improve
		# Calculate Grace gain
		# Base
		set_variable = {
			which = grace_gain
			value = 0 # Reset if already used
		}
		change_variable = {
			which = grace_gain
			value = 500
		}
		
		# Traits of EoC
		if = {
			limit = {
				event_target:eoc = {
					trait = greedy
				}
			}
			multiply_variable = {
				which = grace_gain
				value = 1.5
			}
		}
		
		if = {
			limit = {
				event_target:eoc = {
					trait = charitable
				}
			}
			divide_variable = {
				which = grace_gain
				value = 1.5
			}
		}
		
		if = {
			limit = {
				event_target:eoc = {
					trait = ambitious
				}
			}
			multiply_variable = {
				which = grace_gain
				value = 1.2
			}
		}
		
		if = {
			limit = {
				event_target:eoc = {
					trait = content
				}
			}
			divide_variable = {
				which = grace_gain
				value = 1.2
			}
		}
		
		# Specifics of tribute
		event_target:border_adjustment_duchy = {
			any_direct_de_jure_vassal_title = {
				limit = {
					holder_scope = {
						top_liege = {
							character = ROOT
						}
					}
				}
				
				if = {
					limit = {
						location = {
							has_province_modifier = prosperity_modifier_3
							has_disease = no
							any_province_holding = {
								OR = {
									holding_type = castle
									holding_type = city
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 700
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							has_province_modifier = prosperity_modifier_2
							has_disease = no
							any_province_holding = {
								OR = {
									holding_type = castle
									holding_type = city
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 600
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							has_province_modifier = prosperity_modifier_1
							has_disease = no
							any_province_holding = {
								OR = {
									holding_type = castle
									holding_type = city
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 500
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							NOR = {
								has_province_modifier = depopulated_3
								has_province_modifier = depopulated_2
								has_province_modifier = depopulated_1
							}
							any_province_holding = {
								OR = {
									holding_type = castle
									holding_type = city
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 400
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							has_province_modifier = depopulated_1
							any_province_holding = {
								OR = {
									holding_type = castle
									holding_type = city
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 300
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							has_province_modifier = depopulated_2
							any_province_holding = {
								OR = {
									holding_type = castle
									holding_type = city
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 200
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							has_province_modifier = depopulated_3
							any_province_holding = {
								OR = {
									holding_type = castle
									holding_type = city
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 100
						}
					}
				}
				
				if = {
					limit = {
						location = {
							has_province_modifier = prosperity_modifier_3
							has_disease = no
							NOT = {
								any_province_holding = {
									OR = {
										holding_type = castle
										holding_type = city
									}
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 350
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							has_province_modifier = prosperity_modifier_2
							has_disease = no
							NOT = {
								any_province_holding = {
									OR = {
										holding_type = castle
										holding_type = city
									}
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 300
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							has_province_modifier = prosperity_modifier_1
							has_disease = no
							NOT = {
								any_province_holding = {
									OR = {
										holding_type = castle
										holding_type = city
									}
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 250
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							NOR = {
								has_province_modifier = depopulated_3
								has_province_modifier = depopulated_2
								has_province_modifier = depopulated_1
							}
							NOT = {
								any_province_holding = {
									OR = {
										holding_type = castle
										holding_type = city
									}
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 200
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							has_province_modifier = depopulated_1
							NOT = {
								any_province_holding = {
									OR = {
										holding_type = castle
										holding_type = city
									}
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 150
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							has_province_modifier = depopulated_2
							NOT = {
								any_province_holding = {
									OR = {
										holding_type = castle
										holding_type = city
									}
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 100
						}
					}
				}
				
				else_if = {
					limit = {
						location = {
							has_province_modifier = depopulated_3
							NOT = {
								any_province_holding = {
									OR = {
										holding_type = castle
										holding_type = city
									}
								}
							}
						}
					}
					ROOT = {
						change_variable = {
							which = grace_gain
							value = 50
						}
					}
				}
			}
		}
		
		# MoH
		event_target:eoc = {
			trigger_switch = {
				on_trigger = has_character_modifier
				
				mandate_of_heaven_5 = {
					ROOT = {
						divide_variable = {
							which = grace_gain
							value = 1.5
						}
					}
				}
				
				mandate_of_heaven_4 = {
					ROOT = {
						divide_variable = {
							which = grace_gain
							value = 1.25
						}
					}
				}
				
				mandate_of_heaven_2 = {
					ROOT = {
						multiply_variable = {
							which = grace_gain
							value = 1.25
						}
					}
				}
				
				mandate_of_heaven_5 = {
					ROOT = {
						multiply_variable = {
							which = grace_gain
							value = 1.5
						}
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_6422 # Accept the offer
		
		change_variable = {
			which = grace
			which = grace_gain
		}
		
		log = "[Root.GetBestName] agreed to [eoc.GetBestName]'s border adjustment request!"
		
		event_target:border_adjustment_duchy = {
			any_direct_de_jure_vassal_title = {
				limit = {
					holder_scope = {
						top_liege = {
							character = ROOT
						}
					}
				}
				
				if = {
					limit = {
						holder_scope = {
							NOR = {
								any_demesne_title = {
									NOR = {
										de_jure_liege_or_above = event_target:border_adjustment_duchy
										title = event_target:border_adjustment_duchy
									}
								}
								
								any_vassal = {
									any_demesne_title = {
										NOR = {
											de_jure_liege_or_above = event_target:border_adjustment_duchy
											title = event_target:border_adjustment_duchy
										}
									}
								}
							}
						}
					}
					
					holder_scope = {
						set_defacto_liege = event_target:eoc
					}
				}
				
				else = {
					event_target:eoc = {
						grant_title_no_opinion = PREV
					}
				}
			}
			
			if = {
				limit = {
					has_holder = yes
					holder_scope = {
						top_liege = {
							character = event_target:grace_decision_taker
						}
					}
				}
				
				event_target:eoc = {
					grant_title_no_opinion = PREV
				}
			}
		}
		
		set_truce = {
			who = event_target:eoc
			years = 10
		}
		
		event_target:eoc = {
			set_truce = {
				who = ROOT
				years = 10
			}
			
			letter_event = { id = soh.6423 } # Inform EoC
		}
		
		ai_chance = {
			factor = 100
			
			trigger = {
				root_hates_china_trigger = no
			}
			
			mult_modifier = {
				factor = 5
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_5
				}
			}
			
			mult_modifier = {
				factor = 2
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_4
				}
			}
			mult_modifier = {
				factor = 0.25
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_2
				}
			}
			
			mult_modifier = {
				factor = 0.1
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_1
				}
			}
			
			mult_modifier = {
				factor = 0.1
				trait = proud
			}
			
			mult_modifier = {
				factor = 0.1
				trait = brave
			}
		}
	}
	
	option = {
		name = EVTOPTB_SOH_6422 # Refuse
		
		log = "[Root.GetBestName] refused [eoc.GetBestName]'s border adjustment request!"
		
		prestige = 100
		
		#detract_grace_massive_effect = yes # TIANXIATODO
		
		event_target:eoc = {
			letter_event = { id = soh.6424 } # Inform EoC
		}
		
		ai_chance = {
			factor = 100
			
			mult_modifier = {
				factor = 0.1
				trait = humble
			}
			
			mult_modifier = {
				factor = 0.1
				trait = craven
			}
		}
	}
}

# Target accepted
letter_event = {
	id = soh.6423
	desc = EVTDESC_SOH_6423
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6423 # Great!
	}
}

# Target refused - China claims the relevant titles
letter_event = {
	id = soh.6424
	desc = EVTDESC_SOH_6424
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6424 # How rude!
		
		opinion = {
			who = FROM
			modifier = opinion_grace_china_refused_border_adjustment_request
		}
		
		FROM = {
			any_demesne_title = {
				limit = {
					OR = {
						title = event_target:border_adjustment_duchy
						de_jure_liege = event_target:border_adjustment_duchy
					}
				
				}
				
				add_weak_claim = ROOT
			}
			
			any_realm_lord = {
				limit = {
					any_demesne_title = {
						OR = {
							title = event_target:border_adjustment_duchy
							de_jure_liege = event_target:border_adjustment_duchy
						}
					}
				}
				
				any_demesne_title = {
					limit = {
						OR = {
							title = event_target:border_adjustment_duchy
							de_jure_liege = event_target:border_adjustment_duchy
						}
					}
					
					add_weak_claim = ROOT
				}
			}
		}
	}
}



##### Increase Tributary Tier

### Decision events

# on_bi_yearly_pulse event for the AI
character_event = {
	id = soh.6425
	hide_window = yes
	
	is_triggered_only = yes # on_bi_yearly_pulse
	
	only_independent = yes
	
	has_dlc = "Jade Dragon"
	
	min_age = 16
	
	capable_only = yes # Works fine!
	
	prisoner = no
	
	trigger = {
		is_chinese_emperor_trigger = yes
		is_inaccessible_or_incapable_trigger = no
		
		war = no
		has_regent = no
		
		prestige >= 5000
		wealth >= 2000
		
		any_tributary = {
			is_inaccessible_or_incapable_trigger = no
			
			war = no
			
			NOR = {
				has_character_modifier = peace_deal_with_china
				has_non_aggression_pact_with = ROOT
				ROOT = {
					has_truce = PREV
				}
			}
			
			OR = {
				AND = {
					is_tributary = {
						type = chinese_client_state
					}
					
					ROOT = {
						NOR = {
							has_character_modifier = mandate_of_heaven_3
							has_character_modifier = mandate_of_heaven_2
							has_character_modifier = mandate_of_heaven_1
						}
					}
					
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = ROOT
											top_liege = {
												character = ROOT
											}
										}
									}
								}
								
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
					
					# China isn't interested in integrating tribal or nomadic land
					NOR = {
						is_tribal = yes
						is_nomadic = yes
					}
				}
				
				AND = {
					is_tributary = {
						type = chinese_protectorate
					}
					
					ROOT = {
						NOR = {
							has_character_modifier = mandate_of_heaven_2
							has_character_modifier = mandate_of_heaven_1
						}
					}
					
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = ROOT
											top_liege = {
												character = ROOT
											}
										}
									}
								}
								
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
					
					# China isn't really interested in nomads, and only cares about tribals in China/its de jure
					NOR = {
						AND = {
							is_tribal = yes
							NOT = {
								any_realm_province = {
									OR = {
										region = world_china
										county = {
											de_jure_liege_or_above = e_china
										}
									}
								}
							}
						}
						is_nomadic = yes
					}
				}
				
				AND = {
					is_tributary = {
						type = chinese_imperial_tributary
					}
					
					ROOT = {
						NOT = {
							has_character_modifier = mandate_of_heaven_1
						}
					}
					
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = ROOT
											top_liege = {
												character = ROOT
											}
											is_tributary = {
												type = chinese_client_state
											}
											is_tributary = {
												type = chinese_protectorate
											}
											top_liege = {
												OR = {
													is_tributary = {
														type = chinese_client_state
													}
													is_tributary = {
														type = chinese_protectorate
													}
												}
											}
										}
									}
								}
								
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														top_liege = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
															}
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
															is_tributary = {
																type = chinese_client_state
															}
															is_tributary = {
																type = chinese_protectorate
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
					
					# China doesn't want to get dragged into messy wars in the steppes
					NOT = {
						is_nomadic = yes
					}
				}
				
				AND = {
					NOR = {
						is_tributary = {
							type = chinese_client_state
						}
						is_tributary = {
							type = chinese_protectorate
						}
						is_tributary = {
							type = chinese_imperial_tributary
						}
					}
					
					ROOT = {
						NOT = {
							has_character_modifier = mandate_of_heaven_1
						}
					}
					
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = ROOT
											top_liege = {
												character = ROOT
											}
											AND = {
												OR = {
													is_tributary = {
														type = chinese_client_state
													}
													is_tributary = {
														type = chinese_protectorate
													}
													is_tributary = {
														type = chinese_imperial_tributary
													}
												}
												suzerain = {
													is_chinese_emperor_trigger = yes
												}
											}
											top_liege = {
												OR = {
													is_tributary = {
														type = chinese_client_state
													}
													is_tributary = {
														type = chinese_protectorate
													}
													is_tributary = {
														type = chinese_imperial_tributary
													}
												}
												suzerain = {
													is_chinese_emperor_trigger = yes
												}
											}
										}
									}
								}
								
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
														AND = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
																is_tributary = {
																	type = chinese_imperial_tributary
																}
															}
															suzerain = {
																is_chinese_emperor_trigger = yes
															}
														}
														top_liege = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
																is_tributary = {
																	type = chinese_imperial_tributary
																}
															}
															suzerain = {
																is_chinese_emperor_trigger = yes
															}
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
															AND = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	is_tributary = {
																		type = chinese_imperial_tributary
																	}
																}
																suzerain = {
																	is_chinese_emperor_trigger = yes
																}
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	is_tributary = {
																		type = chinese_imperial_tributary
																	}
																}
																suzerain = {
																	is_chinese_emperor_trigger = yes
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
			
			OR = {
				AND = {
					is_tributary = {
						type = chinese_client_state
					}
					
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
							
							ROOT = {
								prestige >= 5000
								wealth >= 10000
							}
						}
						
						AND = {
							OR = {
								real_tier = king
								AND = {
									real_tier = emperor
									is_nomadic = yes
								}
							}
							
							ROOT = {
								prestige >= 2500
								wealth >= 5000
							}
						}
						
						AND = {
							OR = {
								real_tier = duke
								real_tier = count
							}
							
							ROOT = {
								prestige >= 1000
								wealth >= 1000
							}
						}
					}
				}
				
				AND = {
					is_tributary = {
						type = chinese_protectorate
					}
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
							
							ROOT = {
								prestige >= 2500
								wealth >= 5000
							}
						}
						
						AND = {
							OR = {
								real_tier = king
								AND = {
									real_tier = emperor
									is_nomadic = yes
								}
							}
							
							ROOT = {
								prestige >= 1000
								wealth >= 1000
							}
						}
						
						AND = {
							OR = {
								real_tier = duke
								real_tier = count
							}
							
							ROOT = {
								prestige >= 500
								wealth >= 500
							}
						}
					}
				}
				
				AND = {
					is_tributary = {
						type = chinese_imperial_tributary
					}
					
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
							
							ROOT = {
								prestige >= 1000
								wealth >= 1000
							}
						}
						
						AND = {
							OR = {
								real_tier = king
								AND = {
									real_tier = emperor
									is_nomadic = yes
								}
							}
							
							ROOT = {
								prestige >= 500
								wealth >= 500
							}
						}
						
						AND = {
							OR = {
								real_tier = duke
								real_tier = count
							}
							
							ROOT = {
								prestige >= 250
								wealth >= 100
							}
						}
					}
				}
				
				AND = {
					NOR = {
						is_tributary = {
							type = chinese_client_state
						}
						is_tributary = {
							type = chinese_protectorate
						}
						is_tributary = {
							type = chinese_imperial_tributary
						}
					}
					
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
							
							ROOT = {
								prestige >= 500
								wealth >= 500
							}
						}
						
						AND = {
							OR = {
								real_tier = king
								AND = {
									real_tier = emperor
									is_nomadic = yes
								}
							}
							
							ROOT = {
								prestige >= 250
								wealth >= 100
							}
						}
						
						AND = {
							OR = {
								real_tier = duke
								real_tier = count
							}
							
							ROOT = {
								prestige >= 100
								wealth >= 50
							}
						}
					}
				}
			}
			
			NOR = {
				has_opinion_modifier = {
					who = ROOT
					modifier = opinion_grace_increased_tributary_tier
				}
				
				has_opinion_modifier = {
					who = ROOT
					modifier = opinion_grace_decreased_tributary_tier
				}
				
				reverse_has_opinion_modifier = {
					who = ROOT
					modifier = opinion_grace_china_refused_increase_tributary_tier
				}
				
				reverse_has_opinion_modifier = {
					who = ROOT
					modifier = opinion_grace_china_refused_increase_tributary_tier_offer
				}
			}
		}
	}
	
	immediate = {
		save_event_target_as = eoc
		
		random_tributary = {
			limit = {
				war = no
				is_inaccessible_or_incapable_trigger = no
				NOR = {
					has_character_modifier = peace_deal_with_china
					has_non_aggression_pact_with = ROOT
					ROOT = {
						has_truce = PREV
					}
				}
				
				OR = {
					AND = {
						is_tributary = {
							type = chinese_client_state
						}
						
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
											}
										}
									}
									
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
												
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
						
						# China isn't interested in integrating tribal or nomadic land
						NOR = {
							is_tribal = yes
							is_nomadic = yes
						}
					}
					
					AND = {
						is_tributary = {
							type = chinese_protectorate
						}
						
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
											}
										}
									}
									
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
												
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
						
						# China isn't really interested in nomads, and only cares about tribals in China/its de jure
						NOR = {
							AND = {
								is_tribal = yes
								NOT = {
									any_realm_province = {
										OR = {
											region = world_china
											county = {
												de_jure_liege_or_above = e_china
											}
										}
									}
								}
							}
							is_nomadic = yes
						}
					}
					
					AND = {
						is_tributary = {
							type = chinese_imperial_tributary
						}
						
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
												is_tributary = {
													type = chinese_client_state
												}
												is_tributary = {
													type = chinese_protectorate
												}
												top_liege = {
													OR = {
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
													}
												}
											}
										}
									}
									
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
															is_tributary = {
																type = chinese_client_state
															}
															is_tributary = {
																type = chinese_protectorate
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																}
															}
														}
													}
												}
												
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
																top_liege = {
																	OR = {
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
						
						# China doesn't want to get dragged into messy wars in the steppes
						NOT = {
							is_nomadic = yes
						}
					}
					
					AND = {
						NOR = {
							is_tributary = {
								type = chinese_client_state
							}
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_imperial_tributary
							}
						}
						
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
												AND = {
													OR = {
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														is_tributary = {
															type = chinese_imperial_tributary
														}
													}
													suzerain = {
														is_chinese_emperor_trigger = yes
													}
												}
												top_liege = {
													OR = {
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														is_tributary = {
															type = chinese_imperial_tributary
														}
													}
													suzerain = {
														is_chinese_emperor_trigger = yes
													}
												}
											}
										}
									}
									
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
															AND = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	is_tributary = {
																		type = chinese_imperial_tributary
																	}
																}
																suzerain = {
																	is_chinese_emperor_trigger = yes
																}
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	is_tributary = {
																		type = chinese_imperial_tributary
																	}
																}
																suzerain = {
																	is_chinese_emperor_trigger = yes
																}
															}
														}
													}
												}
												
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
																AND = {
																	OR = {
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																		is_tributary = {
																			type = chinese_imperial_tributary
																		}
																	}
																	suzerain = {
																		is_chinese_emperor_trigger = yes
																	}
																}
																top_liege = {
																	OR = {
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																		is_tributary = {
																			type = chinese_imperial_tributary
																		}
																	}
																	suzerain = {
																		is_chinese_emperor_trigger = yes
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
				
				OR = {
					AND = {
						is_tributary = {
							type = chinese_client_state
						}
						
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
								
								ROOT = {
									prestige >= 5000
									wealth >= 10000
								}
							}
							
							AND = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
								
								ROOT = {
									prestige >= 2500
									wealth >= 5000
								}
							}
							
							AND = {
								OR = {
									real_tier = duke
									real_tier = count
								}
								
								ROOT = {
									prestige >= 1000
									wealth >= 1000
								}
							}
						}
					}
					
					AND = {
						is_tributary = {
							type = chinese_protectorate
						}
						
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
								
								ROOT = {
									prestige >= 2500
									wealth >= 5000
								}
							}
							
							AND = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
								
								ROOT = {
									prestige >= 1000
									wealth >= 1000
								}
							}
							
							AND = {
								OR = {
									real_tier = duke
									real_tier = count
								}
								
								ROOT = {
									prestige >= 500
									wealth >= 500
								}
							}
						}
					}
					
					AND = {
						is_tributary = {
							type = chinese_imperial_tributary
						}
						
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
								
								ROOT = {
									prestige >= 1000
									wealth >= 1000
								}
							}
							
							AND = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
								
								ROOT = {
									prestige >= 500
									wealth >= 500
								}
							}
							
							AND = {
								OR = {
									real_tier = duke
									real_tier = count
								}
								
								ROOT = {
									prestige >= 250
									wealth >= 100
								}
							}
						}
					}
					
					AND = {
						NOR = {
							is_tributary = {
								type = chinese_client_state
							}
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_imperial_tributary
							}
						}
						
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
								
								ROOT = {
									prestige >= 500
									wealth >= 500
								}
							}
							
							AND = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
								
								ROOT = {
									prestige >= 250
									wealth <= 100
								}
							}
							
							AND = {
								OR = {
									real_tier = duke
									real_tier = count
								}
								
								ROOT = {
									prestige >= 100
									wealth >= 50
								}
							}
						}
					}
				}
				
				NOR = {
					has_opinion_modifier = {
						who = ROOT
						modifier = opinion_grace_increased_tributary_tier
					}
					
					has_opinion_modifier = {
						who = ROOT
						modifier = opinion_grace_decreased_tributary_tier
					}
					
					reverse_has_opinion_modifier = {
						who = ROOT
						modifier = opinion_grace_china_refused_increase_tributary_tier
					}
					
					reverse_has_opinion_modifier = {
						who = ROOT
						modifier = opinion_grace_china_refused_increase_tributary_tier_offer
					}
				}
			}
			
			preferred_limit = {
				is_tributary = {
					type = chinese_client_state
				}
				is_rival = ROOT
			}
			
			preferred_limit = {
				is_tributary = {
					type = chinese_protectorate
				}
				is_rival = ROOT
			}
			
			preferred_limit = {
				is_tributary = {
					type = chinese_imperial_tributary
				}
				is_rival = ROOT
			}
			
			preferred_limit = {
				is_tributary = {
					type = chinese_client_state
				}
				
				NOR = {
					is_friend = ROOT
					is_lover = ROOT
				}
			}
			
			preferred_limit = {
				is_tributary = {
					type = chinese_protectorate
				}
				
				NOR = {
					is_friend = ROOT
					is_lover = ROOT
				}
			}
			
			preferred_limit = {
				is_tributary = {
					type = chinese_imperial_tributary
				}
				
				NOR = {
					is_friend = ROOT
					is_lover = ROOT
				}
			}
			
			save_event_target_as = target_tributary
		}
		
		random_list = {
			
			75 = {
				# Do nothing
			}
			
			25 = {
				trigger = {
					NOT = {
						trait = content
					}
				}
				
				mult_modifier = {
					factor = 10
					trait = ambitious
				}
				
				mult_modifier = {
					factor = 2
					trait = greedy
				}
				
				mult_modifier = {
					factor = 0.5
					trait = charitable
				}
				
				mult_modifier = {
					factor = 10
					trait = proud
				}
				
				mult_modifier = {
					factor = 0.1
					trait = humble
				}
				
				mult_modifier = {
					factor = 5
					trait = envious
				}
				
				# Do it
				event_target:target_tributary = {
					if = {
						limit = {
							is_tributary = {
								type = chinese_client_state
							}
						}
						
						if = {
							limit = {
								real_tier = emperor
								is_nomadic = no
							}
							
							ROOT = {
								prestige = -5000
								wealth = -10000
							}
						}
						
						else_if = {
							limit = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
							}
							
							ROOT = {
								prestige = -2500
								wealth = -5000
							}
						}
						
						else = {
							ROOT = {
								prestige = -1000
								wealth = -1000
							}
						}
					}
					
					else_if = {
						limit = {
							is_tributary = {
								type = chinese_protectorate
							}
						}
						
						if = {
							limit = {
								real_tier = emperor
								is_nomadic = no
							}
							
							ROOT = {
								prestige = -2500
								wealth = -5000
							}
						}
						
						else_if = {
							limit = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
							}
							
							ROOT = {
								prestige = -1000
								wealth = -1000
							}
						}
						
						else = {
							ROOT = {
								prestige = 500
								wealth = 500
							}
						}
					}
					
					else_if = {
						limit = {
							is_tributary = {
								type = chinese_imperial_tributary
							}
						}
						
						if = {
							limit = {
								real_tier = emperor
								is_nomadic = no
							}
							
							ROOT = {
								prestige = -1000
								wealth = -1000
							}
						}
						
						else_if = {
							limit = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
							}
							
							ROOT = {
								prestige = -500
								wealth = -500
							}
						}
						
						else = {
							ROOT = {
								prestige = -250
								wealth = -100
							}
						}
					}
					
					else = {
						if = {
							limit = {
								real_tier = emperor
								is_nomadic = no
							}
							
							ROOT = {
								prestige = -500
								wealth = -500
							}
						}
						
						else_if = {
							limit = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
							}
							
							ROOT = {
								prestige = -250
								wealth = -100
							}
						}
						
						else = {
							ROOT = {
								prestige = -100
								wealth = -50
							}
						}
					}
					
					ROOT = {
						save_event_target_as = eoc
					}
					
					narrative_event = { id = soh.6427 } # Inform target
				}
			}
		}
	}
}

# Target gets request
narrative_event = {
	id = soh.6427
	title = EVTTITLE_SOH_6427
	desc = EVTDESC_SOH_6427
	picture = GFX_evt_chinese_bureaucrat
	window = EventWindowOffmap
	background = GFX_event_window_news_from_china
	
	is_triggered_only = yes
	
	option = {
		trigger = {
			controls_religion = no
			mercenary = no
			holy_order = no
			NAND = {
				could_have_japanese_government_trigger = yes
				any_realm_lord = {
					OR = {
						is_the_tenno_trigger = yes
						is_ryukyuan_tenno_trigger = yes
					}
				}
			}
		}
		
		name = EVTOPTA_SOH_6427 # Very well...
		
		log = "[Root.GetBestName] agreed to [eoc.GetBestName]'s suggestion to increase tributary tier!"
		
		# If we accept, we get half of the wealth the EoC paid
		if = {
			limit = {
				is_tributary = {
					type = chinese_client_state
				}
			}
			
			if = {
				limit = {
					tier = emperor
					is_nomadic = no
				}
				wealth = 5000
			}
			
			else_if = {
				limit = {
					OR = {
						tier = king
						AND = {
							tier = emperor
							is_nomadic = yes
						}
					}
				}
				wealth = 2500
			}
			
			else = {
				wealth = 500
			}
		}
		
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			if = {
				limit = {
					tier = emperor
					is_nomadic = no
				}
				wealth = 2500
			}
			
			else_if = {
				limit = {
					OR = {
						tier = king
						AND = {
							tier = emperor
							is_nomadic = yes
						}
					}
				}
				wealth = 500
			}
			
			else = {
				wealth = 250
			}
		}
		
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_imperial_tributary
				}
			}
			
			if = {
				limit = {
					tier = emperor
					is_nomadic = no
				}
				wealth = 500
			}
			
			else_if = {
				limit = {
					OR = {
						tier = king
						AND = {
							tier = emperor
							is_nomadic = yes
						}
					}
				}
				wealth = 250
			}
			
			else = {
				wealth = 50
			}
		}
		
		else = {
			if = {
				limit = {
					tier = emperor
					is_nomadic = no
				}
				wealth = 250
			}
			
			else_if = {
				limit = {
					OR = {
						tier = king
						AND = {
							tier = emperor
							is_nomadic = yes
						}
					}
				}
				wealth = 50
			}
			
			else = {
				wealth = 50
			}
		}
		
		increase_tributary_tier_or_vassalize_effect = yes
		
		event_target:eoc = {
			letter_event = { id = soh.6428 } # Inform EoC
		}
		
		ai_chance = {
			factor = 100
			
			trigger = {
				root_hates_china_trigger = no
				NAND = {
					tier = emperor
					is_nomadic = no
				}
				realm_size < 100
				NAND = {
					is_tributary = {
						type = chinese_client_state
					}
					can_have_confucian_bureaucracy_and_eastern_imperial_trigger = no
				}
			}
			
			mult_modifier = {
				factor = 5
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_5
				}
			}
			
			mult_modifier = {
				factor = 2
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_4
				}
			}
			
			mult_modifier = {
				factor = 0.25
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_2
				}
			}
			
			mult_modifier = {
				factor = 0.1
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_1
				}
			}
			
			mult_modifier = {
				factor = 0.1
				trait = proud
			}
			
			mult_modifier = {
				factor = 0.1
				trait = brave
			}
			
			mult_modifier = {
				factor = 0.01
				NOT = {
					is_within_diplo_range = event_target:eoc # If you're far from China, don't bother
				}
			}
			
			mult_modifier = {
				factor = 0.01 # Make random distant realms unlikely to try to become higher tier tributaries
				NOT = {
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = event_target:eoc
											top_liege = {
												OR = {
													character = event_target:eoc
													suzerain = {
														character = event_target:eoc
													}
												}
											}
											suzerain = {
												character = event_target:eoc
											}
										}
									}
								}
								
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = event_target:eoc
														top_liege = {
															OR = {
																character = event_target:eoc
																suzerain = {
																	character = event_target:eoc
																}
															}
														}
														suzerain = {
															character = event_target:eoc
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													owner = {
														OR = {
															character = event_target:eoc
															top_liege = {
																OR = {
																	character = event_target:eoc
																	suzerain = {
																		character = event_target:eoc
																	}
																}
															}
															suzerain = {
																character = event_target:eoc
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
			
			# Kings and nomads are less willing to upgrade their tier
			mult_modifier = {
				factor = 0.1
				OR = {
					tier = king
					is_nomadic = yes
				}
			}
			
			# Small realms are more likely to be willing to become tributaries
			mult_modifier = {
				factor = 5
				realm_size < 10
			}
			
			# Large realms are less likely to be willing to upgrade their tier
			mult_modifier = {
				factor = 0.1
				realm_size >= 50
			}
			
			# Wants to be independent due to traits
			mult_modifier = {
				factor = 0.1
				OR = {
					trait = proud
					trait = ambitious
					trait = brave
				}
				NOR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# Wants to be independent due to traits
			mult_modifier = {
				factor = 0.25
				OR = {
					trait = proud
					trait = ambitious
					trait = brave
				}
				OR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# Is likely to be scared of China
			mult_modifier = {
				factor = 10
				OR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# China is less than twice as powerful
			mult_modifier = {
				factor = 0.1
				relative_power = {
					who = event_target:eoc
					power >= 0.5
				}
			}
			
			# China is less than four times as powerful
			mult_modifier = {
				factor = 0.25
				relative_power = {
					who = event_target:eoc
					power >= 0.25
				}
			}
			
			# China is more than ten times as powerful
			mult_modifier = {
				factor = 5
				relative_power = {
					who = event_target:eoc
					power < 0.1
				}
			}
			
			# Same culture
			mult_modifier = {
				factor = 5
				culture = event_target:eoc
			}
			
			# Same culture group
			mult_modifier = {
				factor = 2
				culture_group = event_target:eoc
				NOT = {
					culture = event_target:eoc
				}
			}
			
			# Chinese
			mult_modifier = {
				factor = 2
				culture_group = chinese_group
			}
			
			# Is "Chinese enough"
			mult_modifier = {
				factor = 2
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = yes
			}
			
			# Is "Chinese enough"
			mult_modifier = {
				factor = 5
				government = chinese_vassal_government
			}
			
			# We are uncivilized
			mult_modifier = {
				factor = 0.1
				OR = {
					is_tribal = yes
					is_nomadic = yes
				}
			}
			
			# Would become a vassal
			mult_modifier = {
				factor = 0.1
				is_tributary = {
					type = chinese_client_state
				}
			}
			
			# Would become a Client State
			mult_modifier = {
				factor = 0.25
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			# Would become a Protectorate
			mult_modifier = {
				factor = 0.5
				is_tributary = {
					type = chinese_imperial_tributary
				}
			}
			
			# I have strong neighbours and protection would be nice
			mult_modifier = {
				factor = 2
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					NOT = {
						ROOT = {
							relative_power = {
								who = PREV
								power = 0.5
							}
						}
					}
				}
				
				NOR = {
					is_tributary = {
						type = chinese_client_state
					}
					is_tributary = {
						type = chinese_protectorate
					}
				}
			}
			
			mult_modifier = {
				factor = 5
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					NOT = {
						ROOT = {
							relative_power = {
								who = PREV
								power = 0.25
							}
						}
					}
				}
				NOR = {
					is_tributary = {
						type = chinese_client_state
					}
					is_tributary = {
						type = chinese_protectorate
					}
				}
			}
			
			mult_modifier = {
				factor = 10
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					relative_power = {
						who = PREV
						power < 0.1
					}
				}
			}
			
			# If someone is just too different, they should want to be free a bit more often
			mult_modifier = {
				factor = 0.1
				OR = {
					is_nomadic = yes
					is_tribal = yes
				}
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = no
			}
		}
	}
	
	option = {
		trigger = {
			OR = { # We do not have enough Grace to avoid the request (half the cost of downgrading from our current tier)
				AND = {
					is_tributary = {
						type = chinese_client_state
					}
					
					OR = {
						AND = {
							NOT = { # If a Client State is too distant, China will be more willing to let them go
								any_realm_province = {
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														is_chinese_emperor_trigger = yes
														top_liege = {
															is_chinese_emperor_trigger = yes
														}
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														top_liege = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
															}
														}
													}
													NOR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													OR = {
														AND = {
															has_owner = yes
															owner = {
																OR = {
																	is_chinese_emperor_trigger = yes
																	top_liege = {
																		is_chinese_emperor_trigger = yes
																	}
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	top_liege = {
																		OR = {
																			is_tributary = {
																				type = chinese_client_state
																			}
																			is_tributary = {
																				type = chinese_protectorate
																			}
																		}
																	}
																}
																NOR = {
																	character = ROOT
																	top_liege = {
																		character = ROOT
																	}
																}
															}
														}
														
														AND = {
															is_land = no
															any_neighbor_province = {
																has_owner = yes
																owner = {
																	OR = {
																		is_chinese_emperor_trigger = yes
																		top_liege = {
																			is_chinese_emperor_trigger = yes
																		}
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																		top_liege = {
																			OR = {
																				is_tributary = {
																					type = chinese_client_state
																				}
																				is_tributary = {
																					type = chinese_protectorate
																				}
																			}
																		}
																	}
																	NOR = {
																		character = ROOT
																		top_liege = {
																			character = ROOT
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
							
							check_variable = {
								which = grace
								value >= 2500
							}
						}
						
						check_variable = {
							which = grace
							value >= 5000
						}
					}
				}
				
				AND = {
					is_tributary = {
						type = chinese_protectorate
					}
					OR = {
						AND = {
							NOT = { # If a Protectorate is too distant, China will be more willing to let them go
								any_realm_province = {
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														is_chinese_emperor_trigger = yes
														top_liege = {
															is_chinese_emperor_trigger = yes
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													OR = {
														AND = {
															has_owner = yes
															owner = {
																OR = {
																	is_chinese_emperor_trigger = yes
																	top_liege = {
																		is_chinese_emperor_trigger = yes
																	}
																}
															}
														}
														
														AND = {
															is_land = no
															any_neighbor_province = {
																has_owner = yes
																owner = {
																	OR = {
																		is_chinese_emperor_trigger = yes
																		top_liege = {
																			is_chinese_emperor_trigger = yes
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
							
							check_variable = {
								which = grace
								value >= 1000
							}
						}
						
						check_variable = {
							which = grace
							value >= 2000
						}
					}
				}
				
				AND = {
					is_tributary = {
						type = chinese_imperial_tributary
					}
					
					check_variable = {
						which = grace
						value >= 500
					}
				}
				
				AND = {
					NOR = {
						is_tributary = {
							type = chinese_client_state
						}
						is_tributary = {
							type = chinese_protectorate
						}
						is_tributary = {
							type = chinese_imperial_tributary
						}
					}
					
					check_variable = {
						which = grace
						value >= 250
					}
				}
			}
		}
		name = EVTOPTB_SOH_6427 # I think you'll reconsider...
		
		log = "[Root.GetBestName] refused [eoc.GetBestName]'s suggestion to increase tributary tier (Grace)!"
		
		if = {
			limit = {
				is_tributary = {
					type = chinese_client_state
				}
			}
			
			if = {
				limit = {
					NOT = { # If a Client State is too distant, China will be more willing to let them go
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = event_target:eoc
												top_liege = {
													character = event_target:eoc
												}
												is_tributary = {
													type = chinese_client_state
												}
												is_tributary = {
													type = chinese_protectorate
												}
												top_liege = {
													OR = {
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
													}
												}
											}
											NOR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
											}
										}
									}
									
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = event_target:eoc
															top_liege = {
																character = event_target:eoc
															}
															is_tributary = {
																type = chinese_client_state
															}
															is_tributary = {
																type = chinese_protectorate
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																}
															}
														}
														NOR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
												
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = event_target:eoc
																top_liege = {
																	character = event_target:eoc
																}
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
																top_liege = {
																	OR = {
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																	}
																}
															}
															NOR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
				
				change_variable = {
					which = grace
					value = -2500
				}
			}
			
			else = {
				change_variable = {
					which = grace
					value = -5000
				}
			}
		}
		
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			if = {
				limit = {
					NOT = { # If a Protectorate is too distant, China will be more willing to let them go
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = event_target:eoc
												top_liege = {
													character = event_target:eoc
												}
											}
										}
									}
									
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = event_target:eoc
															top_liege = {
																character = event_target:eoc
															}
														}
													}
												}
												
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = event_target:eoc
																top_liege = {
																	character = event_target:eoc
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
				
				change_variable = {
					which = grace
					value = -1000
				}
			}
			
			else = {
				change_variable = {
					which = grace
					value = -2000
				}
			}
		}
		
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_imperial_tributary
				}
			}
			
			change_variable = {
				which = grace
				value = -500
			}
		}
		
		else = {
			change_variable = {
				which = grace
				value = -2500
			}
		}
		
		event_target:eoc = {
			letter_event = { id = soh.6429 } # Inform EoC
		}
		
		ai_chance = {
			factor = 100
			
			mult_modifier = {
				factor = 10
				NOT = {
					is_within_diplo_range = event_target:eoc # If you're far from China, don't bother
				}
			}
			
			mult_modifier = {
				factor = 10 # Make random distant realms more likely to try to break free
				NOT = {
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = event_target:eoc
											top_liege = {
												OR = {
													character = event_target:eoc
													suzerain = {
														character = event_target:eoc
													}
												}
											}
											suzerain = {
												character = event_target:eoc
											}
										}
									}
								}
								
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = event_target:eoc
														top_liege = {
															OR = {
																character = event_target:eoc
																suzerain = {
																	character = event_target:eoc
																}
															}
														}
														suzerain = {
															character = event_target:eoc
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													owner = {
														OR = {
															character = event_target:eoc
															top_liege = {
																OR = {
																	character = event_target:eoc
																	suzerain = {
																		character = event_target:eoc
																	}
																}
															}
															suzerain = {
																character = event_target:eoc
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
			
			# Kings and nomads are more likely to want to break free
			mult_modifier = {
				factor = 2
				OR = {
					tier = king
					is_nomadic = yes
				}
			}
			
			# Non-nomadic emperors want to break free very frequently
			mult_modifier = {
				factor = 10
				tier = emperor
				is_nomadic = no
			}
			
			# Small realms are more likely to be willing to become tributaries
			mult_modifier = {
				factor = 0.25
				realm_size < 10
			}
			
			# Large realms are less likely to be willing to become tributaries
			mult_modifier = {
				factor = 5
				realm_size >= 50
			}
			
			# At this size, the realm is too powerful to willingly become a tributary
			mult_modifier = {
				factor = 10
				realm_size >= 100
			}
			
			# Wants to be independent due to traits
			mult_modifier = {
				factor = 10
				OR = {
					trait = proud
					trait = ambitious
					trait = brave
				}
				NOR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# Wants to be independent due to traits
			mult_modifier = {
				factor = 5
				OR = {
					trait = proud
					trait = ambitious
					trait = brave
				}
				OR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# Is likely to be scared of China
			mult_modifier = {
				factor = 0.1
				OR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# China is less than twice as powerful
			mult_modifier = {
				factor = 2
				relative_power = {
					who = event_target:eoc
					power >= 0.5
				}
			}
			
			# China is less than four times as powerful
			mult_modifier = {
				factor = 2
				relative_power = {
					who = event_target:eoc
					power >= 0.25
				}
			}
			
			# China is more than ten times as powerful
			mult_modifier = {
				factor = 0.1
				relative_power = {
					who = event_target:eoc
					power < 0.1
				}
			}
			
			# Same culture
			mult_modifier = {
				factor = 0.1
				culture = event_target:eoc
			}
			
			# Same culture group
			mult_modifier = {
				factor = 0.5
				culture_group = event_target:eoc
				NOT = {
					culture = event_target:eoc
				}
			}
			
			mult_modifier = {
				factor = 100
				root_hates_china_trigger = yes # Dislikes the EoC
			}
			
			# Chinese
			mult_modifier = {
				factor = 0.25
				culture_group = chinese_group
			}
			
			# Is "Chinese enough"
			mult_modifier = {
				factor = 0.25
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = yes
			}
			
			# Is "Chinese enough"
			mult_modifier = {
				factor = 0.25
				government = chinese_vassal_government
			}
			
			# We are uncivilized
			mult_modifier = {
				factor = 10
				OR = {
					is_tribal = yes
					is_nomadic = yes
				}
			}
			
			# We won't willingly join China if we don't have a "Chinese enough" religion
			mult_modifier = {
				factor = 10
				is_tributary = {
					type = chinese_client_state
				}
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = no
			}
			
			# Is a Client State
			mult_modifier = {
				factor = 10
				is_tributary = {
					type = chinese_client_state
				}
			}
			
			# Is a Protectorate
			mult_modifier = {
				factor = 5
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			# Wants to break free on succession
			mult_modifier = {
				factor = 2
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			# Controls a religion, is a holy order, or is a mercenary and thus doesn't want to be a tributary
			mult_modifier = {
				factor = 100
				OR = {
					controls_religion = yes
					mercenary = yes
					holy_order = yes
				}
			}
			
			# I have strong neighbours and protection would be nice
			mult_modifier = {
				factor = 0.5
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					NOT = {
						ROOT = {
							relative_power = {
								who = PREV
								power = 0.5
							}
						}
					}
				}
				NOT = {
					is_tributary = {
						type = chinese_client_state
					}
				}
			}
			
			mult_modifier = {
				factor = 0.5
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					NOT = {
						ROOT = {
							relative_power = {
								who = PREV
								power = 0.25
							}
						}
					}
				}
				NOT = {
					is_tributary = {
						type = chinese_client_state
					}
				}
			}
			
			mult_modifier = {
				factor = 0.1
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					NOT = {
						ROOT = {
							relative_power = {
								who = PREV
								power = 0.1
							}
						}
					}
				}
				NOT = {
					is_tributary = {
						type = chinese_client_state
					}
				}
			}
			
			# If someone is just too different, they should want to be free a bit more often
			mult_modifier = {
				factor = 10
				OR = {
					is_nomadic = yes
					is_tribal = yes
				}
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = no
			}
			
			# If you have rather little Grace, perhaps you should stay a bit longer...
			mult_modifier = {
				factor = 0.01
				check_variable = {
					which = grace
					value < 1000
				}
			}
		}
	}
	
	option = {
		trigger = {
			NOR = { # We do not have enough Grace to avoid the request (half the cost of downgrading from our current tier)
				AND = {
					is_tributary = {
						type = chinese_client_state
					}
					
					OR = {
						AND = {
							NOT = { # If a Client State is too distant, China will be more willing to let them go
								any_realm_province = {
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = event_target:eoc
														top_liege = {
															character = event_target:eoc
														}
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														top_liege = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
															}
														}
													}
													NOR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													OR = {
														AND = {
															has_owner = yes
															owner = {
																OR = {
																	character = event_target:eoc
																	top_liege = {
																		character = event_target:eoc
																	}
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	top_liege = {
																		OR = {
																			is_tributary = {
																				type = chinese_client_state
																			}
																			is_tributary = {
																				type = chinese_protectorate
																			}
																		}
																	}
																}
																NOR = {
																	character = ROOT
																	top_liege = {
																		character = ROOT
																	}
																}
															}
														}
														
														AND = {
															is_land = no
															any_neighbor_province = {
																has_owner = yes
																owner = {
																	OR = {
																		character = event_target:eoc
																		top_liege = {
																			character = event_target:eoc
																		}
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																		top_liege = {
																			OR = {
																				is_tributary = {
																					type = chinese_client_state
																				}
																				is_tributary = {
																					type = chinese_protectorate
																				}
																			}
																		}
																	}
																	NOR = {
																		character = ROOT
																		top_liege = {
																			character = ROOT
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
							
							check_variable = {
								which = grace
								value >= 2500
							}
						}
						
						check_variable = {
							which = grace
							value >= 5000
						}
					}
				}
				
				AND = {
					is_tributary = {
						type = chinese_protectorate
					}
					
					OR = {
						AND = {
							NOT = { # If a Protectorate is too distant, China will be more willing to let them go
								any_realm_province = {
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = event_target:eoc
														top_liege = {
															character = event_target:eoc
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													OR = {
														AND = {
															has_owner = yes
															owner = {
																OR = {
																	character = event_target:eoc
																	top_liege = {
																		character = event_target:eoc
																	}
																}
															}
														}
														
														AND = {
															is_land = no
															any_neighbor_province = {
																has_owner = yes
																owner = {
																	OR = {
																		character = event_target:eoc
																		top_liege = {
																			character = event_target:eoc
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
							
							check_variable = {
								which = grace
								value >= 1000
							}
						}
						
						check_variable = {
							which = grace
							value >= 2000
						}
					}
				}
				
				AND = {
					is_tributary = {
						type = chinese_imperial_tributary
					}
					
					check_variable = {
						which = grace
						value >= 500
					}
				}
				
				AND = {
					NOR = {
						is_tributary = {
							type = chinese_client_state
						}
						is_tributary = {
							type = chinese_protectorate
						}
						is_tributary = {
							type = chinese_imperial_tributary
						}
					}
					
					check_variable = {
						which = grace
						value >= 250
					}
				}
			}
		}
		
		name = EVTOPTC_SOH_6427 # You're bluffing!
		
		log = "[Root.GetBestName] refused [eoc.GetBestName]'s suggestion to increase tributary tier (no Grace)!"
		
		event_target:eoc = {
			letter_event = { id = soh.6430 } # Inform EoC
		}
		
		if = {
			limit = {
				is_tributary = {
					type = chinese_client_state
				}
			}
			
			if = {
				limit = {
					NOT = { # If a Client State is too distant, China will be more willing to let them go
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = event_target:eoc
												top_liege = {
													character = event_target:eoc
												}
												is_tributary = {
													type = chinese_client_state
												}
												is_tributary = {
													type = chinese_protectorate
												}
												top_liege = {
													OR = {
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
													}
												}
											}
											NOR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
											}
										}
									}
									
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = event_target:eoc
															top_liege = {
																character = event_target:eoc
															}
															is_tributary = {
																type = chinese_client_state
															}
															is_tributary = {
																type = chinese_protectorate
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																}
															}
														}
														NOR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
												
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = event_target:eoc
																top_liege = {
																	character = event_target:eoc
																}
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
																top_liege = {
																	OR = {
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																	}
																}
															}
															NOR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
				
				change_variable = {
					which = grace
					value = -2500
				}
			}
			
			else = {
				change_variable = {
					which = grace
					value = -5000
				}
			}
		}
		
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			if = {
				limit = {
					NOT = { # If a Protectorate is too distant, China will be more willing to let them go
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = event_target:eoc
												top_liege = {
													character = event_target:eoc
												}
											}
										}
									}
									
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = event_target:eoc
															top_liege = {
																character = event_target:eoc
															}
														}
													}
												}
												
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = event_target:eoc
																top_liege = {
																	character = event_target:eoc
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
				
				change_variable = {
					which = grace
					value = -1000
				}
			}
			
			else = {
				change_variable = {
					which = grace
					value = -2000
				}
			}
		}
		
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_imperial_tributary
				}
			}
			
			change_variable = {
				which = grace
				value = -500
			}
		}
		
		else = {
			change_variable = {
				which = grace
				value = -2500
			}
		}
		
		ai_chance = {
			factor = 100
			
			mult_modifier = {
				factor = 0.1
				trait = humble
			}
			mult_modifier = {
				factor = 0.1
				trait = craven
			}
			
			mult_modifier = {
				factor = 10
				NOT = {
					is_within_diplo_range = event_target:eoc # If you're far from China, you should want to break free
				}
			}
			
			mult_modifier = {
				factor = 10 # Make random distant realms more likely to try to break free
				NOT = {
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = event_target:eoc
											top_liege = {
												OR = {
													character = event_target:eoc
													suzerain = {
														character = event_target:eoc
													}
												}
											}
											suzerain = {
												character = event_target:eoc
											}
										}
									}
								}
								
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = event_target:eoc
														top_liege = {
															OR = {
																character = event_target:eoc
																suzerain = {
																	character = event_target:eoc
																}
															}
														}
														suzerain = {
															character = event_target:eoc
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													owner = {
														OR = {
															character = event_target:eoc
															top_liege = {
																OR = {
																	character = event_target:eoc
																	suzerain = {
																		character = event_target:eoc
																	}
																}
															}
															suzerain = {
																character = event_target:eoc
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
			
			# Kings and nomads are more likely to want to break free
			mult_modifier = {
				factor = 2
				OR = {
					tier = king
					is_nomadic = yes
				}
			}
			
			# Non-nomadic emperors want to break free very frequently
			mult_modifier = {
				factor = 10
				tier = emperor
				is_nomadic = no
			}
			
			# Small realms are more likely to be willing to become tributaries
			mult_modifier = {
				factor = 0.25
				realm_size < 10
			}
			
			# Large realms are less likely to be willing to become tributaries
			mult_modifier = {
				factor = 5
				realm_size >= 50
			}
			
			# At this size, the realm is too powerful to willingly become a tributary
			mult_modifier = {
				factor = 10
				realm_size >= 100
			}
			
			# Wants to be independent due to traits
			mult_modifier = {
				factor = 10
				OR = {
					trait = proud
					trait = ambitious
					trait = brave
				}
				NOR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# Wants to be independent due to traits
			mult_modifier = {
				factor = 5
				OR = {
					trait = proud
					trait = ambitious
					trait = brave
				}
				OR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# Is likely to be scared of China
			mult_modifier = {
				factor = 0.1
				OR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# China is less than twice as powerful
			mult_modifier = {
				factor = 2
				relative_power = {
					who = event_target:eoc
					power >= 0.5
				}
			}
			
			# China is less than four times as powerful
			mult_modifier = {
				factor = 2
				relative_power = {
					who = event_target:eoc
					power >= 0.25
				}
			}
			
			# China is more than ten times as powerful
			mult_modifier = {
				factor = 0.1
				relative_power = {
					who = event_target:eoc
					power < 0.1
				}
			}
			
			# Same culture
			mult_modifier = {
				factor = 0.1
				culture = event_target:eoc
			}
			# Same culture group
			mult_modifier = {
				factor = 0.5
				culture_group = event_target:eoc
				NOT = {
					culture = event_target:eoc
				}
			}
			
			mult_modifier = {
				factor = 100
				root_hates_china_trigger = yes # Dislikes the EoC
			}
			
			# Chinese
			mult_modifier = {
				factor = 0.25
				culture_group = chinese_group
			}
			
			# Is "Chinese enough"
			mult_modifier = {
				factor = 0.25
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = yes
			}
			
			# Is "Chinese enough"
			mult_modifier = {
				factor = 0.25
				government = chinese_vassal_government
			}
			
			# We are uncivilized
			mult_modifier = {
				factor = 10
				OR = {
					is_tribal = yes
					is_nomadic = yes
				}
			}
			
			# We won't willingly join China if we don't have a "Chinese enough" religion
			mult_modifier = {
				factor = 10
				is_tributary = {
					type = chinese_client_state
				}
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = no
			}
			
			# Is a Client State
			mult_modifier = {
				factor = 10
				is_tributary = {
					type = chinese_client_state
				}
			}
			
			# Is a Protectorate
			mult_modifier = {
				factor = 5
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			# Wants to break free on succession
			mult_modifier = {
				factor = 2
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			# Controls a religion, is a holy order, or is a mercenary and thus doesn't want to be a tributary
			mult_modifier = {
				factor = 100
				OR = {
					controls_religion = yes
					mercenary = yes
					holy_order = yes
				}
			}
			
			# I have strong neighbours and protection would be nice
			mult_modifier = {
				factor = 0.5
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					NOT = {
						ROOT = {
							relative_power = {
								who = PREV
								power = 0.5
							}
						}
					}
				}
				NOT = {
					is_tributary = {
						type = chinese_client_state
					}
				}
			}
			
			mult_modifier = {
				factor = 0.5
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					NOT = {
						ROOT = {
							relative_power = {
								who = PREV
								power = 0.25
							}
						}
					}
				}
				NOT = {
					is_tributary = {
						type = chinese_client_state
					}
				}
			}
			
			mult_modifier = {
				factor = 0.1
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					NOT = {
						ROOT = {
							relative_power = {
								who = PREV
								power = 0.1
							}
						}
					}
				}
				NOT = {
					is_tributary = {
						type = chinese_client_state
					}
				}
			}
			
			# If someone is just too different, they should want to be free a bit more often
			mult_modifier = {
				factor = 10
				OR = {
					is_nomadic = yes
					is_tribal = yes
				}
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = no
			}
			
			# If you have rather little Grace, perhaps you should stay a bit longer...
			mult_modifier = {
				factor = 0.01
				check_variable = {
					which = grace
					value < 1000
				}
			}
		}
	}
}

# Target accepted
letter_event = {
	id = soh.6428
	desc = EVTDESC_SOH_6428
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6428 # Great!
	}
}

# Target refused - used Grace to avoid war
letter_event = {
	id = soh.6429
	desc = EVTDESC_SOH_6429
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6429 # I see...
		
		opinion = {
			who = FROM
			modifier = opinion_grace_china_refused_increase_tributary_tier_offer
		}
	}
}

# Target refused - not enough Grace to dodge war
letter_event = {
	id = soh.6430
	desc = EVTDESC_SOH_6430
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6430 # Then war it is!
		
		log = "China is forcing [From.GetBestName] to increase tributary tier!"
		
		unsafe_war = { # TIANXIATODO: Does this need to be unsafe_war?
			target = FROM
			casus_belli = chinese_tributary_tier_war
		}
		
		opinion = {
			who = FROM
			modifier = opinion_grace_china_refused_increase_tributary_tier_offer
		}
	}
	
	option = {
		name = EVTOPTB_SOH_6430 # I see...
		
		log = "China dares not force [From.GetBestName] to increase tributary tier!"
		
		# TIANXIATODO: Grace penalty
		
		opinion = {
			who = FROM
			modifier = opinion_grace_china_refused_increase_tributary_tier_offer
		}
		
		FROM = {
			letter_event = { id = soh.6431 } # Inform tributary
		}
	}
}

# EoC backed down
letter_event = {
	id = soh.6431
	desc = EVTDESC_SOH_6431
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6431 # Great!
		prestige = 500
	}
}

### War ends

# Other tributaries informed - lower tier?
narrative_event = {
	id = soh.6432
	title = EVTTITLE_SOH_6432
	desc = EVTDESC_SOH_6432
	picture = GFX_evt_china_civil_war
	window = EventWindowOffmap
	background = GFX_event_window_news_from_china
	
	is_triggered_only = yes # CB; TIANXIATODO
	
	immediate = {
		e_china = {
			holder_scope = {
				save_event_target_as = eoc
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_6432 # My current relationship with China is fine
		
		log = "[Root.GetBestName] did not lower tributary tier for free!"
		
		e_china = {
			holder_scope = {
				letter_event = { id = soh.6433 } # Inform China that the tributary lowered its tier
			}
		}
		
		ai_chance = {
			factor = 100
			
			trigger = {
				root_hates_china_trigger = no
				NAND = {
					tier = emperor
					is_nomadic = no
				}
				
				realm_size < 100
				controls_religion = no
				holy_order = no
				mercenary = no
				
				NAND = {
					could_have_japanese_government_trigger = yes
					any_realm_lord = {
						OR = {
							is_the_tenno_trigger = yes
							is_ryukyuan_tenno_trigger = yes
						}
					}
				}
				
				NAND = {
					is_tributary = {
						type = chinese_client_state
					}
					can_have_confucian_bureaucracy_and_eastern_imperial_trigger = no
				}
			}
			
			mult_modifier = {
				factor = 5
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_5
				}
			}
			
			mult_modifier = {
				factor = 2
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_4
				}
			}
			
			mult_modifier = {
				factor = 0.25
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_2
				}
			}
			
			mult_modifier = {
				factor = 0.1
				event_target:eoc = {
					has_character_modifier = mandate_of_heaven_1
				}
			}
			
			mult_modifier = {
				factor = 0.1
				trait = proud
			}
			
			mult_modifier = {
				factor = 0.1
				trait = brave
			}
			
			mult_modifier = {
				factor = 0.01
				NOT = {
					is_within_diplo_range = event_target:eoc # If you're far from China, don't bother
				}
			}
			
			mult_modifier = {
				factor = 0.01 # Make random distant realms unlikely to try to become higher tier tributaries
				NOT = {
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = event_target:eoc
											top_liege = {
												OR = {
													character = event_target:eoc
													suzerain = {
														character = event_target:eoc
													}
												}
											}
											suzerain = {
												character = event_target:eoc
											}
										}
									}
								}
								
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = event_target:eoc
														top_liege = {
															OR = {
																character = event_target:eoc
																suzerain = {
																	character = event_target:eoc
																}
															}
														}
														suzerain = {
															character = event_target:eoc
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													owner = {
														OR = {
															character = event_target:eoc
															top_liege = {
																OR = {
																	character = event_target:eoc
																	suzerain = {
																		character = event_target:eoc
																	}
																}
															}
															suzerain = {
																character = event_target:eoc
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
			
			# Kings and nomads are less willing to upgrade their tier
			mult_modifier = {
				factor = 0.1
				OR = {
					tier = king
					is_nomadic = yes
				}
			}
			
			# Small realms are more likely to be willing to become tributaries
			mult_modifier = {
				factor = 5
				realm_size < 10
			}
			
			# Large realms are less likely to be willing to upgrade their tier
			mult_modifier = {
				factor = 0.1
				realm_size = 50
			}
			
			# Wants to be independent due to traits
			mult_modifier = {
				factor = 0.1
				OR = {
					trait = proud
					trait = ambitious
					trait = brave
				}
				NOR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# Wants to be independent due to traits
			mult_modifier = {
				factor = 0.25
				OR = {
					trait = proud
					trait = ambitious
					trait = brave
				}
				OR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# Is likely to be scared of China
			mult_modifier = {
				factor = 10
				OR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# China is less than twice as powerful
			mult_modifier = {
				factor = 0.1
				relative_power = {
					who = event_target:eoc
					power >= 0.5
				}
			}
			
			# China is less than four times as powerful
			mult_modifier = {
				factor = 0.25
				relative_power = {
					who = event_target:eoc
					power >= 0.25
				}
			}
			
			# China is more than ten times as powerful
			mult_modifier = {
				factor = 5
				relative_power = {
					who = event_target:eoc
					power < 0.1
				}
			}
			
			# Same culture
			mult_modifier = {
				factor = 5
				culture = event_target:eoc
			}
			
			# Same culture group
			mult_modifier = {
				factor = 2
				culture_group = event_target:eoc
				NOT = {
					culture = event_target:eoc
				}
			}
			
			# Chinese
			mult_modifier = {
				factor = 2
				culture_group = chinese_group
			}
			
			# Is "Chinese enough"
			mult_modifier = {
				factor = 2
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = yes
			}
			
			# Is "Chinese enough"
			mult_modifier = {
				factor = 5
				government = chinese_vassal_government
			}
			
			# We are uncivilized
			mult_modifier = {
				factor = 0.1
				OR = {
					is_tribal = yes
					is_nomadic = yes
				}
			}
			
			# Would become a vassal
			mult_modifier = {
				factor = 0.1
				is_tributary = {
					type = chinese_client_state
				}
			}
			
			# Would become a Client State
			mult_modifier = {
				factor = 0.25
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			# Would become a Protectorate
			mult_modifier = {
				factor = 0.5
				is_tributary = {
					type = chinese_imperial_tributary
				}
			}
			
			# I have strong neighbours and protection would be nice
			mult_modifier = {
				factor = 2
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					ROOT = {
						relative_power = {
							who = PREV
							power < 0.5
						}
					}
				}
			}
			
			mult_modifier = {
				factor = 5
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					ROOT = {
						relative_power = {
							who = PREV
							power < 0.25
						}
					}
				}
			}
			
			mult_modifier = {
				factor = 10
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					NOT = {
						ROOT = {
							relative_power = {
								who = PREV
								power = 0.1
							}
						}
					}
				}
			}
			
			# If someone is just too different, they should want to be free a bit more often
			mult_modifier = {
				factor = 0.1
				OR = {
					is_nomadic = yes
					is_tribal = yes
				}
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = no
			}
		}
	}
	
	option = {
		name = EVTOPTB_SOH_6432 # It is time to re-define our relationship!
		
		log = "[Root.GetBestName] lowered tributary tier for free!"
		
		decrease_tributary_tier_or_release_effect = yes
		
		e_china = {
			holder_scope = {
				letter_event = { id = soh.6434 } # Inform China that the tributary lowered its tier
			}
		}
		
		ai_chance = {
			factor = 100
			
			mult_modifier = {
				factor = 0.1
				trait = humble
			}
			
			mult_modifier = {
				factor = 0.1
				trait = craven
			}
			
			mult_modifier = {
				factor = 10
				NOT = {
					e_china = {
						holder_scope = {
							is_within_diplo_range = ROOT # If you're far from China, you should want to break free
						}
					}
				}
			}
			
			mult_modifier = {
				factor = 10 # Make random distant realms more likely to try to break free
				NOT = {
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = event_target:eoc
											top_liege = {
												OR = {
													character = event_target:eoc
													suzerain = {
														character = event_target:eoc
													}
												}
											}
											suzerain = {
												character = event_target:eoc
											}
										}
									}
								}
								
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = event_target:eoc
														top_liege = {
															OR = {
																character = event_target:eoc
																suzerain = {
																	character = event_target:eoc
																}
															}
														}
														suzerain = {
															character = event_target:eoc
														}
													}
												}
											}
											
											AND = {
												is_land = no
												any_neighbor_province = {
													owner = {
														OR = {
															character = event_target:eoc
															top_liege = {
																OR = {
																	character = event_target:eoc
																	suzerain = {
																		character = event_target:eoc
																	}
																}
															}
															suzerain = {
																character = event_target:eoc
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
			
			# Kings and nomads are more likely to want to break free
			mult_modifier = {
				factor = 2
				OR = {
					tier = king
					is_nomadic = yes
				}
			}
			
			# Non-nomadic emperors want to break free very frequently
			mult_modifier = {
				factor = 10
				tier = emperor
				is_nomadic = no
			}
			
			# Small realms are more likely to be willing to become tributaries
			mult_modifier = {
				factor = 0.25
				realm_size < 10
			}
			
			# Large realms are less likely to be willing to become tributaries
			mult_modifier = {
				factor = 5
				realm_size >= 50
			}
			
			# At this size, the realm is too powerful to willingly become a tributary
			mult_modifier = {
				factor = 10
				realm_size >= 100
			}
			
			# Wants to be independent due to traits
			mult_modifier = {
				factor = 10
				OR = {
					trait = proud
					trait = ambitious
					trait = brave
				}
				NOR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# Wants to be independent due to traits
			mult_modifier = {
				factor = 5
				OR = {
					trait = proud
					trait = ambitious
					trait = brave
				}
				OR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# Is likely to be scared of China
			mult_modifier = {
				factor = 0.1
				OR = {
					trait = humble
					trait = content
					trait = craven
				}
			}
			
			# China is less than twice as powerful
			mult_modifier = {
				factor = 2
				relative_power = {
					who = event_target:eoc
					power >= 0.5
				}
			}
			
			# China is less than four times as powerful
			mult_modifier = {
				factor = 2
				relative_power = {
					who = event_target:eoc
					power >= 0.25
				}
			}
			
			# China is more than ten times as powerful
			mult_modifier = {
				factor = 0.1
				relative_power = {
					who = event_target:eoc
					power < 0.1
				}
			}
			
			# Same culture
			mult_modifier = {
				factor = 0.1
				culture = event_target:eoc
			}
			
			# Same culture group
			mult_modifier = {
				factor = 0.5
				culture_group = event_target:eoc
				NOT = {
					culture = event_target:eoc
				}
			}
			
			mult_modifier = {
				factor = 100
				root_hates_china_trigger = yes # Dislikes the EoC
			}
			
			# Chinese
			mult_modifier = {
				factor = 0.25
				culture_group = chinese_group
			}
			
			# Is "Chinese enough"
			mult_modifier = {
				factor = 0.25
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = yes
			}
			
			# Is "Chinese enough"
			mult_modifier = {
				factor = 0.25
				government = chinese_vassal_government
			}
			
			# We are uncivilized
			mult_modifier = {
				factor = 10
				OR = {
					is_tribal = yes
					is_nomadic = yes
				}
			}
			# Is a Client State
			mult_modifier = {
				factor = 10
				is_tributary = {
					type = chinese_client_state
				}
			}
			
			# Is a Protectorate
			mult_modifier = {
				factor = 5
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			# Wants to break free on succession
			mult_modifier = {
				factor = 2
				is_tributary = {
					type = chinese_protectorate
				}
			}
			
			# I have strong neighbours and protection would be nice
			mult_modifier = {
				factor = 0.5
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					ROOT = {
						relative_power = {
							who = PREV
							power < 0.5
						}
					}
				}
			}
			
			mult_modifier = {
				factor = 0.5
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					ROOT = {
						relative_power = {
							who = PREV
							power < 0.25
						}
					}
				}
			}
			
			mult_modifier = {
				factor = 0.1
				any_neighbor_independent_ruler = {
					is_china_or_defended_chinese_tributary_trigger = no
					ROOT = {
						relative_power = {
							who = PREV
							power < 0.1
						}
					}
				}
			}
			
			# If someone is just too different, they should want to be free a bit more often
			mult_modifier = {
				factor = 10
				OR = {
					is_nomadic = yes
					is_tribal = yes
				}
				can_have_confucian_bureaucracy_and_eastern_imperial_trigger = no
			}
			
			# If you have rather little Grace, perhaps you should stay a bit longer...
			mult_modifier = {
				factor = 0.01
				NOT = {
					check_variable = {
						which = grace
						value = 1000
					}
				}
			}
		}
	}
}

# Tributary remained loyal - EoC
letter_event = {
	id = soh.6433
	desc = EVTDESC_SOH_6433
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6433 # Great!
	}
}

# Tributary lowered tier or broke free - EoC
letter_event = {
	id = soh.6434
	desc = EVTDESC_SOH_6434
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6434 # How ungrateful!
		
		opinion = {
			who = FROM
			modifier = opinion_grace_decreased_tributary_tier
		}
	}
}



### Misc

# Remove marriage blockers for characters with sent_to_china if they end up landed
character_event = {
	id = soh.6435
	hide_window = yes
	
	is_triggered_only = yes # on_new_holder/on_new_holder_usurpation/on_new_holder_inheritance
	
	only_playable = yes

	trigger = {
		trait = sent_to_china
	}
	
	immediate = {
		if = {
			limit = {
				NAND = {
					religion = shinto
					controls_religion = yes
					is_female = yes
				}
			}
			clr_character_flag = ai_flag_refuse_concubinage
			clr_character_flag = ai_flag_refuse_marriage
		}
	}
}