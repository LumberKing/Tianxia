# Treasure Fleet CBs
punitive_expedition = { # Check
	name = CB_NAME_PUNITIVE_EXPEDITION
	war_name = WAR_NAME_PUNITIVE_EXPEDITION
	sprite = 36
	truce_days = 365
	is_permanent = no
	hostile_against_others = yes
	allow_whitepeace = no # You win, or you lose
	can_ask_to_join_war = no
	
	defender_unoccupied_warscore = yes
	
	is_valid = {
		e_china = {
			has_holder = yes
			holder_scope = {
				is_chinese_emperor_trigger = yes
			}
		}
		2753 = { # Hangzhou
			NOT = {
				has_province_flag = abort_treasure_fleet_asap
			}
		}
		FROM = {
			independent = yes
		}
	}
	
	on_success = {
		ROOT = {
			prestige = 500
			disband_event_forces = tf_punitive_expedition
		}
		FROM = {
			prestige = -500
			e_china = {
				holder_scope = {
					reverse_imprison = FROM
					make_tributary = {
						who = FROM
						tributary_type = chinese_client_state
					}
				}
			}
			#hidden_tooltip = {
			#	if = {
			#		limit = {
			#			has_dlc = "Jade Dragon"
			#		}
			#		character_event = { id = grace.7 days = 365 }
			#	}
			#}
		}
		hidden_tooltip = {
			e_china = {
				holder_scope = {
					if = {
						limit = {
							government = chinese_imperial_government
						}
						mandate_boost_large_effect = yes
					}
				}
			}
			FROM = {
				hidden_tooltip = {
					if = {
						limit = {
							government = chinese_imperial_government
						}
						mandate_penalty_large_effect = yes
					}
				}
			}
		}
	}
	
	on_reverse_demand = {
		ROOT = {
			prestige = -500
			disband_event_forces = tf_punitive_expedition
			imprison = FROM
		}
		FROM = {
			prestige = 500
		}
		hidden_tooltip = {
			e_china = {
				holder_scope = {
					if = {
						limit = {
							government = chinese_imperial_government
						}
						mandate_penalty_large_effect = yes
					}
				}
			}
			FROM = {
				hidden_tooltip = {
					if = {
						limit = {
							government = chinese_imperial_government
						}
						mandate_boost_large_effect = yes
					}
				}
			}
		}
	}
	
	on_attacker_leader_death = {
		end_war = invalid
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
	}
}

treasure_fleet_tributary_war = { # Check
	name = CB_NAME_TREASURE_FLEET_TRIBUTARY
	war_name = WAR_NAME_TREASURE_FLEET_TRIBUTARY
	sprite = 36
	is_permanent = no
	truce_days = 365
	hostile_against_others = yes
	can_ask_to_join_war = no
	
	defender_unoccupied_warscore = yes
	
	is_valid = {
		e_china = {
			has_holder = yes
			holder_scope = {
				is_chinese_emperor_trigger = yes
			}
		}
		2753 = { # Hangzhou
			NOT = {
				has_province_flag = abort_treasure_fleet_asap
			}
		}
		FROM = {
			independent = yes
		}
	}
	
	on_success = {
		ROOT = {
			prestige = 500
			disband_event_forces = tf_punitive_expedition
		}
		FROM = {
			prestige = -500
			e_china = {
				holder_scope = {
					make_tributary = {
						who = FROM
						tributary_type = chinese_peripheral_tributary
					}
				}
			}
			#hidden_tooltip = {
			#	if = {
			#		limit = {
			#			has_dlc = "Jade Dragon"
			#		}
			#		character_event = { id = grace.7 days = 365 }
			#	}
			#}
		}
		hidden_tooltip = {
			e_china = {
				holder_scope = {
					if = {
						limit = {
							government = chinese_imperial_government
						}
						mandate_penalty_small_effect = yes
					}
				}
			}
			FROM = {
				hidden_tooltip = {
					if = {
						limit = {
							government = chinese_imperial_government
						}
						mandate_penalty_small_effect = yes
					}
				}
			}
		}
	}
	
	on_fail = {
		ROOT = {
			prestige = -250
			disband_event_forces = tf_punitive_expedition
		}
		FROM = {
			prestige = 250
		}
		hidden_tooltip = {
			e_china = {
				holder_scope = {
					if = {
						limit = {
							government = chinese_imperial_government
						}
						mandate_penalty_trivial_effect = yes
					}
				}
			}
			FROM = {
				hidden_tooltip = {
					if = {
						limit = {
							government = chinese_imperial_government
						}
						mandate_boost_trivial_effect = yes
					}
				}
			}
		}
	}
	
	on_reverse_demand = {
		ROOT = {
			prestige = -500
			disband_event_forces = tf_punitive_expedition
			imprison = FROM
		}
		FROM = {
			prestige = 500
		}
		hidden_tooltip = {
			e_china = {
				holder_scope = {
					if = {
						limit = {
							government = chinese_imperial_government
						}
						mandate_penalty_trivial_effect = yes
					}
				}
			}
			FROM = {
				hidden_tooltip = {
					if = {
						limit = {
							government = chinese_imperial_government
						}
						mandate_boost_trivial_effect = yes
					}
				}
			}
		}
	}
	
	on_attacker_leader_death = {
		end_war = invalid
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
		
		modifier = {
			factor = 2
			FROM = {
				trait = proud
			}
		}
		
		modifier = {
			factor = 2
			FROM = {
				trait = brave
			}
		}
		
		modifier = {
			factor = 2
			FROM = {
				trait = greedy
			}
		}
		
		modifier = {
			factor = 3
			FROM = {
				tier = KING
			}
		}

		modifier = {
			factor = 0.85
			ROOT = {
				relative_power = { who = FROM power = 1.2 }
			}
		}

		modifier = {
			factor = 0.85
			ROOT = {
				relative_power = { who = FROM power = 1.5 }
			}
		}

		modifier = {
			factor = 0.8
			ROOT = {
				relative_power = { who = FROM power = 2.0 }
			}
		}

		modifier = {
			factor = 0.8
			ROOT = {
				relative_power = { who = FROM power = 2.5 }
			}
		}

		modifier = {
			factor = 0.8
			ROOT = {
				relative_power = { who = FROM power = 3 }
			}
		}

		modifier = {
			factor = 0.75
			ROOT = {
				relative_power = { who = FROM power = 4 }
			}
		}

		modifier = {
			factor = 0.75
			ROOT = {
				relative_power = { who = FROM power = 5 }
			}
		}

		modifier = {
			factor = 0.75
			ROOT = {
				relative_power = { who = FROM power = 6 }
			}
		}

		modifier = {
			factor = 0.5
			ROOT = {
				relative_power = { who = FROM power = 8 }
			}
		}

		modifier = {
			factor = 0.25
			ROOT = {
				relative_power = { who = FROM power = 10 }
			}
		}

		modifier = {
			factor = 2
			ROOT = {
				distance_from_realm = { who = FROM value = 20 }
			}
		}

		modifier = {
			factor = 2
			ROOT = {
				distance_from_realm = { who = FROM value = 40 }
			}
		}
		
		modifier = {
			factor = 3
			ROOT = {
				distance_from_realm = { who = FROM value = 80 }
			}
		}
		
		modifier = {
			factor = 4
			ROOT = {
				distance_from_realm = { who = FROM value = 120 }
			}
		}
	}
}

tf_invasion = { # Check
	name = CB_NAME_TREASURE_FLEET_INVASION
	war_name = WAR_NAME_TREASURE_FLEET_INVASION
	sprite = 36
	truce_days = 365
	is_permanent = no
	hostile_against_others = yes
	allow_whitepeace = no # You win, or you lose
	attacker_can_call_allies = no # This might let vassals of China join, which would be stupid...
	can_ask_to_join_war = no
	check_de_jure_tier = KING
	
	defender_unoccupied_warscore = yes
	
	on_add = {
		ROOT = {
			set_global_flag = treasure_fleet_invasion_ongoing
		}
	}
	
	is_valid = {
		ROOT = {
			top_liege = {
				has_landed_title = e_china
			}
		}
		FROM = {
			independent = yes
		}
	}
	
	on_success = {
		ROOT = {
			clr_global_flag = treasure_fleet_invasion_ongoing
			prestige = 1000
			take_tf_wealth_effect = yes
			remove_trait = treasure_fleet_voyage
			clr_character_flag = do_not_disturb
		}
		FROM = {
			prestige = -1000
		}
	}
	
	on_success_title = {
		ROOT = {
			# 1: Get rid of old vassals
			# 2: Create e_treasure_fleet
			# 3: Flag all demesne titles except e_treasure_fleet
			# 4: Invasion usupration
			# 5: Give the EoC all flagged titles and remove the flags
			# 6: Chinese Imperial, if necessary
			any_vassal = {
				set_defacto_liege = e_china
			}
			activate_title = {
				title = e_treasure_fleet
				status = yes
			}
			grant_title = e_treasure_fleet
			hidden_tooltip = {
				any_demesne_title = {
					limit = {
						NOT = {
							title = e_treasure_fleet
						}
						is_titular = no
					}
					set_title_flag = give_to_china
				}
			}
			FROM = {
				any_realm_province = {
					limit = {
						has_province_flag = tf_invasion_target_beachhead
					}
					county = {
						usurp_title = {
							target = ROOT
							type = invasion
						}
					}
				}
			}
		}
		custom_tooltip = {
			text = other_invasion_succ_tip
			hidden_tooltip = {
				ROOT = {
					vassalize_or_take_under_title_destroy_duchies = {
						title = PREV
						enemy = FROM
						is_crusade = no # Even if the title holder is not participating in the war, gain holdings occupied by all Crusade participants
						type = invasion
					}
					if = { # TODO
						limit = {
							OR = {
								this_has_lame_nickname_trigger = yes
								has_nickname = no
							}
						}
						random_list = {
							10 = { give_nickname = nick_the_holy }
							10 = { give_nickname = nick_the_glorious }
							10 = { give_nickname = nick_the_lionheart }
							10 = { give_nickname = nick_the_great }
							10 = { give_nickname = nick_the_hammer }
							10 = { give_nickname = nick_the_magnificent }
						}
					}
				}
			}
		}
		ROOT = {
			custom_tooltip = {
				text = GIVE_TITLES_TO_CHINA
				any_demesne_title = {
					limit = {
						has_title_flag = give_to_china
					}
					clr_title_flag = give_to_china
					e_china = {
						holder_scope = {
							grant_title_no_opinion = PREVPREV
						}
					}
				}
			}
			if = {
				limit = {
					can_have_chinese_imperial_trigger = yes
				}
				custom_tooltip = {
					text = BECOME_CHINESE_IMPERIAL
					primary_title = {
						set_title_flag = pretender_chinese_empire
						add_law = {
							law = succ_primogeniture
							cooldown = no
							opinion_effect = no
						}
						if = {
							limit = {
								has_dlc = "Conclave"
							}
							add_law = {
								law = ze_administration_laws_2
								cooldown = no
								opinion_effect = no
							}
						}
						else = {
							add_law = {
								law = imperial_administration
								cooldown = no
								opinion_effect = no
							}
						}
						if = {
							limit = {
								has_dlc = "Charlemagne"
							}
							add_law = {
								law = vice_royalty_2
								cooldown = no
								opinion_effect = no
							}
						}
					}
					any_demesne_title = {
						limit = { 
							tier = EMPEROR
							NOT = { has_title_flag = pretender_chinese_empire }
						}
						destroy_landed_title = THIS
					}
					set_government_type = chinese_imperial_government
					if = { # If we have positive Grace, zero it out!
						limit = {
							check_variable = {
								which = grace
								value = 1
							}
						}
						set_variable = {
							which = grace
							value = 0
						}
					}
					detract_grace_super_huge_effect = yes # China is VERY upset with you for doing this!
					detract_grace_super_huge_effect = yes # China is VERY upset with you for doing this!
					hidden_tooltip = {
						e_china = {
							holder_scope = {
								mandate_penalty_large_effect = yes
							}
						}
					}
				
					# Claim China
					e_china = {
						add_weak_pressed_claim = PREV
					}
					if = {
						limit = {
							has_character_modifier = peace_deal_with_china
						}
						remove_character_modifier = peace_deal_with_china
					}
					if = {
						limit = {
							has_character_modifier = chinese_imperial_trade_contract
						}
						remove_character_modifier = chinese_imperial_trade_contract
					}
					narrative_event = { id = soh.5505 } # Name the empire
				}
			}
			hidden_tooltip = {
				2753 = { # Hangzhou
					clean_up_old_treasure_fleet_effect = yes
				}
			}
			
			# Bloodline added here; we want to ensure ROOT is an emperor when it is given
			if = {
				limit = {
					is_female = no
				}
				create_bloodline = {
					type = treasure_fleet_invader_bloodline 
				}
			}
			else = {
				create_bloodline = {
					type = treasure_fleet_invader_bloodline 
					inheritance = matrilineal
				}
			}
		}
		ROOT = {
			hidden_tooltip = {
				mandate_boost_massive_effect = yes
			}
		}
		FROM = {
			hidden_tooltip = {
				if = {
					limit = {
						government = chinese_imperial_government
					}
					mandate_penalty_massive_effect = yes
				}
			}
		}
	}
	
	on_reverse_demand = {
		ROOT = {
			hidden_tooltip = {
				mandate_penalty_massive_effect = yes
			}
		}
		FROM = {
			hidden_tooltip = {
				if = {
					limit = {
						government = chinese_imperial_government
					}
					mandate_boost_massive_effect = yes
				}
			}
		}
		ROOT = {
			clr_global_flag = treasure_fleet_invasion_ongoing
			prestige = -1000
			disband_event_forces = tf_invasion
			e_china = {
				holder_scope = {
					opinion = {
						who = ROOT
						modifier = opinion_traitor
					}
					ROOT = {
						set_defacto_liege = PREV
					}
					imprison = FROM # Better than having the target do it...
				}
			}
			any_demesne_title = {
				e_china = {
					holder_scope = {
						add_claim = PREVPREV
					}
				}
			}
			hidden_tooltip = {
				2753 = { # Hangzhou
					clean_up_old_treasure_fleet_effect = yes
				}
			}
			remove_trait = treasure_fleet_voyage
			clr_character_flag = do_not_disturb
		}
		FROM = {
			prestige = 1000
			if = {
				limit = {
					has_dlc = "Jade Dragon"
					e_china = {
						holder_scope = {
							is_chinese_emperor_trigger = yes
						}
					}
					NOT = {
						government = chinese_imperial_government # Pretender emperors
					}
				}
				add_grace_super_huge_effect = yes
				add_grace_super_huge_effect = yes
			}
			hidden_tooltip = {
				any_independent_ruler = {
					any_realm_province = {
						limit = {
							has_province_flag = tf_invasion_target_beachhead
						}
						clr_province_flag = tf_invasion_target_beachhead
					}
				}
			}
		}
	}
	
	on_invalidation = {
		2753 = { # Hangzhou
			clr_global_flag = treasure_fleet_invasion_ongoing
			clean_up_old_treasure_fleet_effect = yes
		}
		ROOT = {
			remove_trait = treasure_fleet_voyage
			clr_character_flag = do_not_disturb
			hidden_tooltip = {
				any_independent_ruler = {
					any_realm_province = {
						limit = {
							has_province_flag = tf_invasion_target_beachhead
						}
						clr_province_flag = tf_invasion_target_beachhead
					}
				}
			}
		}
	}
	
	on_attacker_leader_death = {
		end_war = invalid
	}

	attacker_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	attacker_ai_defeat_worth = {
		factor = 100
	}

	defender_ai_victory_worth = {
		factor = -1 # always accept
	}
	
	defender_ai_defeat_worth = {
		factor = 100
	}
}