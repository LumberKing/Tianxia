# Alchemist society mission events
# by Silverswee(e)per
# Incorporates some stuff based off of the vanilla/CleanSlate Hermetics script

namespace = soh

# soh.11401-11500 reserved

##### Mission events

### Mission selection

# Event offset
character_event = {
	id = soh.11401
	hide_window = yes
	
	is_triggered_only = yes # on_society_bi_yearly_pulse

	immediate = {
		character_event = {
			id = soh.11402
			days = 7
			random = 7
		}
	}
}

# General mission selection event - quite similar to vanilla Hermetics
character_event = {
	id = soh.11402
	hide_window = yes
	
	is_triggered_only = yes

	#only_capable = yes
	prisoner = no

	trigger = {
		society_member_of = the_alchemists
		has_any_quest = no
		is_inaccessible_trigger = no
		is_actually_incapable_trigger = no
		NOT = { has_character_modifier = quest_cooldown_timer }
		NOR = {
			trait = treasure_fleet_preparation
			trait = in_mourning
		}

		society = {
			any_society_member = {
				NOT = { character = ROOT }
				prisoner = no
				is_within_diplo_range = ROOT
				opinion = { who = ROOT value >= 0 }
			}
		}
	}

	immediate = {
		# Picks out mission giver
		random_list = {
			50 = { # International society member
				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}

			50 = { # Realm society member
				trigger = {
					society = {
						any_society_member = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
					}
				}

				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}
		}
		
		# Select a random mission
		random_list = {
			20 = {
				trigger = {
					is_landed = yes
					NOT = {
						any_artifact = {
							count >= 10
							has_artifact_flag = ingredient
						}
					}
				}
				
				society_quest_event = { id = soh.11403 } # Acquire ingredients
			}
			
			20 = {
				trigger = {
					is_landed = yes
					any_artifact = {
						count >= 2
						has_artifact_flag = ingredient
					}
				}
				
				mult_modifier = {
					factor = 5
					event_target:alchemist_quest_giver = {
						trait = lunatic
					}
				}
				
				society_quest_event = { id = soh.11404 } # Conduct Self-Experiment
			}
			
			20 = {
				trigger = {
					is_landed = yes
					any_artifact = {
						count >= 2
						has_artifact_flag = ingredient
					}
				}
				
				society_quest_event = { id = soh.11405 } # Sell Potions
			}
			
			20 = {
				trigger = {
					society_rank >= 2
					trigger_if = {
						limit = { ai = yes }

						is_landed = yes
						society_rank == 4
					}

					NOR = {
						has_character_flag = building_laboratory
						has_character_flag = built_laboratory
					}
				}
				
				society_quest_event = { id = soh.11406 } # Construct Alchemical Laboratory
			}

			10 = { # Infiltrate lab
				trigger = {
					society = {
						any_society_member = {
							is_within_diplo_range = ROOT
							reverse_opinion = { who = event_target:alchemist_quest_giver value < 20 }
							reverse_opinion = { who = ROOT value < 20 }

							NOR = {
								character = ROOT
								character = event_target:alchemist_quest_giver
								has_character_flag = infiltration_rival
								has_character_flag = infiltration_mutual_dislike
								has_character_flag = infiltration_rich
							}
						}
					}
				}
				
				society_quest_event = { id = soh.11407 } # Infiltrate Laboratory
			}
			
			20 = {
				trigger = {
					is_landed = yes
					society_rank >= 2
					has_character_flag = built_laboratory
					any_artifact = {
						count >= 2
						has_artifact_flag = ingredient
					}
				}
				
				mult_modifier = {
					factor = 0.1
					event_target:alchemist_quest_giver = {
						trait = lunatic
					}
				}
				
				society_quest_event = { id = soh.11408 } # Conduct Laboratory Experiment
			}
			
			20 = {
				trigger = {
					is_landed = yes
					society_rank >= 2
					any_artifact = {
						count >= 2
						has_artifact_flag = ingredient
					}
					
					any_courtier = {
						prisoner = yes
						is_adult = yes
						NOR = {
							is_friend = event_target:alchemist_quest_giver
							is_lover = event_target:alchemist_quest_giver
							AND = {
								is_close_relative = event_target:alchemist_quest_giver
								NOT = {
									is_rival = event_target:alchemist_quest_giver
								}
							}
						}
					}
				}
				
				mult_modifier = {
					factor = 2
					any_courtier = {
						prisoner = yes
						is_rival = ROOT
					}
				}
				
				mult_modifier = {
					factor = 5
					any_courtier = {
						prisoner = yes
						is_rival = event_target:alchemist_quest_giver
					}
				}
				
				mult_modifier = {
					factor = 2
					event_target:alchemist_quest_giver = {
						trait = lunatic
					}
				}
				
				society_quest_event = { id = soh.11409 } # Conduct Potion Test
			}
			
			20 = {
				trigger = {
					is_landed = yes
					society_rank == 5
					has_character_flag = built_laboratory
					any_artifact = {
						count >= 5
						has_artifact_flag = ingredient
					}
					NOT = {
						has_character_modifier = brewing_immortality_potion
					}
					check_variable = {
						which = alchemist_healing_knowledge
						value >= 25
					}
				}
				
				mult_modifier = {
					factor = 2
					has_ambition = obj_become_immortal
				}
				
				mult_modifier = {
					factor = 0.1
					check_variable = {
						which = alchemist_healing_knowledge
						value < 50
					}
				}
				
				society_quest_event = { id = soh.11410 } # Brew Immortality Potion
			}
		}
	}
}

# Mission: Gather Alchemical Ingredients
society_quest_event = {
	id = soh.11403
	desc = EVTDESC_SOH_11403

	is_triggered_only = yes

	option = {
		name = ACCEPT

		set_quest = quest_alchemist_gather_ingredients
	}

	option = {
		name = DECLINE

		custom_tooltip = { text = decline_quest_tooltip }

		add_character_modifier = {
			name = quest_cooldown_timer
			days = 1000
			hidden = yes
		}

		ai_chance = { factor = 0 }
	}
}

# Mission: Conduct Self-Experiment
society_quest_event = {
	id = soh.11404
	desc = EVTDESC_SOH_11404

	is_triggered_only = yes

	option = {
		name = ACCEPT

		set_quest = quest_alchemist_self_experiment
	}

	option = {
		name = DECLINE

		custom_tooltip = { text = decline_quest_tooltip }

		add_character_modifier = {
			name = quest_cooldown_timer
			days = 1000
			hidden = yes
		}

		ai_chance = { factor = 0 }
	}
}

# Mission: Sell Potions
society_quest_event = {
	id = soh.11405
	desc = EVTDESC_SOH_11405

	is_triggered_only = yes

	option = {
		name = ACCEPT

		set_quest = quest_alchemist_sell_potions
	}

	option = {
		name = DECLINE

		custom_tooltip = { text = decline_quest_tooltip }

		add_character_modifier = {
			name = quest_cooldown_timer
			days = 1000
			hidden = yes
		}

		ai_chance = { factor = 0 }
	}
}

# Mission: Construct Alchemical Laboratory
society_quest_event = {
	id = soh.11406
	desc = EVTDESC_SOH_11406

	is_triggered_only = yes

	option = {
		name = ACCEPT

		set_quest = quest_alchemist_build_laboratory
	}

	option = {
		name = DECLINE

		custom_tooltip = { text = decline_quest_tooltip }

		add_character_modifier = {
			name = quest_cooldown_timer
			days = 1000
			hidden = yes
		}

		ai_chance = { factor = 0 }
	}
}

# Mission: Infiltrate Laboratory
society_quest_event = {
	id = soh.11407
	portrait = event_target:alchemist_quest_giver
	quest_target = event_target:infiltration_target

	desc = {
		text = EVTDESCA_SOH_11407
		trigger = { event_target:infiltration_target = { has_character_flag = infiltration_rival } }
	}
	desc = {
		text = EVTDESCB_SOH_11407
		trigger = { event_target:infiltration_target = { has_character_flag = infiltration_mutual_dislike } }
	}
	desc = {
		text = EVTDESCC_SOH_11407
		trigger = { event_target:infiltration_target = { has_character_flag = infiltration_rich } }
	}

	is_triggered_only = yes

	immediate = {
		society = {
			random_list = {
				30 = { # Their nemesis
					trigger = {
						any_society_member = {
							is_within_diplo_range = ROOT
							is_rival = event_target:alchemist_quest_giver
							reverse_opinion = { who = ROOT value < 20 }

							NOR = {
								character = ROOT
								character = event_target:alchemist_quest_giver
								has_character_flag = infiltration_rival
								has_character_flag = infiltration_mutual_dislike
								has_character_flag = infiltration_rich
							}
						}
					}

					random_society_member = {
						limit = {
							is_within_diplo_range = ROOT
							is_rival = event_target:alchemist_quest_giver
							reverse_opinion = { who = ROOT value < 20 }

							NOR = {
								character = ROOT
								character = event_target:alchemist_quest_giver
								has_character_flag = infiltration_rival
								has_character_flag = infiltration_mutual_dislike
								has_character_flag = infiltration_rich
							}
						}

						save_event_target_as = infiltration_target
						set_character_flag = infiltration_rival
					}
				}

				10 = { # Shared dislike
					trigger = {
						any_society_member = {
							is_within_diplo_range = ROOT
							reverse_opinion = { who = ROOT value < 0 }
							reverse_opinion = { who = event_target:alchemist_quest_giver value < 0 }

							NOR = {
								character = ROOT
								character = event_target:alchemist_quest_giver
								has_character_flag = infiltration_rival
								has_character_flag = infiltration_mutual_dislike
								has_character_flag = infiltration_rich
							}
						}
					}

					random_society_member = {
						limit = {
							is_within_diplo_range = ROOT
							reverse_opinion = { who = ROOT value < 0 }
							reverse_opinion = { who = event_target:alchemist_quest_giver value < 0 }

							NOR = {
								character = ROOT
								character = event_target:alchemist_quest_giver
								has_character_flag = infiltration_rival
								has_character_flag = infiltration_mutual_dislike
								has_character_flag = infiltration_rich
							}
						}

						save_event_target_as = infiltration_target
						set_character_flag = infiltration_mutual_dislike
					}
				}

				10 = { # Rich target
					trigger = {
						any_society_member = {
							is_within_diplo_range = ROOT
							reverse_opinion = { who = ROOT value < 20 }
							reverse_opinion = { who = event_target:alchemist_quest_giver value < 20 }

							NOR = {
								character = ROOT
								character = event_target:alchemist_quest_giver
								has_character_flag = infiltration_rival
								has_character_flag = infiltration_mutual_dislike
								has_character_flag = infiltration_rich
							}

							OR = {
								any_artifact = {
									has_artifact_flag = alchemy
									has_artifact_flag = taoist
								}

								wealth >= 200
								has_character_modifier = best_laboratory
								has_character_modifier = great_laboratory
							}
						}
					}

					mult_modifier = {
						factor = 2
						ROOT = {
							OR = {
								trait = greedy
								trait = ambitious
							}
						}
					}

					random_society_member = {
						limit = {
							is_within_diplo_range = ROOT
							reverse_opinion = { who = ROOT value < 20 }
							reverse_opinion = { who = event_target:alchemist_quest_giver value < 20 }

							NOR = {
								character = ROOT
								character = event_target:alchemist_quest_giver
								has_character_flag = infiltration_rival
								has_character_flag = infiltration_mutual_dislike
								has_character_flag = infiltration_rich
							}

							OR = {
								any_artifact = {
									has_artifact_flag = alchemy
								}

								wealth >= 200
								has_character_modifier = best_laboratory
								has_character_modifier = great_laboratory
							}
						}

						save_event_target_as = infiltration_target
						set_character_flag = infiltration_rich
					}
				}

				1 = { # Fallback
					random_society_member = {
						limit = {
							is_within_diplo_range = ROOT
							reverse_opinion = { who = ROOT value < 20 }
							reverse_opinion = { who = event_target:alchemist_quest_giver value < 20 }

							NOR = {
								character = ROOT
								character = event_target:alchemist_quest_giver
								has_character_flag = infiltration_rival
								has_character_flag = infiltration_mutual_dislike
								has_character_flag = infiltration_rich
							}
						}

						save_event_target_as = infiltration_target
						set_character_flag = infiltration_rich
					}
				}
			}
		}
	}

	option = {
		name = ACCEPT

		event_target:infiltration_target = {
			show_scope_change = no

			set_quest_target = {
				id = quest_alchemist_infiltrate_laboratory
				holder = ROOT
			}

			character_event = { id = soh.11443 months = 5 } # Flag cleanup
		}

		hidden_effect = {
			event_target:alchemist_quest_giver = {
				save_event_target_as = infiltration_companion

				opinion = {
					name = opinion_infiltration_companion
					who = ROOT
					months = 100
				}
			}
		}

		# Search for lab or skip to security
		if = {
			limit = {
				event_target:infiltration_target = {
					OR = {
						has_character_flag = hidden_lab
						has_character_flag = very_hidden_lab
					}
				}
			}

			letter_event = { id = soh.11421 days = 14 }
		}
		else = {
			character_event = { id = soh.11422 days = 14 }
		}
	}

	option = {
		name = DECLINE

		custom_tooltip = { text = decline_quest_tooltip }

		add_character_modifier = {
			name = quest_cooldown_timer
			days = 1000
			hidden = yes
		}

		event_target:infiltration_target = {
			character_event = { id = soh.11443 } # Flag cleanup
		}

		ai_chance = { factor = 0 }
	}
}

# Mission: Conduct Laboratory Experiment
society_quest_event = {
	id = soh.11408
	desc = EVTDESC_SOH_11408

	is_triggered_only = yes

	option = {
		name = ACCEPT

		set_quest = quest_alchemist_laboratory_experiment
	}

	option = {
		name = DECLINE

		custom_tooltip = { text = decline_quest_tooltip }

		add_character_modifier = {
			name = quest_cooldown_timer
			days = 1000
			hidden = yes
		}

		ai_chance = { factor = 0 }
	}
}

# Mission: Conduct Potion Test
society_quest_event = {
	id = soh.11409
	desc = EVTDESC_SOH_11409

	is_triggered_only = yes

	option = {
		name = ACCEPT

		set_quest = quest_alchemist_prisoner_experiment
	}

	option = {
		name = DECLINE

		custom_tooltip = { text = decline_quest_tooltip }

		add_character_modifier = {
			name = quest_cooldown_timer
			days = 1000
			hidden = yes
		}

		ai_chance = { factor = 0 }
	}
}

# Mission: Brew Immortality Potion
society_quest_event = {
	id = soh.11410
	desc = EVTDESC_SOH_11410

	is_triggered_only = yes

	option = {
		name = ACCEPT

		set_quest = quest_alchemist_immortality_potion
	}

	option = {
		name = DECLINE

		custom_tooltip = { text = decline_quest_tooltip }

		add_character_modifier = {
			name = quest_cooldown_timer
			days = 1000
			hidden = yes
		}

		ai_chance = { factor = 0 }
	}
}



##### Mission completion/failure events

# Gather Alchemical Ingredients has no completion events

### Conduct Self-Experiment

# Mission success
letter_event = {
	id = soh.11411
	desc = EVTDESC_SOH_11411
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes

	immediate = {
		# Picks out mission giver
		random_list = {
			50 = { # International society member
				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}

			50 = { # Realm society member
				trigger = {
					society = {
						any_society_member = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
					}
				}

				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_11411 # Great!
		
		clr_quest = quest_alchemist_self_experiment
		
		add_society_currency_minor_effect = yes
	}
}

# Mission failure
letter_event = {
	id = soh.11412
	desc = EVTDESC_SOH_11412
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes

	immediate = {
		# Picks out mission giver
		random_list = {
			50 = { # International society member
				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}

			50 = { # Realm society member
				trigger = {
					society = {
						any_society_member = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
					}
				}

				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_11412 # I have failed!
		
		clr_quest = {
			id = quest_alchemist_self_experiment
			failure = yes
		}
	}
}

### Sell Potions

# Mission success
letter_event = {
	id = soh.11413
	desc = EVTDESC_SOH_11413
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes

	immediate = {
		# Picks out mission giver
		random_list = {
			50 = { # International society member
				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}

			50 = { # Realm society member
				trigger = {
					society = {
						any_society_member = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
					}
				}

				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_11413 # Great!
		
		clr_quest = quest_alchemist_sell_potions
		
		add_society_currency_minor_effect = yes
	}
}

# Mission failure
letter_event = {
	id = soh.11414
	desc = EVTDESC_SOH_11414
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes

	immediate = {
		# Picks out mission giver
		random_list = {
			50 = { # International society member
				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}

			50 = { # Realm society member
				trigger = {
					society = {
						any_society_member = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
					}
				}

				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_11414 # I have failed!
		
		clr_quest = {
			id = quest_alchemist_sell_potions
			failure = yes
		}
	}
}

### Construct Alchemical Laboratory

# Mission success
character_event = {
	id = soh.11415
	picture = GFX_evt_experiment
	border = GFX_event_normal_frame_religion

	is_triggered_only = yes

	desc = {
		text = EVTDESC_SOH_11415_normal
		trigger = {
			NOR = {
				has_character_modifier = good_laboratory
				has_character_modifier = great_laboratory
				has_character_modifier = best_laboratory
			}
		}
	}

	desc = {
		text = EVTDESC_SOH_11415_rich
		trigger = {
			OR = {
				has_character_modifier = good_laboratory
				has_character_modifier = great_laboratory
				has_character_modifier = best_laboratory
			}
		}
	}

	trigger = { has_quest = quest_hermetics_build_laboratory }

	option = {
		name = EVTOPTA_SOH_11415 # This will be useful!

		clr_quest = quest_hermetics_find_apprentice
		sound_effect = hermetic_society_perform_experiment

		if = {
			limit = { has_character_modifier = best_laboratory }
			add_society_currency_major_effect = yes
		}
		else_if = {
			limit = {
				OR = {
					has_character_modifier = good_laboratory
					has_character_modifier = great_laboratory
				}
			}

			add_society_currency_medium_effect = yes
		}
		else = {
			add_society_currency_minor_effect = yes
		}
	}
}

# Infiltrate Laboratory succeeds or fails in the event chain

### Conduct Laboratory Experiment

# Mission success
letter_event = {
	id = soh.11416
	desc = EVTDESC_SOH_11416
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes

	immediate = {
		# Picks out mission giver
		random_list = {
			50 = { # International society member
				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}

			50 = { # Realm society member
				trigger = {
					society = {
						any_society_member = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
					}
				}

				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_11416 # Great!
		
		clr_quest = quest_alchemist_laboratory_experiment
		
		add_society_currency_minor_effect = yes
	}
}

# Mission failure
letter_event = {
	id = soh.11417
	desc = EVTDESC_SOH_11417
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes

	immediate = {
		# Picks out mission giver
		random_list = {
			50 = { # International society member
				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}

			50 = { # Realm society member
				trigger = {
					society = {
						any_society_member = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
					}
				}

				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_11417 # I have failed!
		
		clr_quest = {
			id = quest_alchemist_laboratory_experiment
			failure = yes
		}
	}
}

### Conduct Potion Test

# Mission success
letter_event = {
	id = soh.11418
	desc = EVTDESC_SOH_11418
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes

	immediate = {
		# Picks out mission giver
		random_list = {
			50 = { # International society member
				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							NOT = {
								character = event_target:prisoner_experimented_upon
							}
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}

			50 = { # Realm society member
				trigger = {
					society = {
						any_society_member = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
							NOT = {
								character = event_target:prisoner_experimented_upon
							}
						}
					}
				}

				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
							NOT = {
								character = event_target:prisoner_experimented_upon
							}
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_11418 # Great!
		
		clr_quest = quest_alchemist_prisoner_experiment
		
		add_society_currency_minor_effect = yes
	}
}

# Mission failure
letter_event = {
	id = soh.11419
	desc = EVTDESC_SOH_11419
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes

	immediate = {
		# Picks out mission giver
		random_list = {
			50 = { # International society member
				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							NOT = {
								character = event_target:prisoner_experimented_upon
							}
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}

			50 = { # Realm society member
				trigger = {
					society = {
						any_society_member = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
							NOT = {
								character = event_target:prisoner_experimented_upon
							}
						}
					}
				}

				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
							NOT = {
								character = event_target:prisoner_experimented_upon
							}
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_11419 # I have failed!
		
		clr_quest = quest_alchemist_prisoner_experiment
		
		clr_quest = {
			id = quest_alchemist_laboratory_experiment
			failure = yes
		}
	}
}

### Brew Immortality Potion

# Mission success
letter_event = {
	id = soh.11420
	desc = EVTDESC_SOH_11420
	border = GFX_event_letter_frame_religion
	
	is_triggered_only = yes # TIANXIATODO

	immediate = {
		# Picks out mission giver
		random_list = {
			50 = { # International society member
				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							NOT = {
								character = event_target:immortality_potion_receiver
							}
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}

			50 = { # Realm society member
				trigger = {
					society = {
						any_society_member = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
							NOT = {
								character = event_target:immortality_potion_receiver
							}
						}
					}
				}

				society = {
					random_society_member = {
						limit = {
							NOT = { character = ROOT }
							prisoner = no
							is_inaccessible_trigger = no
							is_actually_incapable_trigger = no
							is_within_diplo_range = ROOT
							opinion = { who = ROOT value >= 0 }
							same_realm = ROOT
							NOT = {
								character = event_target:immortality_potion_receiver
							}
						}
						
						preferred_limit = {
							is_society_grandmaster = yes
						}
						
						preferred_limit = {
							society_rank == 4
						}
						
						preferred_limit = {
							society_rank == 3
						}
						
						preferred_limit = {
							society_rank == 2
						}
						
						preferred_limit = {
							society_rank == 1
						}

						save_event_target_as = alchemist_quest_giver
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_11420 # Great!
		
		clr_quest = quest_alchemist_immortality_potion
		
		add_society_currency_major_effect = yes
	}
}



##### Infiltrate Laboratory event chain - very closely based on the Hermetics version

# Find information about the laboratory's hidden entrance
letter_event = {
	id = soh.11421
	desc = EVTDESC_SOH_11421
	border = GFX_event_letter_frame_intrigue
	portrait = event_target:infiltration_companion

	is_triggered_only = yes

	option = {
		name = EVTOPTA_SOH_11421

		custom_tooltip = { text = EVTOPTA_SOH_11421_TT }

		hidden_effect = {
			random_list = {
				33 = { # It goes quickly
					mult_modifier = { event_target:infiltration_companion = { intrigue >= 12 } factor = 1.2 }
					mult_modifier = { event_target:infiltration_companion = { intrigue >= 14 } factor = 1.2 }
					mult_modifier = { event_target:infiltration_companion = { intrigue >= 16 } factor = 1.2 }
					mult_modifier = { event_target:infiltration_companion = { intrigue >= 18 } factor = 1.2 }

					character_event = {
						id = soh.11422
						days = 15
						random = 10
					}
				}

				33 = { # It goes slowly
					mult_modifier = { event_target:infiltration_companion = { intrigue >= 12 } factor = 1.1 }
					mult_modifier = { event_target:infiltration_companion = { intrigue >= 14 } factor = 1.1 }
					mult_modifier = { event_target:infiltration_companion = { intrigue >= 16 } factor = 1.1 }
					mult_modifier = { event_target:infiltration_companion = { intrigue >= 18 } factor = 1.1 }

					mult_modifier = {
						factor = 1.5
						event_target:infiltration_target = { has_character_flag = hidden_lab }
					}

					character_event = {
						id = soh.11422
						days = 45
						random = 30
					}
				}

				33 = { # It goes super slow
					mult_modifier = {
						factor = 2
						event_target:infiltration_target = { has_character_flag = very_hidden_lab }
					}

					character_event = {
						id = soh.11422
						days = 90
						random = 45
					}
				}
			}
		}
	}
}

# Get past the guards
character_event = {
	id = soh.11422
	picture = GFX_evt_eavesdropping
	border = GFX_event_normal_frame_intrigue
	portrait = event_target:infiltration_companion

	desc = {
		text = EVTDESCA_SOH_11422
		trigger = { event_target:infiltration_target = { has_character_flag = very_hidden_lab } }
	}
	desc = {
		text = EVTDESCB_SOH_11422
		trigger = { event_target:infiltration_target = { has_character_flag = hidden_lab } }
	}
	desc = {
		text = EVTDESCC_SOH_11422
		trigger = {
			event_target:infiltration_target = {
				NOR = {
					has_character_flag = very_hidden_lab
					has_character_flag = hidden_lab
				}
			}
		}
	}

	is_triggered_only = yes

	trigger = { has_quest = quest_alchemist_infiltrate_laboratory }

	immediate = {
		# Will select two ingredients, by prioritizing from the top, until it hits two available ones...
		select_random_hermetic_ingredient_herb_effect = yes
		select_random_hermetic_ingredient_animal_part_effect = yes
		select_random_hermetic_ingredient_powder_effect = yes
		select_random_hermetic_ingredient_liquid_effect = yes
		select_random_hermetic_ingredient_herb_effect = yes
		select_random_hermetic_ingredient_powder_effect = yes
		select_random_hermetic_ingredient_animal_part_effect = yes
		select_random_hermetic_ingredient_liquid_effect = yes
	}

	option = {
		name = EVTOPTA_SOH_11422 # Bribe
		tooltip_info = diplomacy

		trigger = { diplomacy >= 12 }

		custom_tooltip = { text = EVTOPTA_MNM_1435_TT }

		if = {
			limit = { event_target:infiltration_target = { has_character_flag = very_hidden_lab } }
			scaled_wealth = { value = -0.75 min = -75 }
		}
		else_if = {
			limit = { event_target:infiltration_target = { has_character_flag = hidden_lab } }
			scaled_wealth = { value = -0.5 min = -50 }
		}
		else = {
			scaled_wealth = { value = -0.3 min = -30 }
		}

		set_character_flag = bribed_guards
		
		character_event = { id = soh.11423 days = 7 }

		ai_chance = {
			factor = 1

			trigger = { scaled_wealth = 0.5 }
		}
	}

	option = {
		name = EVTOPTB_SOH_11422 # Make a sleeping potion (potentially great effect)
		tooltip_info_custom = multiple_ingredient_option_available_tt

		trigger = {
			any_artifact = {
				count >= 2
				has_artifact_flag = ingredient
			}
		}

		custom_tooltip = { text = EVTOPTB_MNM_1435_TT }

		random_list = {
			60 = {
				mult_modifier = { learning >= 10 factor = 1.2 }
				mult_modifier = { learning >= 12 factor = 1.2 }
				mult_modifier = { learning >= 14 factor = 1.2 }
				mult_modifier = { learning >= 16 factor = 1.2 }
				mult_modifier = { learning >= 18 factor = 1.2 }

				mult_modifier = {
					factor = 1.1
					has_selected_herb_ingredient_1_trigger = yes
				}
				mult_modifier = {
					factor = 1.1
					has_selected_herb_ingredient_2_trigger = yes
				}
				mult_modifier = {
					factor = 1.1
					has_selected_animal_part_ingredient_1_trigger = yes
				}
				mult_modifier = {
					factor = 1.1
					has_selected_animal_part_ingredient_2_trigger = yes
				}
				mult_modifier = {
					factor = 1.5
					selected_ingredient_is_sleep_inducing_trigger = yes
				}

				custom_tooltip = { text = EVTOPTX_MNM_1435_SUCCESS_TT }
				character_event = { id = soh.11423 days = 7 }
			}

			40 = {
				mult_modifier = {
					factor = 1.2
					event_target:infiltration_target = { has_character_flag = hidden_lab }
				}
				mult_modifier = {
					factor = 1.5
					event_target:infiltration_target = { has_character_flag = very_hidden_lab }
				}

				custom_tooltip = {
					text = EVTOPTX_MNM_1435_FAIL_TT

					random_list = {
						50 = {
							set_character_flag = guards_wake_up
							character_event = { id = soh.11423 days = 7 } # You get detected later, but continue for now
						}

						50 = {
							character_event = { id = soh.11424 days = 7 } # Hard fail
						}
					}
				}
			}
		}

		destroy_selected_ingredient_1_and_2_effect = yes
	}
	
	option = {
		name = EVTOPTB_SOH_11422 # Make a sleeping potion (mild effect)
		tooltip_info_custom = ingredient_option_available_tt

		trigger = {
			any_artifact = { has_artifact_flag = ingredient }
		}

		custom_tooltip = { text = EVTOPTB_MNM_1435_TT }

		random_list = {
			50 = {
				mult_modifier = { learning >= 10 factor = 1.2 }
				mult_modifier = { learning >= 12 factor = 1.2 }
				mult_modifier = { learning >= 14 factor = 1.2 }
				mult_modifier = { learning >= 16 factor = 1.2 }
				mult_modifier = { learning >= 18 factor = 1.2 }

				mult_modifier = {
					factor = 1.2
					selected_ingredient_is_sleep_inducing_trigger = yes
				}

				custom_tooltip = { text = EVTOPTX_MNM_1435_SUCCESS_TT }
				character_event = { id = soh.11423 days = 7 }
			}

			50 = {
				mult_modifier = {
					factor = 1.2
					event_target:infiltration_target = { has_character_flag = hidden_lab }
				}
				mult_modifier = {
					factor = 1.5
					event_target:infiltration_target = { has_character_flag = very_hidden_lab }
				}

				custom_tooltip = {
					text = EVTOPTX_MNM_1435_FAIL_TT

					random_list = {
						50 = {
							set_character_flag = guards_wake_up
							character_event = { id = soh.11423 days = 7 } # You get deteced later, but continue for now
						}

						50 = {
							character_event = { id = soh.11424 days = 7 } # Hard fail
						}
					}
				}
			}
		}

		destroy_selected_ingredient_1_effect = yes
	}

	# Distraction
	option = {
		name = EVTOPTC_SOH_11422

		custom_tooltip = { text = EVTOPTC_MNM_1435_TT }

		random_list = {
			60 = {
				mult_modifier = { event_target:infiltration_companion = { intrigue >= 10 } factor = 1.2 }
				mult_modifier = { event_target:infiltration_companion = { intrigue >= 12 } factor = 1.2 }
				mult_modifier = { event_target:infiltration_companion = { intrigue >= 14 } factor = 1.2 }
				mult_modifier = { event_target:infiltration_companion = { intrigue >= 16 } factor = 1.2 }
				mult_modifier = { event_target:infiltration_companion = { intrigue >= 18 } factor = 1.2 }

				custom_tooltip = { text = EVTOPTX_MNM_1435_SUCCESS_TT }
				character_event = { id = soh.11425 days = 7 }
			}

			40 = {
				mult_modifier = {
					factor = 1.2
					event_target:infiltration_target = { has_character_flag = hidden_lab }
				}
				mult_modifier = {
					factor = 1.5
					event_target:infiltration_target = { has_character_flag = very_hidden_lab }
				}

				custom_tooltip = {
					text = EVTOPTX_MNM_1435_FAIL_TT

					random_list = {
						50 = {
							character_event = { id = soh.11425 days = 7 } # You get detected later, but continue for now
							set_character_flag = distraction_failed
						}

						50 = {
							character_event = { id = soh.11426 days = 7 } # Hard fail
						}
					}
				}
			}
		}
	}

	# Bad idea
	option = {
		name = EVTOPTD_SOH_11422

		custom_tooltip = { text = EVTOPTD_MNM_1435_TT }

		clr_quest = {
			id = quest_hermetics_infiltrate_laboratory
			failure = yes
		}

		reverse_opinion = {
			name = opinion_very_disappointed
			who = event_target:infiltration_companion
			years = 10
		}

		hidden_effect = {
			reverse_remove_opinion = {
				name = opinion_infiltration_companion
				who = event_target:infiltration_companion
			}
		}
	}

	after = {
		remove_selection_of_ingredients_effect = yes
	}
}

# The sleeping potion worked/you bribed the guards
character_event = {
	id = soh.11423
	picture = GFX_evt_drunk
	border = GFX_event_normal_frame_intrigue

	desc = {
		text = EVTDESCA_SOH_11423
		picture = GFX_evt_shady_meeting
		trigger = { has_character_flag = bribed_guards }
	}
	desc = {
		text = EVTDESCB_SOH_11423
		picture = GFX_evt_drunk
		trigger = { NOT = { has_character_flag = bribed_guards } }
	}

	is_triggered_only = yes

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	# You destroy, I will steal
	option = {
		name = EVTOPTA_SOH_11423

		custom_tooltip = { text = EVTOPTA_MNM_1436_TT }

		if = {
			limit = { has_character_flag = guards_wake_up }

			set_character_flag = caught_stealing
			character_event = { id = soh.11427 days = 25 } # Guards catch you stealing
		}
		else = {
			character_event = { id = soh.11433 days = 25 } # You steal
			event_target:infiltration_companion = {
				character_event = { id = soh.11439 days = 14 }
			}
		}
	}

	# I destroy, you steal
	option = {
		name = EVTOPTB_SOH_11423

		custom_tooltip = { text = EVTOPTA_MNM_1436_TT }

		if = {
			limit = { has_character_flag = guards_wake_up }
			set_character_flag = caught_destroying
			character_event = { id = soh.11427 days = 25 } # Guards catch you destroying
		}
		else = {
			character_event = { id = soh.11435 days = 25 } # You destroy
			event_target:infiltration_companion = {
				character_event = { id = soh.11437 days = 14 }
			}
		}
	}

	# We steal
	option = {
		name = EVTOPTC_SOH_11423

		custom_tooltip = { text = EVTOPTC_MNM_1436_TT }

		if = {
			limit = { has_character_flag = guards_wake_up }
			set_character_flag = caught_stealing
			character_event = { id = soh.11427 days = 25 } # Guards catch you stealing
		}
		else = {
			character_event = { id = soh.11433 days = 25 } # You steal
		}
	}

	# We destroy
	option = {
		name = EVTOPTD_SOH_11423

		custom_tooltip = { text = EVTOPTC_MNM_1436_TT }

		if = {
			limit = { has_character_flag = guards_wake_up }
			set_character_flag = caught_destroying
			character_event = { id = soh.11427 days = 25 } # Guards catch you destroying
		}
		else = {
			character_event = { id = soh.11435 days = 25 } # You destroy
		}
	}

	after = {
		clr_character_flag = bribed_guards
	}
}

# You fail to make a sleeping potion
character_event = {
	id = soh.11424
	desc = EVTDESC_SOH_11424
	picture = GFX_evt_quarrel
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	option = {
		name = EVTOPTA_SOH_11424

		clr_quest = {
			id = quest_hermetics_infiltrate_laboratory
			failure = yes
		}

		reverse_opinion = {
			name = opinion_very_disappointed
			who = event_target:infiltration_companion
			years = 10
		}

		hidden_effect = {
			reverse_remove_opinion = {
				name = opinion_infiltration_companion
				who = event_target:infiltration_companion
			}
		}
	}
}

# The distraction is successful
character_event = {
	id = soh.11425
	desc = EVTDESC_SOH_11425
	picture = GFX_evt_shadowy_cabal
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	# Steal
	option = {
		name = EVTOPTA_SOH_11425

		if = {
			limit = { has_character_flag = distraction_failed }
			set_character_flag = caught_stealing
			character_event = { id = soh.11427 days = 25 } # Guards catch you stealing
		}
		else = {
			character_event = { id = soh.11433 days = 25 } # You steal
		}
	}

	# Destroy
	option = {
		name = EVTOPTB_SOH_11425

		if = {
			limit = { has_character_flag = distraction_failed }
			set_character_flag = caught_destroying
			character_event = { id = soh.11427 days = 25 } # Guards catch you destroying
		}
		else = {
			character_event = { id = soh.11435 days = 25 } # You destroy
		}
	}
}

# The diversion fails
character_event = {
	id = soh.11426
	desc = EVTDESC_SOH_11426
	picture = GFX_evt_quarrel
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	option = {
		name = EVTOPTA_SOH_11426

		clr_quest = {
			id = quest_hermetics_infiltrate_laboratory
			failure = yes
		}

		hidden_effect = {
			reverse_remove_opinion = {
				name = opinion_infiltration_companion
				who = event_target:infiltration_companion
			}
		}
	}
}

# You get caught
character_event = {
	id = soh.11427
	picture = GFX_evt_into_the_dungeon
	border = GFX_event_normal_frame_intrigue

	desc = {
		text = EVTDESCA_SOH_11427
		trigger = {
			has_character_flag = guards_wake_up
			has_character_flag = caught_destroying
		}
	}
	desc = {
		text = EVTDESCB_SOH_11427
		trigger = {
			OR = {
				AND = {
					has_character_flag = distraction_failed
					has_character_flag = caught_destroying
				}
				event_target:infiltration_companion = { has_character_flag = bad_theft }
			}
		}
	}
	desc = {
		text = EVTDESCC_SOH_11427
		trigger = {
			has_character_flag = guards_wake_up
			has_character_flag = caught_stealing
		}
	}
	desc = {
		text = EVTDESCD_SOH_11427
		trigger = {
			has_character_flag = distraction_failed
			has_character_flag = caught_stealing
		}
	}

	is_triggered_only = yes

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	option = {
		name = EVTOPTA_SOH_11427

		event_target:infiltration_target = {
			show_scope_change = no

			if = {
				limit = { is_landed = yes }

				reverse_imprison = ROOT
				
				if = {
					limit = {
						has_dlc = "Jade Dragon"
						e_china = {
							holder_scope = {
								is_chinese_emperor_trigger = yes
								OR = {
									character = ROOT
									AND = {
										is_close_relative = ROOT
										dynasty = ROOT
									}
								}
								NOT = {
									character = PREVPREV
								}
							}
						}
					}
					
					if = {
						limit = {
							ROOT = {
								is_chinese_emperor_trigger = yes
							}
						}
						detract_grace_major_effect = yes
					}
					else = {
						detract_grace_medium_effect = yes
					}
				}

				if = {
					limit = { event_target:infiltration_companion = { ai = yes } }
					reverse_imprison = event_target:infiltration_companion
					
					if = {
						limit = {
							has_dlc = "Jade Dragon"
							e_china = {
								holder_scope = {
									is_chinese_emperor_trigger = yes
									OR = {
										character = event_target:infiltration_companion
										AND = {
											is_close_relative = event_target:infiltration_companion
											dynasty = event_target:infiltration_companion
										}
									}
									NOT = {
										character = PREVPREV
									}
								}
							}
						}
						
						if = {
							limit = {
								event_target:infiltration_companion = {
									is_chinese_emperor_trigger = yes
								}
							}
							detract_grace_major_effect = yes
						}
						else = {
							detract_grace_medium_effect = yes
						}
					}
				}
			}

			else = {
				host = {
					show_scope_change = no

					reverse_imprison = ROOT
				
					if = {
						limit = {
							has_dlc = "Jade Dragon"
							e_china = {
								holder_scope = {
									is_chinese_emperor_trigger = yes
									OR = {
										character = ROOT
										AND = {
											is_close_relative = ROOT
											dynasty = ROOT
										}
									}
									NOT = {
										character = PREVPREV
									}
								}
							}
						}
						
						if = {
							limit = {
								ROOT = {
									is_chinese_emperor_trigger = yes
								}
							}
							detract_grace_major_effect = yes
						}
						else = {
							detract_grace_medium_effect = yes
						}
					}

					if = {
						limit = { event_target:infiltration_companion = { ai = yes } }
						reverse_imprison = event_target:infiltration_companion
						
						if = {
							limit = {
								has_dlc = "Jade Dragon"
								e_china = {
									holder_scope = {
										is_chinese_emperor_trigger = yes
										OR = {
											character = event_target:infiltration_companion
											AND = {
												is_close_relative = event_target:infiltration_companion
												dynasty = event_target:infiltration_companion
											}
										}
										NOT = {
											character = PREVPREV
										}
									}
								}
							}
							
							if = {
								limit = {
									event_target:infiltration_companion = {
										is_chinese_emperor_trigger = yes
									}
								}
								detract_grace_major_effect = yes
							}
							else = {
								detract_grace_medium_effect = yes
							}
						}
					}
				}
			}

			character_event = { id = soh.11428 days = 7 }
		}

		reverse_opinion = {
			name = opinion_thief
			who = event_target:infiltration_target
			years = 20
		}

		clr_quest = {
			id = quest_hermetics_infiltrate_laboratory
			failure = yes
		}

		clr_character_flag = distraction_failed
		clr_character_flag = guards_wake_up
		clr_character_flag = caught_stealing
		clr_character_flag = caught_destroying

		hidden_effect = {
			event_target:infiltration_companion = {
				clr_character_flag = bad_theft

				reverse_opinion = {
					name = opinion_thief
					who = event_target:infiltration_target
					years = 20
				}

				remove_opinion = {
					name = opinion_infiltration_companion
					who = ROOT
				}
			}

		}
	}
}

# The captor decides what to do with you
character_event = {
	id = soh.11428
	desc = EVTDESC_SOH_11428
	picture = GFX_evt_catching_heretic
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	# Trade secrets for freedom
	option = {
		name = EVTOPTA_SOH_11428

		trigger = {
			FROM = {
				has_society_currency_medium_trigger = yes
				prisoner = yes
			}
		}

		tooltip = {
			random_list = {
				60 = {
					mult_modifier = {
						factor = 1.5
						FROM = { trait = craven }
					}
					add_society_currency_major_effect = yes
				}
				40 = {
					mult_modifier = {
						factor = 2
						FROM = {
							OR = {
								trait = greedy
								trait = ambitious
								trait = wroth
								trait = paranoid
							}
						}
					}
					custom_tooltip = { text = EVTOPTA_SOH_11428_TT }
				}

			}
		}

		FROM = { character_event = { id = soh.11429 } }

		ai_chance = {
			factor = 60

			mult_modifier = {
				factor = 2
				OR = {
					trait = greedy
					trait = ambitious
					learning >= 14
				}
			}
		}
	}

	# Let them rot
	option = {
		name = EVTOPTB_SOH_11428

		if = {
			limit = { NOT = { is_rival = FROM } }
			tooltip = { add_rival = FROM }
		}

		if = {
			limit = { NOT = { is_rival = event_target:infiltration_companion } }
			add_rival = event_target:infiltration_companion
		}

		FROM = { character_event = { id = soh.11432 } }

		ai_chance = {
			factor = 40

			mult_modifier = {
				factor = 2
				is_rival = FROM
			}
		}
	}
}

# Give me secrets, I will let you out
character_event = {
	id = soh.11429
	desc = EVTDESC_SOH_11429
	picture = GFX_evt_catching_heretic
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	trigger = { prisoner = yes }

	# Alright...
	option = {
		name = EVTOPTA_SOH_11429

		detract_society_currency_medium_effect = yes
		
		hidden_tooltip = {
			if = {
				limit = {
					check_variable = {
						which = alchemist_healing_knowledge
						value >= 100
					}
				}
				
				FROM = {
					change_variable = {
						which = alchemist_healing_knowledge
						value = 10
					}
				}
			}
			
			else_if = {
				limit = {
					check_variable = {
						which = alchemist_healing_knowledge
						value >= 75
					}
				}
				
				FROM = {
					change_variable = {
						which = alchemist_healing_knowledge
						value = 8
					}
				}
			}
			
			else_if = {
				limit = {
					check_variable = {
						which = alchemist_healing_knowledge
						value >= 50
					}
				}
				
				FROM = {
					change_variable = {
						which = alchemist_healing_knowledge
						value = 6
					}
				}
			}
			
			else_if = {
				limit = {
					check_variable = {
						which = alchemist_healing_knowledge
						value >= 25
					}
				}
				
				FROM = {
					change_variable = {
						which = alchemist_healing_knowledge
						value = 4
					}
				}
			}
			
			else = {
				FROM = {
					change_variable = {
						which = alchemist_healing_knowledge
						value = 2
					}
				}
			}
			
			if = {
				limit = {
					check_variable = {
						which = alchemist_poison_knowledge
						value >= 100
					}
				}
				
				FROM = {
					change_variable = {
						which = alchemist_poison_knowledge
						value = 10
					}
				}
			}
			
			else_if = {
				limit = {
					check_variable = {
						which = alchemist_poison_knowledge
						value >= 75
					}
				}
				
				FROM = {
					change_variable = {
						which = alchemist_poison_knowledge
						value = 8
					}
				}
			}
			
			else_if = {
				limit = {
					check_variable = {
						which = alchemist_poison_knowledge
						value >= 50
					}
				}
				
				FROM = {
					change_variable = {
						which = alchemist_poison_knowledge
						value = 6
					}
				}
			}
			
			else_if = {
				limit = {
					check_variable = {
						which = alchemist_poison_knowledge
						value >= 25
					}
				}
				
				FROM = {
					change_variable = {
						which = alchemist_poison_knowledge
						value = 4
					}
				}
			}
			
			else = {
				FROM = {
					change_variable = {
						which = alchemist_poison_knowledge
						value = 2
					}
				}
			}
		}

		tooltip = { imprison = no }

		FROM = { character_event = { id = soh.11430 days = 3 } }

		ai_chance = {
			factor = 60

			mult_modifier = {
				factor = 1.5
				trait = craven
			}
		}
	}

	# Never!
	option = {
		name = EVTOPTB_SOH_11429

		custom_tooltip = { text = EVTOPTB_MNM_1452_TT }

		if = {
			limit = { NOT = { is_rival = FROM } }
			add_rival = FROM
		}

		FROM = { character_event = { id = soh.11431 days = 3 } }

		ai_chance = {
			factor = 40

			mult_modifier = {
				factor = 2
				OR = {
					trait = greedy
					trait = ambitious
					trait = wroth
					trait = paranoid
				}
			}
		}
	}
}

# Infiltration target get their secrets
character_event = {
	id = soh.11430
	desc = EVTDESC_SOH_11430
	picture = GFX_evt_dark_prayer
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	option = {
		name = EVTOPTA_SOH_11430

		add_society_currency_major_effect = yes

		FROM = { imprison = no }
	}
}

# Infiltration target is denied
character_event = {
	id = soh.11431
	desc = EVTDESC_SOH_11431
	picture = GFX_evt_into_the_dungeon
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	ai = no

	option = {
		name = EVTOPTA_SOH_11431

		if = {
			limit = {
				NOT = { is_rival = FROM }
			}

			tooltip = { add_rival = FROM }
		}
	}
}

# Infiltration target wants you to rot
character_event = {
	id = soh.11432
	desc = EVTDESC_SOH_11432
	picture = GFX_evt_catching_heretic
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	option = {
		name = EVTOPTA_SOH_11432

		if = {
			limit = { NOT = { is_rival = FROM } }
			add_rival = FROM
		}
	}
}

# You steal
character_event = {
	id = soh.11433
	picture = GFX_evt_library
	border = GFX_event_normal_frame_intrigue

	desc = {
		text = EVTDESCA_SOH_11433
		trigger = { has_character_flag = great_theft }
	}
	desc = {
		text = EVTDESCB_SOH_11433
		trigger = { has_character_flag = good_theft }
	}
	desc = {
		text = EVTDESCC_SOH_11433
		trigger = { has_character_flag = ok_theft }
	}

	is_triggered_only = yes
	# hide_from = yes

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	# CleanSlate: Why is thieving success based entirely off of learning rather than intrigue?
	immediate = {
		random_list = {
			33 = { # Great theft
				trigger = {
					event_target:infiltration_target = {
						any_artifact = {
							has_artifact_flag = alchemy
							has_artifact_flag = taoist
						}
					}
				}

				mult_modifier = { learning >= 12 factor = 1.2 }
				mult_modifier = { learning >= 13 factor = 1.2 }
				mult_modifier = { learning >= 16 factor = 1.2 }
				mult_modifier = { learning >= 18 factor = 1.2 }

				mult_modifier = {
					factor = 0.5
					event_target:infiltration_target = { ai = no }
				}

				set_character_flag = great_theft
			}

			33 = { # Good theft
				trigger = {
					event_target:infiltration_target = {
						any_artifact = {
							has_artifact_flag = alchemists
							has_artifact_flag = ingredient
						}
					}
				}

				mult_modifier = { learning >= 10 factor = 1.2 }
				mult_modifier = { learning >= 12 factor = 1.1 }
				mult_modifier = { learning >= 13 factor = 1.1 }
				mult_modifier = { learning >= 16 factor = 1.1 }
				mult_modifier = { learning >= 18 factor = 1.1 }

				set_character_flag = good_theft
			}

			33 = { # Ok theft
				mult_modifier = {
					factor = 1.2
					event_target:infiltration_target = { has_character_flag = hidden_lab }
				}
				mult_modifier = {
					factor = 1.5
					event_target:infiltration_target = { has_character_flag = very_hidden_lab }
				}

				set_character_flag = ok_theft
			}
		}
	}

	# Great theft
	option = {
		name = EVTOPTA_SOH_11433

		trigger = { has_character_flag = great_theft }

		custom_tooltip = { text = EVTOPTA_SOH_11433_steal_text }

		if = {
			limit = {
				event_target:infiltration_target = {
					any_artifact = {
						has_artifact_flag = alchemists
						has_artifact_flag = ingredient
					}
				}
			}

			custom_tooltip = { text = EVTOPTA_SOH_11433_steal_ingredient }
		}

		# Money and knowledge
		transfer_scaled_wealth = { from = event_target:infiltration_target value = 0.5 min = 50 }
		add_society_currency_massive_effect = yes
	}

	# Good theft
	option = {
		name = EVTOPTB_SOH_11433

		trigger = { has_character_flag = good_theft }

		# You get artifacts
		custom_tooltip = { text = EVTOPTA_SOH_11433_steal_ingredient }

		# Money and knowledge
		transfer_scaled_wealth = { from = event_target:infiltration_target value = 0.25 min = 25 }
		add_society_currency_major_effect = yes
	}

	option = {
		name = EVTOPTC_SOH_11433

		trigger = { has_character_flag = ok_theft }

		# Money and knowledge
		transfer_scaled_wealth = { from = event_target:infiltration_target value = 0.1 min = 10 }
		add_society_currency_medium_effect = yes
	}

	after = {
		hidden_effect = {
			event_target:infiltration_target = { character_event = { id = soh.11434 } }
			character_event = { id = soh.11442 days = 40 }
		}
	}
}

# Person who gets stolen from gets notified
character_event = {
	id = soh.11434
	picture = GFX_evt_burning_house
	border = GFX_event_normal_frame_intrigue

	desc = {
		text = EVTDESCA_SOH_11434
		trigger = { FROM = { has_character_flag = great_theft } }
	}
	desc = {
		text = EVTDESCB_SOH_11434
		trigger = { FROM = { has_character_flag = good_theft } }
	}
	desc = {
		text = EVTDESCC_SOH_11434
		trigger = { FROM = { has_character_flag = ok_theft } }
	}

	hide_from = yes
	is_triggered_only = yes


	option = {
		name = CURSES

		# Artifacts get stolen
		if = {
			limit = { FROM = { has_character_flag = great_theft } }

			random_artifact = {
				show_scope_change = no

				limit = {
					has_artifact_flag = alchemy
					has_artifact_flag = taoist
				}

				tooltip = { destroy_artifact = yes }

				hidden_effect = {
					transfer_artifact = {
						from = ROOT
						to = FROM
					}
				}
			}
		}

		if = {
			limit = {
				FROM = {
					OR = {
						has_character_flag = great_theft
						has_character_flag = good_theft
					}
				}

				any_artifact = {
					has_artifact_flag = alchemists
					has_artifact_flag = ingredient
				}
			}

			random_artifact = {
				show_scope_change = no

				limit = {
					has_artifact_flag = alchemists
					has_artifact_flag = ingredient
				}

				tooltip = { destroy_artifact = yes }

				hidden_effect = {
					transfer_artifact = {
						from = ROOT
						to = FROM
					}
				}
			}
		}

		# Money
		if = {
			limit = { FROM = { has_character_flag = great_theft } }
			tooltip = { scaled_wealth = { value = -0.5 min = -50 } }
		}
		else_if = {
			limit = { FROM = { has_character_flag = good_theft } }
			tooltip = { scaled_wealth = { value = -0.25 min = -25 } }
		}
		else_if = {
			limit = { FROM = { has_character_flag = ok_theft } }
			tooltip = { scaled_wealth = { value = -0.1 min = -10 } }
		}

		FROM = {
			clr_character_flag = great_theft
			clr_character_flag = good_theft
			clr_character_flag = ok_theft
		}
	}
}

# You destroy
character_event = {
	id = soh.11435
	picture = GFX_evt_burning_house
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes
	hide_from = yes

	desc = {
		text = EVTDESCA_SOH_11435
		trigger = { has_character_flag = lab_destruction }
	}
	desc = {
		text = EVTDESCB_SOH_11435
		trigger = { has_character_flag = lab_damage }
	}
	desc = {
		text = EVTDESCC_SOH_11435
		trigger = { has_character_flag = lab_explosion_death }
	}

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	immediate = {
		random_list = {
			40 = { # Total destruction
				trigger = { event_target:infiltration_target = { has_character_flag = built_laboratory } }

				mult_modifier = { learning >= 12 factor = 1.2 }
				mult_modifier = { learning >= 13 factor = 1.2 }
				mult_modifier = { learning >= 16 factor = 1.2 }
				mult_modifier = { learning >= 18 factor = 1.2 }

				set_character_flag = lab_destruction
			}

			55 = { # Major damage
				mult_modifier = { learning >= 10 factor = 1.2 }
				mult_modifier = { learning >= 12 factor = 1.1 }
				mult_modifier = { learning >= 13 factor = 1.1 }
				mult_modifier = { learning >= 16 factor = 1.1 }
				mult_modifier = { learning >= 18 factor = 1.1 }

				set_character_flag = lab_damage
			}

			5 = { # You die in an accident
				trigger = { event_target:infiltration_target = { has_character_flag = built_laboratory } }

				mult_modifier = { learning < 10 factor = 1.5 }
				mult_modifier = { learning < 8 factor = 2 }
				mult_modifier = { learning < 6 factor = 2 }

				mult_modifier = {
					factor = 1.2
					event_target:infiltration_target = { has_character_flag = hidden_lab }
				}
				mult_modifier = {
					factor = 1.5
					event_target:infiltration_target = { has_character_flag = very_hidden_lab }
				}

				set_character_flag = lab_explosion_death
			}
		}
	}

	option = {
		name = EVTOPTA_SOH_11435

		trigger = { has_character_flag = lab_destruction }

		event_target:infiltration_target = {
			show_scope_change = no

			tooltip = {
				trigger_switch = {
					on_trigger = has_character_modifier
					cheap_laboratory  = { remove_character_modifier = cheap_laboratory }
					normal_laboratory = { remove_character_modifier = normal_laboratory }
					good_laboratory   = { remove_character_modifier = good_laboratory }
					great_laboratory  = { remove_character_modifier = great_laboratory }
					best_laboratory   = { remove_character_modifier = best_laboratory }
				}

				destroy_all_ingredients_effect = yes
			}
		}

		add_society_currency_major_effect = yes
	}

	option = {
		name = EVTOPTB_SOH_11435

		trigger = { has_character_flag = lab_damage }

		tooltip = {
			event_target:infiltration_target = {
				show_scope_change = no

				scaled_wealth = { value = -0.3 min = -30 }
				destroy_random_ingredients_effect = yes
			}
		}

		add_society_currency_medium_effect = yes
	}

	option = {
		name = EVTOPTC_SOH_11435

		trigger = { has_character_flag = lab_explosion_death }

		death = { death_reason = death_accident }
	}

	after = {
		hidden_effect = {
			event_target:infiltration_target = { character_event = { id = soh.11436 } }
			character_event = { id = soh.11442 days = 40 }
		}
	}
}

# Infiltration target gets notified of destroyed lab
character_event = {
	id = soh.11436
	picture = GFX_evt_burning_house
	border = GFX_event_normal_frame_intrigue

	desc = {
		text = EVTDESCA_SOH_11436
		trigger = { FROM = { has_character_flag = lab_destruction } }
	}
	desc = {
		text = EVTDESCB_SOH_11436
		trigger = { FROM = { has_character_flag = lab_damage } }
	}
	desc = {
		text = EVTDESCC_SOH_11436
		trigger = {
			FROM = {
				NOR = {
					has_character_flag = lab_destruction
					has_character_flag = lab_damage
				}
			}
		}
	}

	is_triggered_only = yes
	hide_from = yes

	option = {
		name = EVTOPTA_SOH_11436

		trigger = {
			FROM = {
				OR = {
					has_character_flag = lab_destruction
					has_character_flag = lab_damage
				}
			}
		}

		if = {
			limit = { FROM = { has_character_flag = lab_destruction } }

			destroy_all_ingredients_effect = yes
			clr_character_flag = built_laboratory
			clr_character_flag = hidden_lab
			clr_character_flag = very_hidden_lab

			trigger_switch = {
				on_trigger = has_character_modifier
				cheap_laboratory 	= { remove_character_modifier = cheap_laboratory }
				normal_laboratory 	= { remove_character_modifier = normal_laboratory }
				good_laboratory 	= { remove_character_modifier = good_laboratory }
				great_laboratory 	= { remove_character_modifier = great_laboratory }
				best_laboratory 	= { remove_character_modifier = best_laboratory }
			}
		}
		else = {
			scaled_wealth = { value = -0.3 min = -30 }
			destroy_random_ingredients_effect = yes
		}

		hidden_effect = {
			FROM = {
				clr_character_flag = lab_destruction
				clr_character_flag = lab_damage
			}
		}
	}

	option = {
		name = EVTOPTB_SOH_11436

		trigger = {
			FROM = {
				NOR = {
					has_character_flag = lab_destruction
					has_character_flag = lab_damage
				}
			}
		}
	}
}

# Companion attempts to steal
character_event = {
	id = soh.11437
	hide_window = yes
	
	is_triggered_only = yes

	trigger = { FROM = { has_quest = quest_hermetics_infiltrate_laboratory } }

	immediate = {
		random_list = {
			40 = { # Good theft
				trigger = {
					any_artifact = {
						has_artifact_flag = hermetics
						has_artifact_flag = ingredient
					}
				}

				mult_modifier = { learning >= 10 factor = 1.2 }
				mult_modifier = { learning >= 12 factor = 1.1 }
				mult_modifier = { learning >= 13 factor = 1.1 }
				mult_modifier = { learning >= 16 factor = 1.1 }
				mult_modifier = { learning >= 18 factor = 1.1 }

				set_character_flag = good_theft
				FROM = { character_event = { id = soh.11438 days = 20 } }
			}

			40 = { # Ok theft
				set_character_flag = ok_theft
				FROM = { character_event = { id = soh.11438 days = 20 } }
			}

			20 = { # Bad theft
				mult_modifier = { learning < 10 factor = 1.5 }
				mult_modifier = { learning < 8 factor = 2 }
				mult_modifier = { intrigue < 10 factor = 1.5 }
				mult_modifier = { intrigue < 8 factor = 2 }

				mult_modifier = {
					factor = 1.2
					event_target:infiltration_target = { has_character_flag = hidden_lab }
				}
				mult_modifier = {
					factor = 1.5
					event_target:infiltration_target = { has_character_flag = very_hidden_lab }
				}

				set_character_flag = bad_theft
				FROM = { character_event = { id = soh.11427 } }
			}
		}
	}
}

# Companion steal attempt good/ok outcome
character_event = {
	id = soh.11438
	picture = GFX_evt_library
	border = GFX_event_normal_frame_intrigue
	# portrait = event_target:infiltration_companion

	desc = {
		text = EVTDESCA_SOH_11438
		trigger = { FROM = { has_character_flag = good_theft } }
	}
	desc = {
		text = EVTDESCB_SOH_11438
		trigger = { FROM = { has_character_flag = ok_theft } }
	}

	is_triggered_only = yes

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	option = {
		name = EVTOPTA_SOH_11438

		trigger = { FROM = { has_character_flag = good_theft } }

		add_artifact = ingredient_metal_exotic2
		add_society_currency_minor_effect = yes

		hidden_effect = { FROM = { clr_character_flag = good_theft } }
	}

	option = {
		name = EVTOPTB_SOH_11438

		trigger = { FROM = { has_character_flag = ok_theft } }

		add_society_currency_minor_effect = yes
		hidden_effect = { FROM = { clr_character_flag = ok_theft } }
	}
}

# Companion attempts to destroy
character_event = {
	id = soh.11439
	hide_window = yes
	
	is_triggered_only = yes

	trigger = { FROM = { has_quest = quest_hermetics_infiltrate_laboratory } }

	immediate = {
		random_list = {
			90 = { # Lab damage
				mult_modifier = { learning >= 10 factor = 1.2 }
				mult_modifier = { learning >= 12 factor = 1.1 }
				mult_modifier = { learning >= 13 factor = 1.1 }
				mult_modifier = { learning >= 16 factor = 1.1 }
				mult_modifier = { learning >= 18 factor = 1.1 }

				FROM = { character_event = { id = soh.11440 days = 20 } }
			}

			10 = { # They die
				mult_modifier = { learning < 10 factor = 1.5 }
				mult_modifier = { learning < 8 factor = 2 }
				mult_modifier = { intrigue < 10 factor = 1.5 }
				mult_modifier = { intrigue < 8 factor = 2 }

				mult_modifier = {
					factor = 1.2
					event_target:infiltration_target = { has_character_flag = hidden_lab }
				}
				mult_modifier = {
					factor = 1.5
					event_target:infiltration_target = { has_character_flag = very_hidden_lab }
				}

				FROM = { character_event = { id = soh.11441 } }
			}
		}
	}
}

# Companion manages to damage lab
character_event = {
	id = soh.11440
	desc = EVTDESC_SOH_11440
	picture = GFX_evt_burning_house
	border = GFX_event_normal_frame_intrigue
	# portrait = event_target:infiltration_companion

	is_triggered_only = yes

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	option = {
		name = EVTOPTA_SOH_11440

		add_society_currency_minor_effect = yes
	}
}

# Companion dies in an explotion
character_event = {
	id = soh.11441
	desc = EVTDESC_SOH_11441
	picture = GFX_evt_burning_house
	border = GFX_event_normal_frame_intrigue
	# portrait = event_target:infiltration_companion

	is_triggered_only = yes

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	option = {
		name = EVTOPTA_SOH_11441

		event_target:infiltration_companion = {
			show_scope_change = no
			death = { death_reason = death_accident }
		}

		clr_quest = { id = quest_hermetics_infiltrate_laboratory failure = yes }
	}
}

# You escape and mission is complete
character_event = {
	id = soh.11442
	desc = EVTDESC_SOH_11442
	picture = GFX_evt_burning_house
	border = GFX_event_normal_frame_intrigue

	is_triggered_only = yes

	trigger = { has_quest = quest_hermetics_infiltrate_laboratory }

	option = {
		name = EVTOPTA_SOH_11442

		clr_quest = quest_hermetics_infiltrate_laboratory
		sound_effect = hermetic_society_perform_experiment

		hidden_effect = {
			reverse_remove_opinion = {
				name = opinion_infiltration_companion
				who = event_target:infiltration_companion
			}
		}

		if = {
			limit = {
				opinion = {
					who = event_target:infiltration_companion
					value >= 40
				}

				reverse_opinion = {
					who = event_target:infiltration_companion
					value >= 40
				}

				NOT = { is_friend = event_target:infiltration_companion }
			}

			add_friend = event_target:infiltration_companion
		}
		else = {
			reverse_opinion = {
				name = opinion_accomplice
				who = event_target:infiltration_companion
				years = 10
			}

			hidden_effect = {
				opinion = {
					name = opinion_accomplice
					who = event_target:infiltration_companion
					years = 10
				}
			}
		}
	}
}

# Clears flags from infiltration target
character_event = {
	id = soh.11443
	hide_window = yes
	
	is_triggered_only = yes

	immediate = {
		clr_character_flag = infiltration_rival
		clr_character_flag = infiltration_mutual_dislike
		clr_character_flag = infiltration_rich
	}
}