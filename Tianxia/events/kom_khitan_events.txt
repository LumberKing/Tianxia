namespace = khitan

# Create a Chinese Imperial Liao - might not need to be an event, but this lets us do all kinds of things after they're no longer nomadic
character_event = {
	id = khitan.1
	is_triggered_only = yes
	hide_window = yes
	
	immediate = {
		set_character_flag = special_chinese_imperial
		set_global_flag = khitan_china_created
		activate_title = {
			title = e_northern_steppe
			status = yes
		}
		e_northern_steppe = {
			grant_title = ROOT
			make_primary_title = yes
			set_title_flag = pretender_chinese_empire
		}
		primary_title = {
			add_law = {
				law = chinese_succession
				cooldown = no
				opinion_effect = no
			}
			if = {
				limit = {
					has_dlc = "Conclave"
				}
				add_law = {
					law = ze_administration_laws_2
					cooldown = no
					opinion_effect = no
				}
			}
			else = {
				add_law = {
					law = imperial_administration
					cooldown = no
					opinion_effect = no
				}
			}
			if = {
				limit = {
					has_dlc = "Charlemagne"
				}
				add_law = {
					law = vice_royalty_2
					cooldown = no
					opinion_effect = no
				}
			}
		}
	
		# Vassalize old non-nomadic vassals again
		any_independent_ruler = {
			limit = {
				has_opinion_modifier = {
					who = ROOT
					modifier = i_will_become_a_vassal_again
				}
			}
			set_defacto_liege = ROOT
			remove_opinion = {
				who = ROOT
				modifier = i_will_become_a_vassal_again
			}
		}
			
		# Turn non-nomadic non_emperor tributaries in China into vassals
		any_tributary = {
			if = {
				limit = {
					is_nomadic = no
					NOT = {
						tier = emperor
					}
					any_realm_province = {
						OR = {
							region = world_china
							county = {
								de_jure_liege_or_above = e_china
							}
						}
					}
				}
				set_defacto_liege = ROOT
			}
			# Make the rest into Imperial Tributaries
			else = {
				ROOT = {
					remove_tributary = PREV
					make_tributary = {
						who = PREV
						tributary_type = chinese_imperial_tributary
					}
				}
			}
		}
			
		# Usurp/create capital duchy (and possibly kingdom)
		capital_scope = {
			duchy = {
				if = {
					limit = {
						has_holder = yes
					}
					if = {
						limit = {
							holder_scope = {
								top_liege = {
									character = ROOT
								}
							}
						}
						grant_title_no_opinion = ROOT
					}
					else = {
						usurp_title = ROOT
					}
				}
			}
			kingdom = {
				if = {
					limit = {
						has_holder = yes
					}
					if = {
						limit = {
							holder_scope = {
								top_liege = {
									character = ROOT
								}
							}
						}
						usurp_title = ROOT
					}
				}
			}
		}
		
		set_government_type = chinese_imperial_government
		custom_tooltip = { text = adopt_chinese_imperialism_gov_tt }
		# DO NOT ADD BACK TEMPLE NAMES; THEY'RE GRANTED ON DEATH!
		if = { # If we have positive Grace, zero it out!
			limit = {
				check_variable = {
					which = grace
					value = 1
				}
			}
			set_variable = {
				which = grace
				value = 0
			}
		}
		detract_grace_super_huge_effect = yes # China is VERY upset with you for doing this!
		detract_grace_super_huge_effect = yes # China is VERY upset with you for doing this!
		hidden_tooltip = {
			e_china = {
				holder_scope = {
					change_variable = {
						which = mandate_of_heaven
						value = -10
					}
				}
			}
		}
		if = {
			limit = {
				has_character_modifier = chinese_imperial_trade_contract
			}
			remove_character_modifier = chinese_imperial_trade_contract
		}
		
		# Make sure we get a decent Mandate!
		add_character_modifier = {
			modifier = mandate_of_heaven_4
			duration = -1
		}
		
		# Claim China
		e_china = {
			add_weak_pressed_claim = PREV
		}
		character_event = { id = soh.5505 } # Name the empire
	}
}

# On startup event to settle if we should settle ASAP
character_event = {
	id = khitan.2
	hide_window = yes
	is_triggered_only = yes
	
	only_playable = yes
	only_independent = yes
	min_age = 16
	only_men = yes
	culture = khitan
	
	trigger = {
		tier = emperor
		is_nomadic = yes
		is_tributary = no
		NOT = {
			has_global_flag = khitan_china_created
		}
		NOT = {
			has_global_flag = khitan_china_startup
		}
		# Only for the Liao (or their descendants)!
		any_owned_bloodline = { # Related by blood to the founder of a pretender dynasty (and not currently the EoC)
			OR = {
				has_bloodline_flag = real_chinese_imperial_bloodline
				has_bloodline_flag = pretender_chinese_imperial_bloodline
			}
			bloodline_is_active_for = ROOT
		}
		ai = yes
		has_game_rule = {
			name = liao_settling
			value = settle_asap
		}
		is_inaccessible_or_incapable_trigger = no
		can_have_chinese_imperial_trigger = yes
		war = no # Important as we don't want to accidentally invalidate the Jin-Song invasion of Liao or other wars
	}
	
	immediate = {
		set_global_flag = khitan_china_startup
		if = {
			limit = {
				# Cannot be the heir to e_china
				e_china = {
					holder_scope = {
						NOR = {
							current_heir = {
								character = ROOT
							}
						}
						# The AI should not do this if it shares the dynasty of the EoC
						OR = {
							ROOT = {
								ai = no
							}
							NOT = {
								dynasty = ROOT
							}
						}
					}
				}
				NOT = {
					has_character_modifier = peace_deal_with_china # If you have a Chinese Peace Deal, you need to break it or wait for it to expire
				}
				any_independent_ruler = {
					OR = {
						NOT = {
							tier = emperor
						}
						character = ROOT
					}
					any_realm_province = {
						OR = {
							region = world_china
							county = {
								de_jure_liege_or_above = e_china
							}
						}
						capital_holding = {
							holding_type = castle
						}
						holder_scope = {
							NOT = {
								tier = emperor
							}
							top_liege = {
								OR = {
									character = ROOT
									suzerain = {
										character = ROOT
									}
								}
							}
						}
					}
					OR = {
						ai = yes
						num_of_count_titles = 2
					}
				}
				NOT = {
					has_global_flag = khitan_settling_event_happened
				}
			}
			set_global_flag = khitan_settling_event_happened
			random_independent_ruler = {
				limit = {
					NOT = {
						government = chinese_imperial_government
					}
					any_realm_province = {
						OR = {
							region = world_china
							county = {
								de_jure_liege_or_above = e_china
							}
						}
						capital_holding = {
							holding_type = castle
						}
						holder_scope = {
							OR = {
								NOT = {
									tier = emperor
								}
								character = ROOT
							}
							top_liege = {
								OR = {
									character = ROOT
									suzerain = {
										character = ROOT
									}
								}
							}
						}
					}
					OR = {
						ai = yes
						num_of_count_titles = 2
					}
				}
				log = "The new Liao capital will be a province currently in the realm of [This.GetBestName]!"
				random_realm_province = {
					limit = {
						OR = {
							region = world_china
							county = {
								de_jure_liege_or_above = e_china
							}
						}
						capital_holding = {
							holding_type = castle
						}
					}
					preferred_limit = {
						province_id = 2914 # Dadu - set as the capital
					}
					preferred_limit = {
						num_of_settlements = 7 # Prefer a good province
					}
					preferred_limit = {
						num_of_settlements = 6 # Prefer a good province
					}
					preferred_limit = {
						num_of_settlements = 5 # Prefer a good province
					}
					preferred_limit = {
						num_of_settlements = 4 # Prefer a good province
					}
					preferred_limit = {
						num_of_settlements = 3 # Prefer a good province
					}
					preferred_limit = {
						num_of_settlements = 2 # Prefer a good province
					}
					county = {
						save_event_target_as = liao_capital
					}
					log = "The new Liao capital is [liao_capital.GetName]!"
				}
			}
			
			# This MUST be done in the right order as nomadic stuff is very hardcoded and we're working around that
			# Order of operations:
			# - Spawn event troops in all current Khitan provinces
			# - Usurp the target province
			# - Create a new character and give him all provinces not in the China region that don't have a castle or a city, then grant him independence and make him an Imperial Tributary
			# - Usurp all vassal khans' provinces and vassals in the China region
			# - Release all vassal khans and make them Imperial Tributaries
			# - Set up opinion modifiers for all vassals
			# - Destroy all titular titles
			# - Get the Confucian Bureaucracy government and fire an event
			# The event does the following for ROOT
			# - Activates, flags, and grants e_northern_steppe
			# - Re-vassalizes people
			# - Makes all non-nomadic tributaries located in China that aren't empires into vassals, and make the rest into Imperial Tributaries
			# - Usurps/create capital duchy and possibly kingdom
			# - Makes ROOT Chinese Imperial, removes all Grace, penalizes Grace, and fires the naming event
			
			# Spawn a bunch of troops so that the new realm can try to expand (and so that tributaries don't immediately break off)
			if = {
				limit = {
					has_game_rule = {
						name = khitan_doomstacks
						value = enabled
					}
				}
				custom_tooltip = {
					text = khitan_troops_appear
					if = {
						limit = {
							NOT = {
								any_realm_province = {
									count = 50
									culture = khitan
								}
							}
						}
						any_realm_province = {
							limit = {
								culture = khitan
							}
							PREV = {
								if = {
									limit = {
										year = 1066 # Stamford Bridge or later: China will probably be united-ish, so we need extra troops to survive...
									}
									spawn_unit = {
										owner = ROOT
										province = PREV
										home = PREV
											troops = {
											# Intentionally less than for the Jurchen decision as Liao is supposed to be less likely to successfully blob all over China
											light_cavalry = { 350 350 }
											horse_archers = { 150 150 }
											knights = { 50 50 }
										}
									}
								}
								else = { # IC: China is not united, so let's not drown them in event troops...
									spawn_unit = {
										owner = ROOT
										province = PREV
										home = PREV
											troops = {
											# Intentionally less than for the Jurchen decision as Liao is supposed to be less likely to successfully blob all over China
											light_cavalry = { 200 200 }
											horse_archers = { 100 100 }
											knights = { 50 50 }
										}
									}
								}
							}
						}
					}
					else = {
						set_variable = {
							which = troops_spawned
							value = 0
						}
						while = {
							limit = {
								NOT = {
									is_variable_equal = {
										which = troops_spawned
										value = 50
									}
								}
							}
							change_variable = {
								which = troops_spawned
								value = 1
							}
							random_realm_province = {
								limit = {
									culture = khitan
								}
								PREV = {
									if = {
										limit = {
											year = 1066 # Stamford Bridge or later: China will probably be united-ish, so we need extra troops to survive...
										}
										spawn_unit = {
											owner = ROOT
											province = PREV
											home = PREV
												troops = {
												# Intentionally less than for the Jurchen decision as Liao is supposed to be less likely to successfully blob all over China
												light_cavalry = { 350 350 }
												horse_archers = { 150 150 }
												knights = { 50 50 }
											}
										}
									}
									else = { # IC: China is not united, so let's not drown them in event troops...
										spawn_unit = {
											owner = ROOT
											province = PREV
											home = PREV
												troops = {
												# Intentionally less than for the Jurchen decision as Liao is supposed to be less likely to successfully blob all over China
												light_cavalry = { 200 200 }
												horse_archers = { 100 100 }
												knights = { 50 50 }
											}
										}
									}
								}
							}
						}
					}
				}
			}
			
			custom_tooltip = {
				text = found_khitan_empire
				# Take over the target province
				event_target:liao_capital = {
					grant_title_no_opinion = PREV
					ROOT = {
						capital = PREV
					}
					location = {
						culture = ROOT
						religion = ROOT
					}
				}
				
				# Create courtier that'll be a new nomadic ruler and throw a bunch of provinces at him, then make him independent and a tributary
				create_random_soldier = {
					random_traits = yes
					dynasty = random
					religion = ROOT
					culture = ROOT
					female = no
					age = 25
				}
				new_character = {
					save_event_target_as = new_nomad
				}
				any_demesne_province = {
					limit = {
						NOR = {
							region = world_china
							county = {
								de_jure_liege_or_above = e_china
							}
							any_province_holding = {
								OR = {
									holding_type = castle
									holding_type = city
								}
							}
						}
					}
					county = {
						event_target:new_nomad = {
							grant_title = PREV
						}
					}
				}
				event_target:new_nomad = {
					set_defacto_liege = THIS
					ROOT = {
						make_tributary = {
							who = event_target:new_nomad
							tributary_type = chinese_imperial_tributary
						}
					}
				}
				
				# Take over provinces and vassals in China from vassal khans, then make the khans Imperial Tributaries
				any_vassal = {
					limit = {
						is_nomadic = yes
					}
					any_demesne_province = {
						limit = {
							OR = {
								region = world_china
								county = {
									de_jure_liege_or_above = e_china
								}
							}
						}
						county = {
							ROOT = {
								grant_title_no_opinion = PREV
							}
						}
					}
					# Two tiers of vassals (dukes and kings)
					any_vassal = {
						limit = {
							OR = {
								any_demesne_province = {
									OR = {
										region = world_china
										county = {
											de_jure_liege_or_above = e_china
										}
									}
								}
								any_vassal = {
									any_demesne_province = {
										OR = {
											region = world_china
											county = {
												de_jure_liege_or_above = e_china
											}
										}
									}
								}
							}
						}
						set_defacto_liege = ROOT
					}
					set_defacto_liege = THIS
					ROOT = {
						make_tributary = {
							who = PREV
							tributary_type = chinese_imperial_tributary
						}
					}
				}
				
				# Set up opinion modifiers for all vassals, then release them
				any_vassal = {
					limit = {
						higher_tier_than = baron
					}
					opinion = {
						who = ROOT
						modifier = i_will_become_a_vassal_again
						months = 1
					}
					set_defacto_liege = THIS
				}
				
				# Destroy all titular titles
				any_demesne_title = {
					limit = {
						is_titular = yes
					}
					unsafe_destroy_landed_title = THIS
				}
				
				# Become Confucian Bureaucracy (we don't want to be nomadic) and get the proper title) and go to the event that does the rest
				set_government_type = chinese_vassal_government
				character_event = { id = khitan.1 }
			}
		}
	}
}

### Sixteen Prefectures - Jin-Liao deal

# Cede the Sixteen Prefectures? - Jin
character_event = {
	id = khitan.3
	desc = EVTDESC_KHITAN_3
	picture = GFX_evt_china_golden_age
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the CB resolving successfully with a valid Liao emperor
	
	immediate = {
		any_independent_ruler = {
			limit = {
				dynasty = 1045082 # Liao Dynasty
				tier = emperor
				any_owned_bloodline = {
					has_bloodline_flag = liao_china
				}
			}
			save_event_target_as = liao_emperor
		}
	}
	
	option = {
		name = EVTOPTA_KHITAN_3 # A deal is a deal...
		trigger = {
			has_character_flag = starting_jin_emperor
		}
		
		hidden_tooltip = {
			change_variable = {
				which = mandate_of_heaven
				value = -5 # You're ceding Chinese land...
			}
		}
		
		custom_tooltip = {
			text = cede_the_sixteen_prefectures
			# Inform vassals that have land that is being ceded
			any_realm_lord = {
				limit = {
					ai = no
					any_demesne_title = {
						OR = {
							title = c_wuzhai
							title = c_shuozhou
							title = c_datong
							title = c_dadu
							title = c_zhangjiakou
							title = c_chengde
							title = c_kaiping
						}
					}
				}
				character_event = { id = khitan.5 }
			}
			
			# Cede the Sixteen Prefectures
			sixteen_prefectures_transfer_effect = yes
			
			event_target:liao_emperor = {
				character_event = { id = khitan.4 } # Inform Liao
			}
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = deceitful
					trait = arbitrary
				}
				NOR = {
					trait = honest
					trait = just
				}
			}
		}
	}
	
	option = {
		name = EVTOPTB_KHITAN_3 # I have altered the deal!
		trigger = {
			has_character_flag = starting_jin_emperor
		}
		custom_tooltip = {
			text = pray_i_do_not_alter_it_any_further
		}
		
		hidden_tooltip = {
			change_variable = {
				which = mandate_of_heaven
				value = -2 # China shouldn't renege!
			}
		}
		prestige = -1000
		piety = -1000
		
		event_target:liao_emperor = {
			character_event = { id = khitan.7 } # Inform Liao
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = honest
					trait = just
				}
				NOR = {
					trait = deceitful
					trait = arbitrary
				}
				any_independent_ruler = {
					has_character_flag = starting_liao_ruler
				}
			}
			modifier = { # If the other party has changed there's an excuse...
				factor = 0.1
				OR = {
					trait = honest
					trait = just
				}
				NOR = {
					trait = deceitful
					trait = arbitrary
				}
				NOT = {
					any_independent_ruler = {
						has_character_flag = starting_liao_ruler
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTC_KHITAN_3 # It isn't my deal, but...
		trigger = {
			NOT = {
				has_character_flag = starting_jin_emperor
			}
		}
		
		hidden_tooltip = {
			change_variable = {
				which = mandate_of_heaven
				value = -5 # You're ceding Chinese land...
			}
		}
		
		custom_tooltip = {
			text = cede_the_sixteen_prefectures
			# Inform vassals that have land that is being ceded
			any_realm_lord = {
				limit = {
					ai = no
					any_demesne_title = {
						OR = {
							title = c_wuzhai
							title = c_shuozhou
							title = c_datong
							title = c_dadu
							title = c_zhangjiakou
							title = c_chengde
							title = c_kaiping
						}
					}
				}
				character_event = { id = khitan.5 }
			}
			
			# Cede the Sixteen Prefectures
			sixteen_prefectures_transfer_effect = yes
			
			event_target:liao_emperor = {
				character_event = { id = khitan.4 days = 1 } # Inform Liao
			}
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = deceitful
					trait = arbitrary
				}
				NOR = {
					trait = honest
					trait = just
				}
			}
		}
	}
	
	option = {
		name = EVTOPTD_KHITAN_3 # I am not bound by his word!
		trigger = {
			NOT = {
				has_character_flag = starting_jin_emperor
			}
		}
		
		# Smaller penalty because it isn't your agreement you're breaking...
		hidden_tooltip = {
			change_variable = {
				which = mandate_of_heaven
				value = -2 # China shouldn't renege!
			}
		}
		prestige = -500
		piety = -500
		
		event_target:liao_emperor = {
			character_event = { id = khitan.7 } # Inform Liao
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = honest
					trait = just
				}
				NOR = {
					trait = deceitful
					trait = arbitrary
				}
				any_independent_ruler = {
					has_character_flag = starting_liao_ruler
				}
			}
			modifier = { # If the other party has changed there's an excuse...
				factor = 0.1
				OR = {
					trait = honest
					trait = just
				}
				NOR = {
					trait = deceitful
					trait = arbitrary
				}
				NOT = {
					any_independent_ruler = {
						has_character_flag = starting_liao_ruler
					}
				}
			}
		}
	}
}

# Inform Liao - Sixteen Prefectures ceded
character_event = {
	id = khitan.4
	desc = EVTDESC_KHITAN_4
	picture = GFX_evt_china_diplomatic_success
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the first event
	
	option = {
		name = EVTOPTA_KHITAN_4 # As would be expected!
		
		# Increase opinion of FROM
		opinion = {
			who = FROM
			modifier = ceded_sixteen_prefectures_liao
		}
		
		# NAP with Jin for 10 years
		opinion = {
			who = FROM
			modifier = in_non_aggression_pact
			months = 120
			origin_description = sixteen_prefectures_transfer
		}
		reverse_opinion = {
			who = FROM
			modifier = in_non_aggression_pact
			months = 120
			origin_description = sixteen_prefectures_transfer
		}
		
		if = {
			limit = {
				ai = yes
				has_game_rule = {
					name = liao_settling
					value = settle_asap
				}
			}
			character_event = { id = khitan.17 }
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 10
				has_character_flag = starting_liao_ruler
			}
			modifier = {
				factor = 0
				NOT = {
					has_character_flag = starting_liao_ruler
				}
				OR = {
					trait = deceitful
					trait = arbitrary
					trait = ambitious
				}
				NOR = {
					trait = honest
					trait = just
					trait = content
				}
			}
			modifier = {
				factor = 0.1
				has_character_flag = starting_liao_ruler
				OR = {
					trait = deceitful
					trait = arbitrary
					trait = ambitious
				}
				NOR = {
					trait = honest
					trait = just
					trait = content
				}
			}
		}
	}
	
	option = {
		name = EVTOPTB_KHITAN_4 # Today the Sixteen Prefectures; tomorrow all of China!
		
		# Inform FROM
		FROM = {
			character_event = { id = khitan.6 }
		}
		
		prestige = -1000
		piety = -1000
		
		if = {
			limit = {
				ai = yes
				has_game_rule = {
					name = liao_settling
					value = settle_asap
				}
			}
			character_event = { id = khitan.17 }
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.1
				NOT = {
					has_character_flag = starting_liao_ruler
				}
				OR = {
					trait = just
					trait = content
					trait = honest
				}
				NOR = {
					trait = deceitful
					trait = arbitrary
					trait = ambitious
				}
			}
			modifier = {
				factor = 0
				has_character_flag = starting_liao_ruler
				OR = {
					trait = just
					trait = content
					trait = honest
				}
				NOR = {
					trait = deceitful
					trait = arbitrary
					trait = ambitious
				}
			}
			modifier = {
				factor = 0.1
				has_character_flag = starting_liao_ruler
			}
		}
	}
}

# Inform ceded vassals
character_event = {
	id = khitan.5
	desc = EVTDESC_KHITAN_5
	picture = GFX_evt_china_diplomatic_incident
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the first event
	
	option = {
		name = EVTOPTA_KHITAN_5 # A true emperor of China would never cede Chinese land!
		
		opinion = {
			who = FROM
			modifier = ceded_sixteen_prefectures_owner
		}
	}
}

# Inform Jin that Liao didn't go for the NAP
character_event = {
	id = khitan.6
	desc = EVTDESC_KHITAN_6
	picture = GFX_evt_china_diplomatic_incident
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the scecond event
	
	option = {
		name = EVTOPTA_KHITAN_6 # I have a bad feeling about this...
		
		opinion = {
			who = FROM
			modifier = no_liao_nap
		}
	}
}

# Inform Liao - Sixteen Prefectures NOT ceded
character_event = {
	id = khitan.7
	desc = EVTDESC_KHITAN_7
	picture = GFX_evt_china_diplomatic_incident
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the first event
	
	option = {
		name = EVTOPTA_KHITAN_7 # Oh, well...
		
		prestige = -500
		
		# Decrease opinion of FROM
		opinion = {
			who = FROM
			modifier = no_sixteen_prefectures
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				trait = ambitious
				NOT = {
					trait = craven
				}
			}
		}
	}
	
	option = {
		name = EVTOPTB_KHITAN_7 # The Sixteen Prefectures shall be mine!
		
		# Decrease opinion of FROM
		opinion = {
			who = FROM
			modifier = no_sixteen_prefectures
		}
		
		# Add claims
		c_wuzhai = {
			add_claim = ROOT
		}
		c_shuozhou = {
			add_claim = ROOT
		}
		c_datong = {
			add_claim = ROOT
		}
		c_dadu = {
			add_claim = ROOT
		}
		c_zhangjiakou = {
			add_claim = ROOT
		}
		c_chengde = {
			add_claim = ROOT
		}
		c_kaiping = {
			add_claim = ROOT
		}
		
		# Declare war for the claims
		unsafe_war = {
			target = FROM
			casus_belli = claim_all
		}
		
		# Spawn event troops
		any_realm_province = {
			limit = {
				culture = khitan
			}
			PREV = {
				spawn_unit = {
					owner = ROOT
					province = PREV
					home = PREV
					troops = {
						light_cavalry = { 1000 1000 }
						horse_archers = { 500 500 }
						knights = { 250 250 }
					}
				}
			}
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.1
				trait = ambitious
			}
			modifier = {
				factor = 0.1
				trait = craven
			}
			modifier = {
				factor = 0.1
				trait = content
			}
			modifier = {
				factor = 0.95
				FROM = {
					NOT = {
						has_character_flag = starting_jin_emperor # Someone else made the promise, so...
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTC_KHITAN_7 # ALL of your land is now forfeit!
		
		# Decrease opinion of FROM
		opinion = {
			who = FROM
			modifier = no_sixteen_prefectures
		}
		
		# Declare war for EVERYTHING in the China region
		unsafe_war = {
			target = FROM
			casus_belli = khitan_invasion
		}
		
		# Spawn event troops
		any_realm_province = {
			limit = {
				culture = khitan
			}
			PREV = {
				spawn_unit = {
					owner = ROOT
					province = PREV
					home = PREV
					troops = {
						light_cavalry = { 1000 1000 }
						horse_archers = { 500 500 }
						knights = { 250 250 }
					}
				}
			}
		}
		
		# Let other rulers in China join the defender, if desirable
		any_independent_ruler = {
			limit = {
				any_realm_province = {
					region = world_china
				}
				NOR = {
					character = FROM
					character = ROOT
					suzerain = {
						character = ROOT
					}
					war = yes # We don't want to risk dragging in opposing sides in another war, nor have Liao accidentally interfere there because one side is hostile
				}
			}
			character_event = { id = khitan.8 }
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				trait = content
			}
			modifier = {
				factor = 0
				trait = craven
			}
			modifier = {
				factor = 10
				trait = ambitious
			}
			modifier = {
				factor = 10
				trait = proud
			}
			modifier = {
				factor = 0.9
				FROM = {
					NOT = {
						has_character_flag = starting_jin_emperor # Someone else made the promise, so...
					}
				}
			}
		}
	}
}

# Inform other rulers that Liao is invading
character_event = {
	id = khitan.8
	desc = EVTDESC_KHITAN_8
	picture = GFX_evt_china_mongols_invade
	border = GFX_event_normal_frame_war
	is_triggered_only = yes # Triggered from the fifth event
	
	option = {
		name = EVTOPTA_KHITAN_8 # I will not help a deal-breaker!
		
		# Make Liao happier
		reverse_opinion = {
			who = FROM
			modifier = stayed_out_of_my_way
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.1
				FROMFROM = {
					NOT = {
						has_character_flag = starting_jin_emperor
					}
				}
			}
			modifier = {
				factor = 10
				trait = craven
			}
			modifier = {
				factor = 2
				trait = just
				FROMFROM = {
					has_character_flag = starting_jin_emperor
				}
			}
			modifier = {
				factor = 2
				trait = honest
				FROMFROM = {
					has_character_flag = starting_jin_emperor
				}
			}
			modifier = {
				factor = 10
				trait = ambitious # Chaos in the north is good!
			}
			modifier = {
				factor = 0
				any_friend = {
					character = FROMFROM
				}
			}
		}
	}
	
	option = {
		name = EVTOPTB_KHITAN_8 # All of China must unite against this threat!
		
		# Upset Liao, please Jin
		reverse_opinion = {
			who = FROM
			modifier = joined_war_against_me
		}
		reverse_opinion = {
			who = FROMFROM
			modifier = fighting_the_khitans_with_me
		}
		
		e_black_turtle = {
			holder_scope = {
				character_event = { id = khitan.9 } # Inform Jin
				ROOT = {
					join_defender_wars = PREV
				}
			}
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0.01
				government = chinese_imperial_government # Pretender emperor
			}
			modifier = {
				factor = 10
				trait = content
			}
			modifier = {
				factor = 10
				trait = brave
			}
			modifier = {
				factor = 0
				any_rival = {
					character = FROMFROM
				}
			}
			modifier = {
				factor = 0.1
				NOT = {
					culture = FROMFROM
				}
			}
			modifier = {
				factor = 0.01
				NOT = {
					culture_group = FROMFROM
				}
			}
			modifier = {
				factor = 0
				NOT = {
					has_chinese_or_historical_culture_for_chinese_imperial_trigger = yes
				}
				FROMFROM = {
					has_chinese_or_historical_culture_for_chinese_imperial_trigger = yes
				}
			}
			modifier = {
				factor = 0.1
				NOT = {
					religion = FROMFROM
				}
			}
			modifier = {
				factor = 0
				NOT = {
					can_have_confucian_bureaucracy_and_eastern_imperial_trigger = yes
				}
				FROMFROM = {
					can_have_confucian_bureaucracy_and_eastern_imperial_trigger = yes
				}
			}
		}
	}
}

# Inform Jin that someone is backing you againts Liao
character_event = {
	id = khitan.9
	desc = EVTDESC_KHITAN_9
	picture = GFX_evt_china_expansionist
	border = GFX_event_normal_frame_war
	is_triggered_only = yes # Triggered from the sixth event
	
	option = {
		name = EVTOPTA_KHITAN_9 # We stand united!
	}
}

### Sixteen Prefectures - Liao-Tang

# Liao gets the opportunity to ask Tang to hand over the Sixteen Prefectures if Jin loses
character_event = {
	id = khitan.10
	desc = EVTDESC_KHITAN_10
	picture = GFX_evt_china_golden_age
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the CB resolving unsuccessfully with a valid Liao emperor
	
	immediate = {
		e_black_turtle = {
			holder_scope = {
				save_event_target_as = tang_emperor
			}
		}
	}
	
	option = {
		name = EVTOPTA_KHITAN_10 # It wouldn't hurt to ask
		
		event_target:tang_emperor = {
			character_event = { id = khitan.11 } # Inform Tang
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = content
					trait = humble
				}
				NOR = {
					trait = ambitious
					trait = greedy
				}
				has_character_flag = starting_liao_ruler
			}
			modifier = {
				factor = 0.1
				OR = {
					trait = content
					trait = humble
				}
				NOR = {
					trait = ambitious
					trait = greedy
				}
				NOT = {
					has_character_flag = starting_liao_ruler
				}
			}
		}
	}
	
	option = {
		name = EVTOPTB_KHITAN_10 # It isn't worth it
		
		prestige = -100
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = ambitious
					trait = greedy
				}
				NOR = {
					trait = content
					trait = humble
				}
				has_character_flag = starting_liao_ruler
			}
			modifier = {
				factor = 0.1
				OR = {
					trait = ambitious
					trait = greedy
				}
				NOR = {
					trait = content
					trait = humble
				}
				NOT = {
					has_character_flag = starting_liao_ruler
				}
			}
		}
	}
}

# Tang is asked
character_event = {
	id = khitan.11
	desc = EVTDESC_KHITAN_11
	picture = GFX_evt_china_golden_age
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the previous event
	
	option = {
		name = EVTOPTA_KHITAN_11 # Very well...
		
		hidden_tooltip = {
			change_variable = {
				which = mandate_of_heaven
				value = -5 # You're ceding Chinese land...
			}
		}
		prestige = -500
		piety = -500
		
		# NAP with Jin for 10 years
		opinion = {
			who = FROM
			modifier = in_non_aggression_pact
			months = 120
			origin_description = sixteen_prefectures_transfer
		}
		reverse_opinion = {
			who = FROM
			modifier = in_non_aggression_pact
			months = 120
			origin_description = sixteen_prefectures_transfer
		}
		
		custom_tooltip = {
			text = cede_the_sixteen_prefectures
			# Inform vassals that have land that is being ceded
			any_realm_lord = {
				limit = {
					ai = no
					any_demesne_title = {
						OR = {
							title = c_wuzhai
							title = c_shuozhou
							title = c_datong
							title = c_dadu
							title = c_zhangjiakou
							title = c_chengde
							title = c_kaiping
						}
					}
				}
				character_event = { id = khitan.13 }
			}
			
			# Cede the Sixteen Prefectures
			sixteen_prefectures_transfer_effect = yes
			
			event_target:liao_emperor = {
				character_event = { id = khitan.12 days = 1 } # Inform Liao
			}
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = ambitious
					trait = brave
					trait = proud
				}
				NOR = {
					trait = content
					trait = craven
					trait = humble
				}
			}
			modifier = {
				factor = 0.1
				has_character_flag = starting_tang_emperor
			}
		}
	}
	
	option = {
		name = EVTOPTB_KHITAN_11 # Cede my land? You must be joking!
		
		FROM = {
			character_event = { id = khitan.14 } # Inform Liao, give them the option to claim the Sixteen Prefectures
		}
		
		hidden_tooltip = {
			change_variable = {
				which = mandate_of_heaven
				value = 5 # This is the response China should give...
			}
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = content
					trait = craven
					trait = humble
				}
				NOR = {
					trait = ambitious
					trait = brave
					trait = proud
				}
				NOT = {
					has_character_flag = starting_tang_emperor
				}
			}
			modifier = {
				factor = 0.1
				OR = {
					trait = content
					trait = craven
					trait = humble
				}
				NOR = {
					trait = ambitious
					trait = brave
					trait = proud
				}
				has_character_flag = starting_tang_emperor
			}
		}
	}
}

# Liao gets the Sixteen Prefectures
character_event = {
	id = khitan.12
	desc = EVTDESC_KHITAN_12
	picture = GFX_evt_china_diplomatic_success
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the first event
	
	option = {
		name = EVTOPTA_KHITAN_12 # This was a mutually beneficial deal!
		
		opinion = {
			who = FROM
			modifier = ceded_sixteen_prefectures_liao
		}
		
		if = {
			limit = {
				ai = yes
				has_game_rule = {
					name = liao_settling
					value = settle_asap
				}
			}
			character_event = { id = khitan.17 }
		}
	}
}

# Inform former Tang vassals of the transfer
character_event = {
	id = khitan.13
	desc = EVTDESC_KHITAN_13
	picture = GFX_evt_china_diplomatic_incident
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the ninth event
	
	option = {
		name = EVTOPTA_KHITAN_13 # A true emperor of China would never cede Chinese land!
		
		opinion = {
			who = FROM
			modifier = ceded_sixteen_prefectures_owner
		}
	}
}

# Liao does not get the Sixteen Prefectures
character_event = {
	id = khitan.14
	desc = EVTDESC_KHITAN_14
	picture = GFX_evt_china_diplomatic_incident
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the ninth event
	
	option = {
		name = EVTOPTA_KHITAN_14 # I suppose it was to be expected...
		
		# Decrease opinion of FROM
		opinion = {
			who = FROM
			modifier = no_sixteen_prefectures
		}
		
		prestige = -100
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = ambitious
					trait = brave
					trait = proud
				}
				NOR = {
					trait = content
					trait = craven
					trait = humble
				}
			}
		}
	}
	
	option = {
		name = EVTOPTB_KHITAN_14 # The Sixteen Prefectures will be mine!
		
		# Decrease opinion of FROM
		opinion = {
			who = FROM
			modifier = no_sixteen_prefectures
		}
		
		prestige = -1000
		piety = -500
		
		# Add claims
		c_wuzhai = {
			add_claim = ROOT
		}
		c_shuozhou = {
			add_claim = ROOT
		}
		c_datong = {
			add_claim = ROOT
		}
		c_dadu = {
			add_claim = ROOT
		}
		c_zhangjiakou = {
			add_claim = ROOT
		}
		c_chengde = {
			add_claim = ROOT
		}
		c_kaiping = {
			add_claim = ROOT
		}
		
		FROM = {
			character_event = { id = khitan.15 } # Inform Tang
		}
		
		ai_chance = {
			factor = 100
			modifier = {
				factor = 0
				OR = {
					trait = content
					trait = craven
					trait = humble
				}
				NOR = {
					trait = ambitious
					trait = brave
					trait = proud
				}
			}
		}
	}
}

# Liao claimed the Sixteen Prefectures - inform Tang
character_event = {
	id = khitan.15
	desc = EVTDESC_KHITAN_15
	picture = GFX_evt_china_diplomatic_incident
	border = GFX_event_normal_frame_diplomacy
	is_triggered_only = yes # Triggered from the ninth event
	
	option = {
		name = EVTOPTA_KHITAN_15 # Let them try!
	}
}

# Extra settling - the decision has been disabled for the AI for performance reasons
character_event = {
	id = khitan.16
	hide_window = yes
	is_triggered_only = yes
	
	only_playable = yes
	only_independent = yes
	min_age = 16
	only_men = yes
	culture = khitan
	
	trigger = {
		tier = emperor
		is_nomadic = yes
		is_tributary = no
		NOT = {
			has_global_flag = khitan_china_created
		}
		NOT = {
			has_global_flag = khitan_china_startup
		}
		# Only for the Liao (or their descendants)!
		any_owned_bloodline = { # Related by blood to the founder of a pretender dynasty (and not currently the EoC)
			OR = {
				has_bloodline_flag = real_chinese_imperial_bloodline
				has_bloodline_flag = pretender_chinese_imperial_bloodline
			}
			bloodline_is_active_for = ROOT
		}
		ai = yes
		OR = {
			has_game_rule = {
				name = liao_settling
				value = settle_asap
			}
			has_game_rule = {
				name = liao_settling
				value = settle
			}
		}
		is_inaccessible_or_incapable_trigger = no
		can_have_chinese_imperial_trigger = yes
		war = no # Important as we don't want to accidentally invalidate the Jin-Song invasion of Liao or other wars
	}
	
	immediate = {
		#set_global_flag = khitan_china_startup
		random_list = {
			10 = {
				if = {
					limit = {
						# Cannot be the heir to e_china
						e_china = {
							holder_scope = {
								NOR = {
									current_heir = {
										character = ROOT
									}
								}
								# The AI should not do this if it shares the dynasty of the EoC
								OR = {
									ROOT = {
										ai = no
									}
									NOT = {
										dynasty = ROOT
									}
								}
							}
						}
						NOT = {
							has_character_modifier = peace_deal_with_china # If you have a Chinese Peace Deal, you need to break it or wait for it to expire
						}
						any_independent_ruler = {
							OR = {
								NOT = {
									tier = emperor
								}
								character = ROOT
							}
							any_realm_province = {
								OR = {
									region = world_china
									county = {
										de_jure_liege_or_above = e_china
									}
								}
								capital_holding = {
									holding_type = castle
								}
								holder_scope = {
									NOT = {
										tier = emperor
									}
									top_liege = {
										OR = {
											character = ROOT
											suzerain = {
												character = ROOT
											}
										}
									}
								}
							}
							OR = {
								ai = yes
								num_of_count_titles = 2
							}
						}
						NOT = {
							has_global_flag = khitan_settling_event_happened
						}
					}
					set_global_flag = khitan_settling_event_happened
					random_independent_ruler = {
						limit = {
							any_realm_province = {
								OR = {
									region = world_china
									county = {
										de_jure_liege_or_above = e_china
									}
								}
								capital_holding = {
									holding_type = castle
								}
								holder_scope = {
									OR = {
										NOT = {
											tier = emperor
										}
										character = ROOT
									}
									top_liege = {
										OR = {
											character = ROOT
											suzerain = {
												character = ROOT
											}
										}
									}
								}
							}
							OR = {
								ai = yes
								num_of_count_titles = 2
							}
						}
						log = "The new Liao capital will be a province currently in the realm of [This.GetBestName]!"
						random_realm_province = {
							limit = {
								OR = {
									region = world_china
									county = {
										de_jure_liege_or_above = e_china
									}
								}
								capital_holding = {
									holding_type = castle
								}
							}
							preferred_limit = {
								province_id = 2914 # Dadu - set as the capital
							}
							preferred_limit = {
								num_of_settlements = 7 # Prefer a good province
							}
							preferred_limit = {
								num_of_settlements = 6 # Prefer a good province
							}
							preferred_limit = {
								num_of_settlements = 5 # Prefer a good province
							}
							preferred_limit = {
								num_of_settlements = 4 # Prefer a good province
							}
							preferred_limit = {
								num_of_settlements = 3 # Prefer a good province
							}
							preferred_limit = {
								num_of_settlements = 2 # Prefer a good province
							}
							county = {
								save_event_target_as = liao_capital
							}
							log = "The new Liao capital is [liao_capital.GetName]!"
						}
					}
					
					# This MUST be done in the right order as nomadic stuff is very hardcoded and we're working around that
					# Order of operations:
					# - Spawn event troops in all current Khitan provinces
					# - Usurp the target province
					# - Create a new character and give him all provinces not in the China region that don't have a castle or a city, then grant him independence and make him an Imperial Tributary
					# - Usurp all vassal khans' provinces and vassals in the China region
					# - Release all vassal khans and make them Imperial Tributaries
					# - Set up opinion modifiers for all vassals
					# - Destroy all titular titles
					# - Get the Confucian Bureaucracy government and fire an event
					# The event does the following for ROOT
					# - Activates, flags, and grants e_northern_steppe
					# - Re-vassalizes people
					# - Makes all non-nomadic tributaries located in China that aren't empires into vassals, and make the rest into Imperial Tributaries
					# - Usurps/create capital duchy and possibly kingdom
					# - Makes ROOT Chinese Imperial, removes all Grace, penalizes Grace, and fires the naming event
					
					# Spawn a bunch of troops so that the new realm can try to expand (and so that tributaries don't immediately break off)
					if = {
						limit = {
							has_game_rule = {
								name = khitan_doomstacks
								value = enabled
							}
						}
						custom_tooltip = {
							text = khitan_troops_appear
							any_realm_province = {
								limit = {
									culture = khitan
								}
								PREV = {
									if = {
										limit = {
											year = 1066 # Stamford Bridge or later: China will probably be united-ish, so we need extra troops to survive...
										}
										spawn_unit = {
											owner = ROOT
											province = PREV
											home = PREV
												troops = {
												# Intentionally less than for the Jurchen decision as Liao is supposed to be less likely to successfully blob all over China
												light_cavalry = { 350 350 }
												horse_archers = { 150 150 }
												knights = { 50 50 }
											}
										}
									}
									else = { # IC: China is not united, so let's not drown them in event troops...
										spawn_unit = {
											owner = ROOT
											province = PREV
											home = PREV
												troops = {
												# Intentionally less than for the Jurchen decision as Liao is supposed to be less likely to successfully blob all over China
												light_cavalry = { 200 200 }
												horse_archers = { 100 100 }
												knights = { 50 50 }
											}
										}
									}
								}
							}
						}
					}
					
					custom_tooltip = {
						text = found_khitan_empire
						# Take over the target province
						event_target:liao_capital = {
							grant_title_no_opinion = PREV
							ROOT = {
								capital = PREV
							}
							location = {
								culture = ROOT
								religion = ROOT
							}
						}
						
						# Create courtier that'll be a new nomadic ruler and throw a bunch of provinces at him, then make him independent and a tributary
						create_random_soldier = {
							random_traits = yes
							dynasty = random
							religion = ROOT
							culture = ROOT
							female = no
							age = 25
						}
						new_character = {
							save_event_target_as = new_nomad
						}
						any_demesne_province = {
							limit = {
								NOR = {
									region = world_china
									county = {
										de_jure_liege_or_above = e_china
									}
									any_province_holding = {
										OR = {
											holding_type = castle
											holding_type = city
										}
									}
								}
							}
							county = {
								event_target:new_nomad = {
									grant_title = PREV
								}
							}
						}
						event_target:new_nomad = {
							set_defacto_liege = THIS
							ROOT = {
								make_tributary = {
									who = event_target:new_nomad
									tributary_type = chinese_imperial_tributary
								}
							}
						}
						
						# Take over provinces and vassals in China from vassal khans, then make the khans Imperial Tributaries
						any_vassal = {
							limit = {
								is_nomadic = yes
							}
							any_demesne_province = {
								limit = {
									OR = {
										region = world_china
										county = {
											de_jure_liege_or_above = e_china
										}
									}
								}
								county = {
									ROOT = {
										grant_title_no_opinion = PREV
									}
								}
							}
							# Two tiers of vassals (dukes and kings)
							any_vassal = {
								limit = {
									OR = {
										any_demesne_province = {
											OR = {
												region = world_china
												county = {
													de_jure_liege_or_above = e_china
												}
											}
										}
										any_vassal = {
											any_demesne_province = {
												OR = {
													region = world_china
													county = {
														de_jure_liege_or_above = e_china
													}
												}
											}
										}
									}
								}
								set_defacto_liege = ROOT
							}
							set_defacto_liege = THIS
							ROOT = {
								make_tributary = {
									who = PREV
									tributary_type = chinese_imperial_tributary
								}
							}
						}
						
						# Set up opinion modifiers for all vassals, then release them
						any_vassal = {
							limit = {
								higher_tier_than = baron
							}
							opinion = {
								who = ROOT
								modifier = i_will_become_a_vassal_again
								months = 1
							}
							set_defacto_liege = THIS
						}
						
						# Destroy all titular titles
						any_demesne_title = {
							limit = {
								is_titular = yes
							}
							unsafe_destroy_landed_title = THIS
						}
						
						# Become Confucian Bureaucracy (we don't want to be nomadic) and get the proper title) and go to the event that does the rest
						set_government_type = chinese_vassal_government
						character_event = { id = khitan.1 }
					}
				}
			}
			90 = {
				modifier = {
					factor = 0
					has_game_rule = {
						name = liao_settling
						value = settle_asap
					}
				}
				# Do nothing
			}
		}
	}
}

# Settling post-Sixteen Prefectures
character_event = {
	id = khitan.17
	hide_window = yes
	is_triggered_only = yes
	
	only_playable = yes
	only_independent = yes
	
	immediate = {
		set_global_flag = khitan_china_startup
		set_global_flag = khitan_settling_event_happened
		random_independent_ruler = {
			limit = {
				any_realm_province = {
					OR = {
						region = world_china
						county = {
							de_jure_liege_or_above = e_china
						}
					}
					capital_holding = {
						holding_type = castle
					}
					holder_scope = {
						OR = {
							NOT = {
								tier = emperor
							}
							character = ROOT
						}
						top_liege = {
							OR = {
								character = ROOT
								suzerain = {
									character = ROOT
								}
							}
						}
					}
				}
				OR = {
					ai = yes
					num_of_count_titles = 2
				}
			}
			log = "The new Liao capital will be a province currently in the realm of [This.GetBestName]!"
			random_realm_province = {
				limit = {
					OR = {
						region = world_china
						county = {
							de_jure_liege_or_above = e_china
						}
					}
					capital_holding = {
						holding_type = castle
					}
				}
				preferred_limit = {
					province_id = 2914 # Dadu - set as the capital
				}
				preferred_limit = {
					num_of_settlements = 7 # Prefer a good province
				}
				preferred_limit = {
					num_of_settlements = 6 # Prefer a good province
				}
				preferred_limit = {
					num_of_settlements = 5 # Prefer a good province
				}
				preferred_limit = {
					num_of_settlements = 4 # Prefer a good province
				}
				preferred_limit = {
					num_of_settlements = 3 # Prefer a good province
				}
				preferred_limit = {
					num_of_settlements = 2 # Prefer a good province
				}
				county = {
					save_event_target_as = liao_capital
				}
				log = "The new Liao capital is [liao_capital.GetName]!"
			}
		}
		
		# This MUST be done in the right order as nomadic stuff is very hardcoded and we're working around that
		# Order of operations:
		# - Spawn event troops in all current Khitan provinces
		# - Usurp the target province
		# - Create a new character and give him all provinces not in the China region that don't have a castle or a city, then grant him independence and make him an Imperial Tributary
		# - Usurp all vassal khans' provinces and vassals in the China region
		# - Release all vassal khans and make them Imperial Tributaries
		# - Set up opinion modifiers for all vassals
		# - Destroy all titular titles
		# - Get the Confucian Bureaucracy government and fire an event
		# The event does the following for ROOT
		# - Activates, flags, and grants e_northern_steppe
		# - Re-vassalizes people
		# - Makes all non-nomadic tributaries located in China that aren't empires into vassals, and make the rest into Imperial Tributaries
		# - Usurps/create capital duchy and possibly kingdom
		# - Makes ROOT Chinese Imperial, removes all Grace, penalizes Grace, and fires the naming event
		
		# Spawn a bunch of troops so that the new realm can try to expand (and so that tributaries don't immediately break off)
		if = {
			limit = {
				has_game_rule = {
					name = khitan_doomstacks
					value = enabled
				}
			}
			custom_tooltip = {
				text = khitan_troops_appear
				any_realm_province = {
					limit = {
						culture = khitan
					}
					PREV = {
						if = {
							limit = {
								year = 1066 # Stamford Bridge or later: China will probably be united-ish, so we need extra troops to survive...
							}
							spawn_unit = {
								owner = ROOT
								province = PREV
								home = PREV
									troops = {
									# Intentionally less than for the Jurchen decision as Liao is supposed to be less likely to successfully blob all over China
									light_cavalry = { 350 350 }
									horse_archers = { 150 150 }
									knights = { 50 50 }
								}
							}
						}
						else = { # IC: China is not united, so let's not drown them in event troops...
							spawn_unit = {
								owner = ROOT
								province = PREV
								home = PREV
									troops = {
									# Intentionally less than for the Jurchen decision as Liao is supposed to be less likely to successfully blob all over China
									light_cavalry = { 200 200 }
									horse_archers = { 100 100 }
									knights = { 50 50 }
								}
							}
						}
					}
				}
			}
		}
		
		custom_tooltip = {
			text = found_khitan_empire
			# Take over the target province
			event_target:liao_capital = {
				grant_title_no_opinion = PREV
				ROOT = {
					capital = PREV
				}
				location = {
					culture = ROOT
					religion = ROOT
				}
			}
			
			# Create courtier that'll be a new nomadic ruler and throw a bunch of provinces at him, then make him independent and a tributary
			create_random_soldier = {
				random_traits = yes
				dynasty = random
				religion = ROOT
				culture = ROOT
				female = no
				age = 25
			}
			new_character = {
				save_event_target_as = new_nomad
			}
			any_demesne_province = {
				limit = {
					NOR = {
						region = world_china
						county = {
							de_jure_liege_or_above = e_china
						}
						any_province_holding = {
							OR = {
								holding_type = castle
								holding_type = city
							}
						}
					}
				}
				county = {
					event_target:new_nomad = {
						grant_title = PREV
					}
				}
			}
			event_target:new_nomad = {
				set_defacto_liege = THIS
				ROOT = {
					make_tributary = {
						who = event_target:new_nomad
						tributary_type = chinese_imperial_tributary
					}
				}
			}
			
			# Take over provinces and vassals in China from vassal khans, then make the khans Imperial Tributaries
			any_vassal = {
				limit = {
					is_nomadic = yes
				}
				any_demesne_province = {
					limit = {
						OR = {
							region = world_china
							county = {
								de_jure_liege_or_above = e_china
							}
						}
					}
					county = {
						ROOT = {
							grant_title_no_opinion = PREV
						}
					}
				}
				# Two tiers of vassals (dukes and kings)
				any_vassal = {
					limit = {
						OR = {
							any_demesne_province = {
								OR = {
									region = world_china
									county = {
										de_jure_liege_or_above = e_china
									}
								}
							}
							any_vassal = {
								any_demesne_province = {
									OR = {
										region = world_china
										county = {
											de_jure_liege_or_above = e_china
										}
									}
								}
							}
						}
					}
					set_defacto_liege = ROOT
				}
				set_defacto_liege = THIS
				ROOT = {
					make_tributary = {
						who = PREV
						tributary_type = chinese_imperial_tributary
					}
				}
			}
			
			# Set up opinion modifiers for all vassals, then release them
			any_vassal = {
				limit = {
					higher_tier_than = baron
				}
				opinion = {
					who = ROOT
					modifier = i_will_become_a_vassal_again
					months = 1
				}
				set_defacto_liege = THIS
			}
			
			# Destroy all titular titles
			any_demesne_title = {
				limit = {
					is_titular = yes
				}
				unsafe_destroy_landed_title = THIS
			}
			
			# Become Confucian Bureaucracy (we don't want to be nomadic) and get the proper title) and go to the event that does the rest
			set_government_type = chinese_vassal_government
			character_event = { id = khitan.1 }
		}
	}
}