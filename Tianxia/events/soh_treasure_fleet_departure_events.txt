# Treasure Fleet departure events
# by Silverswee(e)per

namespace = soh

# IDs 9101-9200 reserved

##### Departure events

# Determine if the Empire in the West or Pacific voyage options are on the table
province_event = {
	id = soh.9101
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		# TIANXIATODO: Disease risk?
		if = {
			limit = {
				NOR = {
					has_global_flag = treasure_fleet_is_going_home # Only on the outbound journey
					has_game_rule = {
						name = treasure_fleet_invasion_rule
						value = forbidden
					}
					has_global_flag = treasure_fleet_invasion_failed_to_launch
				}
				
				any_playable_ruler = {
					can_interact_with_treasure_fleet_trigger = yes
					top_liege = {
						any_realm_province = {
							is_in_active_treasure_fleet_region_trigger = yes
							NOT = {
								any_province = {
									owner = {
										top_liege = {
											is_chinese_emperor_trigger = yes
										}
									}
									distance = {
										where = PREV
										value < 500
									}
									can_naval_path_to = {
										target = PREV
										distance <= 1000
									}
								}
							}
						}
					}
				}
				
				2753 = { # Hangzhou
					check_variable = {
						which = treasure_fleet_army_strength
						value = 10
					}
				}
				
				any_playable_ruler = {
					trait = treasure_fleet_voyage
					NOR = {
						has_character_flag = left_treasure_fleet_voyage
						top_liege = {
							dynasty = PREV
						}
					}
					is_feudal = yes
					can_have_chinese_imperial_trigger = yes
					OR = {
						ai = no
						AND = {
							has_game_rule = {
								name = treasure_fleet_invasion_rule
								value = allowed
							}
						}
					}
				}
			}
			
			random_list = {
				1 = {
					random_playable_ruler = {
						limit = {
							can_interact_with_treasure_fleet_trigger = yes
							top_liege = {
								any_realm_province = {
									is_in_active_treasure_fleet_region_trigger = yes
									NOT = {
										any_province = {
											owner = {
												top_liege = {
													is_chinese_emperor_trigger = yes
												}
											}
											distance = {
												where = PREV
												value < 500
											}
											can_naval_path_to = {
												target = PREV
												distance <= 1000
											}
										}
									}
								}
							}
						}
						
						top_liege = {
							save_event_target_as = potential_treasure_fleet_invasion_target
							
							random_realm_province = {
								limit = {
									is_in_active_treasure_fleet_region_trigger = yes
									NOT = {
										any_province = {
											owner = {
												top_liege = {
													is_chinese_emperor_trigger = yes
												}
											}
											distance = {
												where = PREV
												value < 500
											}
											can_naval_path_to = {
												target = PREV
												distance <= 1000
											}
										}
									}
								}
								
								save_event_target_as = potential_treasure_fleet_invasion_target_beachhead
							}
						}
						
						random_playable_ruler = {
							limit = {
								trait = treasure_fleet_voyage
								NOR = {
									has_character_flag = left_treasure_fleet_voyage
									top_liege = {
										dynasty = PREV
									}
								}
								is_feudal = yes
								can_have_chinese_imperial_trigger = yes
								ai = no
							}
							
							preferred_limit = {
								tier = king
								OR = {
									has_character_flag = treasure_fleet_contingency_is_bad
									has_character_flag = treasure_fleet_contingency_is_okay
									has_character_flag = treasure_fleet_contingency_is_good
								}
								
								has_character_flag = treasure_fleet_planned_invasion
							}
							
							preferred_limit = {
								tier = king
								OR = {
									has_character_flag = treasure_fleet_contingency_is_bad
									has_character_flag = treasure_fleet_contingency_is_okay
									has_character_flag = treasure_fleet_contingency_is_good
									has_character_flag = treasure_fleet_planned_invasion
								}
							}
							
							preferred_limit = {
								tier = king
							}
							
							preferred_limit = {
								tier = duke
								OR = {
									has_character_flag = treasure_fleet_contingency_is_bad
									has_character_flag = treasure_fleet_contingency_is_okay
									has_character_flag = treasure_fleet_contingency_is_good
								}
								
								has_character_flag = treasure_fleet_planned_invasion
							}
							
							preferred_limit = {
								tier = duke
								OR = {
									has_character_flag = treasure_fleet_contingency_is_bad
									has_character_flag = treasure_fleet_contingency_is_okay
									has_character_flag = treasure_fleet_contingency_is_good
									has_character_flag = treasure_fleet_planned_invasion
								}
							}
							
							preferred_limit = {
								tier = duke
							}
							
							narrative_event = { id = soh.9103 } # Attempt to create your own empire?
						}
					}
				}
				
				1 = {
					trigger = {
						NOT = {
							has_game_rule = {
								name = treasure_fleet_invasion_rule
								value = no_ai
							}
						}
					}
					
					random_playable_ruler = {
						limit = {
							can_interact_with_treasure_fleet_trigger = yes
							top_liege = {
								any_realm_province = {
									is_in_active_treasure_fleet_region_trigger = yes
									NOR = {
										owner = {
											top_liege = {
												is_chinese_emperor_trigger = yes
											}
										}
										
										e_china = {
											holder_scope = {
												any_realm_province = {
													distance = {
														where = PREVPREVPREV
														value < 500
													}
													can_naval_path_to = {
														target = PREVPREVPREV
														distance <= 1000
													}
												}
											}
										}
									}
								}
							}
						}
						
						top_liege = {
							save_event_target_as = potential_treasure_fleet_invasion_target
							
							random_realm_province = {
								limit = {
									is_in_active_treasure_fleet_region_trigger = yes
									NOR = {
										owner = {
											top_liege = {
												is_chinese_emperor_trigger = yes
											}
										}
										
										e_china = {
											holder_scope = {
												any_realm_province = {
													distance = {
														where = PREVPREVPREV
														value < 500
													}
													can_naval_path_to = {
														target = PREVPREVPREV
														distance <= 1000
													}
												}
											}
										}
									}
								}
								
								save_event_target_as = potential_treasure_fleet_invasion_target_beachhead
							}
						}
						
						random_playable_ruler = {
							limit = {
								trait = treasure_fleet_voyage
								is_feudal = yes
								can_have_chinese_imperial_trigger = yes
								NOT = {
									top_liege = {
										dynasty = PREV
									}
								}
							}
							
							preferred_limit = {
								tier = king
								OR = {
									has_character_flag = treasure_fleet_contingency_is_bad
									has_character_flag = treasure_fleet_contingency_is_okay
									has_character_flag = treasure_fleet_contingency_is_good
								}
								
								has_character_flag = treasure_fleet_planned_invasion
							}
							
							preferred_limit = {
								tier = king
								OR = {
									has_character_flag = treasure_fleet_contingency_is_bad
									has_character_flag = treasure_fleet_contingency_is_okay
									has_character_flag = treasure_fleet_contingency_is_good
									has_character_flag = treasure_fleet_planned_invasion
								}
							}
							
							preferred_limit = {
								tier = king
							}
							
							preferred_limit = {
								tier = duke
								OR = {
									has_character_flag = treasure_fleet_contingency_is_bad
									has_character_flag = treasure_fleet_contingency_is_okay
									has_character_flag = treasure_fleet_contingency_is_good
								}
								
								has_character_flag = treasure_fleet_planned_invasion
							}
							
							preferred_limit = {
								tier = duke
								OR = {
									has_character_flag = treasure_fleet_contingency_is_bad
									has_character_flag = treasure_fleet_contingency_is_okay
									has_character_flag = treasure_fleet_contingency_is_good
									has_character_flag = treasure_fleet_planned_invasion
								}
							}
							
							preferred_limit = {
								tier = duke
							}
							
							narrative_event = { id = soh.9103 } # Attempt to create your own empire?
						}
					}
				}
			}
		}
		
		else_if = {
			limit = {
				has_province_flag = treasure_fleet_in_java
				NOR = {
					has_global_flag = treasure_fleet_is_going_home
					AND = {
						has_global_flag = treasure_fleet_at_nazca
						NOT = {
							has_dlc = "Sunset Invasion"
						}
					}
					has_global_flag = lost_merchant_went_east
					has_global_flag = sunrise_invasion_prelude
					has_global_flag = china_knows_of_burning_empire
				}
			}
			
			province_event = { id = soh.9113 } # Head further east?
		}
		
		else = {
			province_event = { id = soh.9102 } # Determine where the Treasure Fleet goes next
		}
	}
}

# If no Empire in the West or opportunity to sail east, check where the Treasure Fleet goes next
province_event = {
	id = soh.9102
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				NOT = {
					has_global_flag = treasure_fleet_is_going_home
				}
				
				OR = {
					# Almost out of supplies
					check_variable = {
						which = treasure_fleet_supplies
						value < 10
					}
					
					# Or at an endpoint
					has_province_flag = treasure_fleet_in_java
					has_province_flag = treasure_fleet_in_persian_gulf
					has_province_flag = treasure_fleet_in_red_sea
				}
			}
			
			set_global_flag = treasure_fleet_is_going_home
		}
		
		if = {
			limit = {
				NOT = {
					has_global_flag = treasure_fleet_is_going_home
				}
			}
			
			trigger_switch = {
				on_trigger = has_global_flag
				
				treasure_fleet_in_korea = {
					clr_province_flag = treasure_fleet_in_korea
					set_province_flag = treasure_fleet_going_to_japan
				}
				
				treasure_fleet_in_japan = {
					clr_province_flag = treasure_fleet_in_japan
					set_province_flag = treasure_fleet_going_to_ryukyu
				}
				
				treasure_fleet_in_ryukyu = {
					clr_province_flag = treasure_fleet_in_ryukyu
					set_province_flag = treasure_fleet_going_to_maynila
				}
				
				treasure_fleet_in_maynila = {
					clr_province_flag = treasure_fleet_in_maynila
					
					random_list = {
						50 = {
							set_province_flag = treasure_fleet_going_to_champa
						}
						
						50 = {
							set_province_flag = treasure_fleet_going_to_borneo
						}
					}
				}
				
				treasure_fleet_in_champa = {
					clr_province_flag = treasure_fleet_in_champa
					
					random_list = {
						33 = {
							set_province_flag = treasure_fleet_going_to_borneo
						}
						
						33 = {
							set_province_flag = treasure_fleet_going_to_lavo
						}
						
						33 = {
							set_province_flag = treasure_fleet_going_to_temasek
						}
					}
				}
				
				treasure_fleet_in_borneo = {
					clr_province_flag = treasure_fleet_in_borneo
					set_province_flag = treasure_fleet_going_to_temasek
				}
				
				treasure_fleet_in_lavo = {
					clr_province_flag = treasure_fleet_in_lavo
					set_province_flag = treasure_fleet_going_to_temasek
				}
				
				treasure_fleet_in_temasek = {
					clr_province_flag = treasure_fleet_in_temasek
					
					random_list = {
						50 = {
							set_province_flag = treasure_fleet_going_to_palembang
						}
						
						50 = {
							set_province_flag = treasure_fleet_going_to_lamuri
						}
					}
				}
				
				treasure_fleet_in_palembang = {
					clr_province_flag = treasure_fleet_in_palembang
					set_province_flag = treasure_fleet_going_to_java
				}
				
				treasure_fleet_in_lamuri = {
					clr_province_flag = treasure_fleet_in_lamuri
					
					random_list = {
						50 = {
							set_province_flag = treasure_fleet_going_to_dagon
						}
						
						50 = {
							set_province_flag = treasure_fleet_going_to_lanka
						}
					}
				}
				
				treasure_fleet_in_dagon = {
					clr_province_flag = treasure_fleet_in_dagon
					random_list = {
						75 = {
							set_province_flag = treasure_fleet_going_to_bengal
						}
						
						25 = {
							set_province_flag = treasure_fleet_going_to_eastern_india
						}
					}
				}
				
				treasure_fleet_in_bengal = {
					clr_province_flag = treasure_fleet_in_bengal
					set_province_flag = treasure_fleet_going_to_eastern_india
				}
				
				treasure_fleet_in_eastern_india = {
					clr_province_flag = treasure_fleet_in_eastern_india
					set_province_flag = treasure_fleet_going_to_lanka
				}
				
				treasure_fleet_in_lanka = {
					clr_province_flag = treasure_fleet_in_lanka
					
					random_list = {
						75 = {
							set_province_flag = treasure_fleet_going_to_western_india
						}
						
						25 = {
							set_province_flag = treasure_fleet_going_to_socotra
						}
					}
				}
				
				treasure_fleet_in_western_india = {
					clr_province_flag = treasure_fleet_in_western_india
					
					random_list = {
						50 = {
							set_province_flag = treasure_fleet_going_to_sindh
						}
						
						50 = {
							set_province_flag = treasure_fleet_going_to_oman
						}
					}
				}
				
				treasure_fleet_in_sindh = {
					clr_province_flag = treasure_fleet_in_sindh
					set_province_flag = treasure_fleet_going_to_oman
				}
				
				treasure_fleet_in_oman = {
					clr_province_flag = treasure_fleet_in_oman
					
					random_list = {
						50 = {
							set_province_flag = treasure_fleet_going_to_persian_gulf
						}
						
						50 = {
							set_province_flag = treasure_fleet_going_to_socotra
						}
					}
				}
				
				treasure_fleet_in_socotra = {
					clr_province_flag = treasure_fleet_in_socotra
					set_province_flag = treasure_fleet_going_to_red_sea
				}
			}
				
			province_event = { id = soh.9129 } # Potential complications and departure
		}
		
		else = {
			trigger_switch = {
				on_trigger = has_global_flag
				
				treasure_fleet_in_korea = {
					clr_province_flag = treasure_fleet_in_korea
					set_province_flag = treasure_fleet_going_to_china
				}
				
				treasure_fleet_in_japan = {
					clr_province_flag = treasure_fleet_in_japan
					set_province_flag = treasure_fleet_going_to_korea
				}
				
				treasure_fleet_in_ryukyu = {
					clr_province_flag = treasure_fleet_in_ryukyu
					set_province_flag = treasure_fleet_going_to_china
				}
				
				treasure_fleet_in_maynila = {
					clr_province_flag = treasure_fleet_in_maynila
					set_province_flag = treasure_fleet_going_to_china
				}
				
				treasure_fleet_in_champa = {
					clr_province_flag = treasure_fleet_in_champa
					set_province_flag = treasure_fleet_going_to_china
				}
				
				treasure_fleet_in_borneo = {
					clr_province_flag = treasure_fleet_in_borneo
					set_province_flag = treasure_fleet_going_to_champa
				}
				
				treasure_fleet_in_lavo = {
					clr_province_flag = treasure_fleet_in_lavo
					set_province_flag = treasure_fleet_going_to_champa
				}
				
				treasure_fleet_in_temasek = {
					clr_province_flag = treasure_fleet_in_temasek
					set_province_flag = treasure_fleet_going_to_champa
				}
				
				treasure_fleet_in_palembang = {
					clr_province_flag = treasure_fleet_in_palembang
					set_province_flag = treasure_fleet_going_to_temasek
				}
				
				treasure_fleet_in_java = {
					clr_province_flag = treasure_fleet_in_java
					set_province_flag = treasure_fleet_going_to_palembang
				}
				
				treasure_fleet_in_lamuri = {
					clr_province_flag = treasure_fleet_in_lamuri
					set_province_flag = treasure_fleet_going_to_temasek
				}
				
				treasure_fleet_in_dagon = {
					clr_province_flag = treasure_fleet_in_dagon
					set_province_flag = treasure_fleet_going_to_lamuri
				}
				
				treasure_fleet_in_bengal = {
					clr_province_flag = treasure_fleet_in_bengal
					set_province_flag = treasure_fleet_going_to_lamuri
				}
				
				treasure_fleet_in_eastern_india = {
					clr_province_flag = treasure_fleet_in_eastern_india
					set_province_flag = treasure_fleet_going_to_lamuri
				}
				
				treasure_fleet_in_lanka = {
					clr_province_flag = treasure_fleet_in_lanka
					set_province_flag = treasure_fleet_going_to_lamuri
				}
				
				treasure_fleet_in_western_india = {
					clr_province_flag = treasure_fleet_in_western_india
					set_province_flag = treasure_fleet_going_to_lanka
				}
				
				treasure_fleet_in_sindh = {
					clr_province_flag = treasure_fleet_in_sindh
					set_province_flag = treasure_fleet_going_to_western_india
				}
				
				treasure_fleet_in_oman = {
					clr_province_flag = treasure_fleet_in_oman
					set_province_flag = treasure_fleet_going_to_western_india
				}
				
				treasure_fleet_in_persian_gulf = {
					clr_province_flag = treasure_fleet_in_persian_gulf
					set_province_flag = treasure_fleet_going_to_oman
				}
				
				treasure_fleet_in_socotra = {
					clr_province_flag = treasure_fleet_in_socotra
					set_province_flag = treasure_fleet_going_to_lanka
				}
				
				treasure_fleet_in_red_sea = {
					clr_province_flag = treasure_fleet_in_red_sea
					set_province_flag = treasure_fleet_going_to_socotra
				}
			}
			
			province_event = { id = soh.9124 } # Potential complications and departure
		}
	}
}

### Empire in the West

# Ruler sees an opportunity to create an empire of their own in the west
narrative_event = {
	id = soh.9103
	title = EVTTITLE_SOH_9103
	desc = EVTDESC_SOH_9103
	picture = GFX_evt_china_expansionist
	window = EventWindowOffmap
	background = GFX_event_window_news_from_china
	
	is_triggered_only = yes
	
	immediate = {
		d_treasure_fleet = {
			holder_scope = {
				save_event_target_as = treasure_fleet_commander
			}
		}
	}
	
	option = {
		name = EVTOPTA_SOH_9103 # Yes!
		
		character_event = { id = soh.9104 } # Determine outcome
		
		ai_chance = {
			factor = 100
			
			mult_modifier = {
				factor = 0.1
				NOT = {
					trait = proud
				}
			}
			
			mult_modifier = {
				factor = 0.1
				NOT = {
					trait = ambitious
				}
			}
			
			mult_modifier = {
				factor = 0.1
				NOT = {
					trait = brave
				}
			}
			
			mult_modifier = {
				factor = 0.1
				FROM = {
					check_variable = {
						which = treasure_fleet_army_strength
						value < 25
					}
				}
			}
		}
	}
	
	option = {
		name = EVTOPTB_SOH_9103 # No!
		
		FROM = {
			province_event = { id = soh.9102 } # See where to go next
		}
		
		ai_chance = {
			factor = 100
			
			mult_modifier = {
				factor = 0.5
				NOT = {
					trait = humble
				}
			}
			
			mult_modifier = {
				factor = 0.5
				NOT = {
					trait = content
				}
			}
			
			mult_modifier = {
				factor = 0.5
				NOT = {
					trait = craven
				}
			}
			
			mult_modifier = {
				factor = 0.5
				FROM = {
					check_variable = {
						which = treasure_fleet_army_strength
						value >= 50
					}
				}
			}
			
			mult_modifier = {
				factor = 0.5
				FROM = {
					check_variable = {
						which = treasure_fleet_army_strength
						value >= 75
					}
				}
			}
			
			mult_modifier = {
				factor = 0.5
				FROM = {
					check_variable = {
						which = treasure_fleet_army_strength
						value >= 100
					}
				}
			}
		}
	}
}

# Ping to see what happens
character_event = {
	id = soh.9104
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		random_list = {
			50 = {
				mult_modifier = {
					factor = 2
					attribute_diff = {
						who = event_target:treasure_fleet_commander
						attribute = martial
						value <= -5
					}
				}
				
				mult_modifier = {
					factor = 2
					attribute_diff = {
						who = event_target:treasure_fleet_commander
						attribute = martial
						value <= -10
					}
				}
				
				mult_modifier = {
					factor = 2
					attribute_diff = {
						who = event_target:treasure_fleet_commander
						attribute = intrigue
						value <= -5
					}
				}
				
				mult_modifier = {
					factor = 2
					attribute_diff = {
						who = event_target:treasure_fleet_commander
						attribute = intrigue
						value <= -10
					}
				}
				
				mult_modifier = {
					factor = 5
					has_character_flag = treasure_fleet_contingency_is_bad
				}
				
				character_event = { id = soh.9105 } # The attempt fails
			}
			
			50 = {
				mult_modifier = {
					factor = 2
					attribute_diff = {
						who = event_target:treasure_fleet_commander
						attribute = martial
						value >= 5
					}
				}
				
				mult_modifier = {
					factor = 2
					attribute_diff = {
						who = event_target:treasure_fleet_commander
						attribute = martial
						value >= 10
					}
				}
				
				mult_modifier = {
					factor = 2
					attribute_diff = {
						who = event_target:treasure_fleet_commander
						attribute = intrigue
						value >= 5
					}
				}
				
				mult_modifier = {
					factor = 2
					attribute_diff = {
						who = event_target:treasure_fleet_commander
						attribute = intrigue
						value >= 10
					}
				}
				
				mult_modifier = {
					factor = 5
					has_character_flag = treasure_fleet_planned_invasion
				}
				
				mult_modifier = {
					factor = 5
					has_character_flag = treasure_fleet_contingency_is_good
				}
				
				character_event = { id = soh.9109 } # The invasion commences
			}
		}
	}
}

# Ruler failed to launch a Treasure Fleet Invasion - ruler
character_event = {
	id = soh.9105
	desc = EVTDESC_SOH_9105
	picture = GFX_evt_into_the_dungeon
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes

	option = {
		name = EVTOPTA_SOH_9105 # I didn't mean anything by it! Honest!
		
		set_global_flag = treasure_fleet_invasion_failed_to_launch
		
		if = {
			limit = {
				has_dlc = "Jade Dragon"
			}
			
			if = { # If we have positive Grace, zero it out!
				limit = {
					check_variable = {
						which = grace
						value = 1
					}
				}
				
				set_variable = {
					which = grace
					value = 0
				}
			}
			
			detract_grace_super_huge_effect = yes # China is VERY upset with you for doing this!
			
			detract_grace_super_huge_effect = yes # China is VERY upset with you for doing this!
		}
		
		any_playable_ruler = {
			limit = {
				trait = treasure_fleet_voyage
				NOT = {
					has_character_flag = left_treasure_fleet_voyage
				}
				ai = no
			}
			
			character_event = { id = soh.9106 } # Inform other members
		}
	
		e_china = {
			holder_scope = {
				opinion = {
					who = ROOT
					modifier = opinion_traitor
				}
				
				ROOT = {
					imprison = PREV
					remove_trait = treasure_fleet_voyage
				}
			}
		}
		
		any_demesne_title = {
			e_china = {
				holder_scope = {
					add_claim = PREVPREV
				}
			}
		}
		
		e_china = {
			holder_scope = {
				character_event = { id = soh.9106 } # Inform the EoC
				any_realm_lord = {
					limit = {
						ai = no
						trait = treasure_fleet_voyage
						NOT = {
							has_character_flag = left_treasure_fleet_voyage
						}
					}
					
					character_event = { id = soh.9107 } # Inform people aboard the Treasure Fleet
				}
			}
		}
		
		any_independent_ruler = {
			limit = {
				is_chinese_emperor_trigger = no
				ai = no
			}
			
			character_event = { id = soh.9108 } # Inform the world
		}
		
		any_playable_ruler = {
			limit = {
				ai = no
				NOT = {
					character = ROOT
				}
				NAND = {
					trait = treasure_fleet_voyage
					NOT = {
						has_character_flag = left_treasure_fleet_voyage
					}
				}
				is_chinese_emperor_trigger = no
				any_liege = {
					is_chinese_emperor_trigger = yes
				}
			}
			
			character_event = { id = soh.9108 } # Inform the world
		}
	}
}

# Ruler failed to launch a Treasure Fleet Invasion - EoC
character_event = {
	id = soh.9106
	desc = EVTDESC_SOH_9106
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9106 # This is high treason!
	}
}

# Ruler failed to launch a Treasure Fleet Invasion - others aboard the Treasure Fleet
character_event = {
	id = soh.9107
	desc = EVTDESC_SOH_9107
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9107 # What an unexpected turn of events..
	}
}

# Ruler failed to launch a Treasure Fleet Invasion - rest of the world
character_event = {
	id = soh.9108
	desc = EVTDESC_SOH_9108
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9108 # What an unexpected turn of events...
	}
}

# Ruler successfully launched a Treasure Fleet Invasion - ruler
character_event = {
	id = soh.9109
	desc = EVTDESC_SOH_9109
	picture = GFX_evt_china_expansionist
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes

	option = {
		name = EVTOPTA_SOH_9109 # Everything is proceeding as I have foreseen!
		
		set_global_flag = treasure_fleet_invasion_failed_to_launch
		
		if = {
			limit = {
				has_dlc = "Jade Dragon"
			}
			
			if = { # If we have positive Grace, zero it out!
				limit = {
					check_variable = {
						which = grace
						value = 1
					}
				}
				
				set_variable = {
					which = grace
					value = 0
				}
			}
			
			detract_grace_super_huge_effect = yes # China is VERY upset with you for doing this!
			detract_grace_super_huge_effect = yes # China is VERY upset with you for doing this!
		}
		
		any_playable_ruler = {
			limit = {
				trait = treasure_fleet_voyage
				NOT = {
					has_character_flag = left_treasure_fleet_voyage
				}
				ai = no
			}
			
			character_event = { id = soh.9106 } # Inform other members
		}
	
		e_china = {
			holder_scope = {
				opinion = {
					who = ROOT
					modifier = opinion_traitor
				}
				random_realm_province = {
					save_event_target_as = tf_character_home_province
				}
			}
		}
		
		any_demesne_title = {
			e_china = {
				holder_scope = {
					add_claim = PREVPREV
				}
			}
		}
		
		event_target:potential_treasure_fleet_invasion_target_beachhead = {
			set_province_flag = treasure_fleet_invasion_target_beachhead
			
			kingdom = {
				save_event_target_as = treasure_fleet_invasion_kingdom
			}
			
			disembark_regiments_until_unable_to_continue_effect = yes
		}
		
		# Spawn a few good commanders, to make up for us having a regency...
		create_random_soldier = {
			age = 21
			female = no # TIANXIATODO: Base on view on gender?
			dynasty = none
			attributes = {
				diplomacy = 2
				martial = 7
				stewardship = 5
				intrigue = 4
				learning = 6
			}
			trait = skilled_tactician
			culture = event_target:tf_character_home_province
			religion = event_target:tf_character_home_province
			random_traits =	yes
		}
		
		create_random_soldier = {
			age = 32
			female = no # TIANXIATODO: Base on view on gender?
			dynasty = none
			attributes = {
				diplomacy = 2
				martial = 7
				stewardship = 5
				intrigue = 4
				learning = 6
			}
			trait = skilled_tactician
			culture = event_target:tf_character_home_province
			religion = event_target:tf_character_home_province
			random_traits =	yes
		}
		
		create_random_soldier = {
			age = 43
			female = no # TIANXIATODO: Base on view on gender?
			dynasty = none
			attributes = {
				diplomacy = 2
				martial = 7
				stewardship = 5
				intrigue = 4
				learning = 6
			}
			trait = skilled_tactician
			culture = event_target:tf_character_home_province
			religion = event_target:tf_character_home_province
			random_traits =	yes
		}
		
		war = {
			target = event_target:potential_treasure_fleet_invasion_target
			casus_belli = treasure_fleet_invasion
			thirdparty_title = event_target:treasure_fleet_invasion_kingdom
		}
		
		activate_title = {
			title = d_treasure_fleet
			status = no
		}
		
		e_china = {
			holder_scope = {
				character_event = { id = soh.9110 } # Inform the EoC
				any_realm_lord = {
					limit = {
						ai = no
						trait = treasure_fleet_voyage
						NOT = {
							has_character_flag = left_treasure_fleet_voyage
						}
					}
					
					character_event = { id = soh.9111 } # Inform people aboard the Treasure Fleet
				}
				
				any_realm_character = {
					limit = {
						ai = yes
						trait = treasure_fleet_voyage
						NOT = {
							has_character_flag = left_treasure_fleet_voyage
						}
					}
					
					character_event = { id = soh.7715 days = 90 random = 90 }
				}
			}
		}
		
		any_independent_ruler = {
			limit = {
				is_chinese_emperor_trigger = no
				ai = no
			}
			
			character_event = { id = soh.9112 } # Inform the world
		}
		
		any_playable_ruler = {
			limit = {
				ai = no
				NOT = {
					character = ROOT
				}
				NAND = {
					trait = treasure_fleet_voyage
					NOT = {
						has_character_flag = left_treasure_fleet_voyage
					}
				}
				is_chinese_emperor_trigger = no
				any_liege = {
					is_chinese_emperor_trigger = yes
				}
			}
			
			character_event = { id = soh.9112 } # Inform the world
		}
	}
}

# Ruler successfully launched a Treasure Fleet Invasion - EoC
character_event = {
	id = soh.9110
	desc = EVTDESC_SOH_9110
	picture = GFX_evt_china_expansionist
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9110 # That's treason!
		
		hidden_tooltip = {
			mandate_penalty_massive_effect = yes
		}
	}
}

# Ruler successfully launched a Treasure Fleet Invasion - others aboard the Treasure Fleet
character_event = {
	id = soh.9111
	desc = EVTDESC_SOH_9111
	picture = GFX_evt_china_expansionist
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9111 # That's treason!
		
		character_event = { id = soh.7715 days = 90 random = 90 } # Forced return home
	}
}

# Ruler successfully launched a Treasure Fleet Invasion - rest of the world
character_event = {
	id = soh.9112
	desc = EVTDESC_SOH_9112
	picture = GFX_evt_china_expansionist
	border = GFX_event_normal_frame_war
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9112 # What an unexpected turn of events...
	}
}

### Pacific voyage

# Hidden setup
province_event = {
	id = soh.9113
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		set_variable = {
			which = tf_head_home
			value = 0
		}
		set_variable = {
			which = tf_head_east
			value = 0
		}
		set_variable = {
			which = tf_penglai
			value = 0
		}
		set_variable = {
			which = tf_utter_east
			value = 0
		}
		set_variable = {
			which = tf_rlyeh
			value = 0
		}
		set_variable = {
			which = tf_zail_east
			value = 0
		}
		set_variable = {
			which = tf_yamatai
			value = 0
		}
		set_variable = {
			which = tf_atlantis
			value = 0
		}
		set_variable = {
			which = tf_kumari_kandam
			value = 0
		}
		set_variable = {
			which = tf_generic_east
			value = 0
		}
		
		# AI votes
		d_treasure_fleet = {
			holder_scope = {
				if = {
					limit = {
						OR = {
							trait = craven
							trait = content
						}
						NOR = {
							trait = ambitious
							trait = brave
							trait = lunatic
							trait = possessed
						}
					}
					
					ROOT = {
						change_variable = {
							which = tf_head_home
							value = 1
						}
					}
				}
				
				else = {
					if = {
						limit = {
							OR = {
								trait = lunatic
								trait = possessed
							}
						}
						
						ROOT = {
							change_variable = {
								which = tf_rlyeh
								value = 1
							}
						}
					}
					
					else_if = {
						limit = {
							religion = taoist
							OR = {
								trait = proud
								trait = ambitious
								has_ambition = obj_become_immortal
								trait = mystic
								# TIANXIATODO: Or that other thing...
							}
						}
						
						ROOT = {
							change_variable = {
								which = tf_penglai
								value = 1
							}
						}
					}
					
					else_if = {
						limit = {
							OR = {
								religion_group = christian
								religion_group = jewish_group
								religion_group = muslim
							}
						}
						
						ROOT = {
							change_variable = {
								which = tf_utter_east
								value = 1
							}
						}
					}
					
					else_if = {
						limit = {
							OR = {
								culture_group = japonic
								has_japanese_religion_trigger = yes
								religion_openly_ryukyuan_or_reformed_trigger = yes
							}
						}
						
						ROOT = {
							change_variable = {
								which = tf_yamatai
								value = 1
							}
						}
					}
					
					else_if = {
						limit = {
							OR = {
								culture = greek
								religion_openly_hellenic_or_reformed_trigger = yes
							}
							NOT = {
								has_global_flag = atlantis_lost
							}
						}
						
						ROOT = {
							change_variable = {
								which = tf_atlantis
								value = 1
							}
						}
					}
					
					else_if = {
						limit = {
							culture = tamil
						}
						
						ROOT = {
							change_variable = {
								which = tf_kumari_kandam
								value = 1
							}
						}
					}
					
					else_if = {
						limit = {
							NOT = {
								has_game_rule = {
									name = supernatural_events
									value = off
								}
							}
						}
						
						ROOT = {
							change_variable = {
								which = tf_zail_east
								value = 1
							}
						}
					}
					
					else = {
						set_variable = {
							which = tf_generic_east
							value = 0
						}
					}
				}
			}
		}
		
		e_china = {
			holder_scope = {
				any_realm_character = {
					limit = {
						ai = yes
						trait = treasure_fleet_voyage
						NOT = {
							has_character_flag = left_treasure_fleet_voyage
						}
					}
					
					if = {
						limit = {
							OR = {
								trait = craven
								trait = content
							}
							NOR = {
								trait = ambitious
								trait = brave
								trait = lunatic
								trait = possessed
							}
						}
						
						ROOT = {
							change_variable = {
								which = tf_head_home
								value = 1
							}
						}
					}
					
					else = {
						if = {
							limit = {
								OR = {
									trait = lunatic
									trait = possessed
								}
								NOT = {
									has_game_rule = {
										name = supernatural_events
										value = off
									}
								}
							}
							
							ROOT = {
								change_variable = {
									which = tf_rlyeh
									value = 1
								}
							}
						}
						
						else_if = {
							limit = {
								religion = taoist
								OR = {
									trait = proud
									trait = ambitious
									has_ambition = obj_become_immortal
									trait = mystic
									# TIANXIATODO: Or that other thing...
								}
							}
							
							ROOT = {
								change_variable = {
									which = tf_penglai
									value = 1
								}
							}
						}
						
						else_if = {
							limit = {
								OR = {
									religion_group = christian
									religion_group = jewish_group
									religion_group = muslim
								}
								NOT = {
									has_game_rule = {
										name = supernatural_events
										value = off
									}
								}
							}
							
							ROOT = {
								change_variable = {
									which = tf_utter_east
									value = 1
								}
							}
						}
						
						else_if = {
							limit = {
								OR = {
									culture_group = japonic
									has_japanese_religion_trigger = yes
									religion_openly_ryukyuan_or_reformed_trigger = yes
								}
							}
							
							ROOT = {
								change_variable = {
									which = tf_yamatai
									value = 1
								}
							}
						}
						
						else_if = {
							limit = {
								OR = {
									culture = greek
									religion_openly_hellenic_or_reformed_trigger = yes
								}
								NOT = {
									has_global_flag = atlantis_lost
								}
							}
							
							ROOT = {
								change_variable = {
									which = tf_atlantis
									value = 1
								}
							}
						}
						
						else_if = {
							limit = {
								culture = tamil
							}
							
							ROOT = {
								change_variable = {
									which = tf_kumari_kandam
									value = 1
								}
							}
						}
						
						else_if = {
							limit = {
								NOT = {
									has_game_rule = {
										name = supernatural_events
										value = off
									}
								}
							}
							
							ROOT = {
								change_variable = {
									which = tf_zail_east
									value = 1
								}
							}
						}
						
						else = {
							set_variable = {
								which = tf_generic_east
								value = 0
							}
						}
					}
				}
				
				any_realm_lord = {
					limit = {
						ai = no
						trait = treasure_fleet_voyage
						NOT = {
							has_character_flag = left_treasure_fleet_voyage
						}
					}
					
					character_event = { id = soh.9114 } # Players vote
				}
			}
		}
		
		province_event = { id = soh.9115 days = 5 } # Determine the outcome
	}
}

# Treasure Fleet in Java - what lies further east?
character_event = {
	id = soh.9114
	desc = EVTDESC_SOH_9114
	picture = GFX_evt_chinese_bureaucrat
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				OR = {
					trait = lunatic
					trait = possessed
				}
			}
			
			set_character_flag = treasure_fleet_vote_rlyeh
		}
		
		if = {
			limit = {
				religion = taoist
			}
			
			set_character_flag = treasure_fleet_vote_penglai
		}
		
		if = {
			limit = {
				has_global_flag = treasure_fleet_lost_east
			}
			
			set_character_flag = treasure_fleet_vote_lost_fleet
		}
		
		if = {
			limit = {
				OR = {
					culture_group = japonic
					has_japanese_religion_trigger = yes
					religion_openly_ryukyuan_or_reformed_trigger = yes
				}
			}
			
			set_character_flag = treasure_fleet_vote_yamatai
		}
		
		if = {
			limit = {
				culture = tamil
			}
			
			set_character_flag = treasure_fleet_vote_kumari_kandam
		}
		
		if = {
			limit = {
				OR = {
					culture = greek
					religion_openly_hellenic_or_reformed_trigger = yes
				}
				NOT = {
					has_global_flag = atlantis_lost
				}
			}
			
			set_character_flag = treasure_fleet_vote_atlantis
		}
		
		if = {
			limit = {
				OR = {
					religion_group = christian
					religion_group = jewish_group
					religion_group = muslim
				}
				NOT = {
					has_game_rule = {
						name = supernatural_events
						value = off
					}
				}
			}
			
			set_character_flag = treasure_fleet_vote_utter_east
		}
		
		if = {
			limit = {
				NOT = {
					has_game_rule = {
						name = supernatural_events
						value = off
					}
				}
			}
			
			set_character_flag = treasure_fleet_vote_zail_east
		}
	}
	
	option = {
		trigger = {
			NOT = {
				has_character_flag = vote_rlyeh
			}
		}
		
		name = EVTOPTA_SOH_9114 # I want to head home!
		
		hidden_tooltip = {
			FROM = {
				change_variable = {
					which = tf_head_home
					value = 10
				}
			}
		}
	}
	
	option = {
		trigger = {
			has_character_flag = vote_rlyeh
		}
		
		name = EVTOPTB_SOH_9114 # THE STARS ARE ALMOST RIGHT!
		
		hidden_tooltip = {
			FROM = {
				change_variable = {
					which = tf_rlyeh
					value = 10
				}
			}
		}
	}
	
	option = {
		trigger = {
			has_character_flag = vote_penglai
			NOT = {
				has_character_flag = vote_rlyeh
			}
		}
		
		name = EVTOPTC_SOH_9114 # We should search for Mount Penglai!
		
		hidden_tooltip = {
			FROM = {
				change_variable = {
					which = tf_penglai
					value = 10
				}
			}
		}
	}
	
	option = {
		trigger = {
			has_character_flag = vote_yamatai
			NOT = {
				has_character_flag = vote_rlyeh
			}
		}
		
		name = EVTOPTD_SOH_9114 # I have heard tales of a mysterious queen to the east...
		
		hidden_tooltip = {
			FROM = {
				change_variable = {
					which = tf_yamatai
					value = 10
				}
			}
		}
	}
	
	option = {
		trigger = {
			has_character_flag = vote_kumari_kandam
			NOT = {
				has_character_flag = vote_rlyeh
			}
		}
		
		name = EVTOPTE_SOH_9114 # I have heard tales of a mysterious land...
		
		hidden_tooltip = {
			FROM = {
				change_variable = {
					which = tf_kumari_kandam
					value = 10
				}
			}
		}
	}
	
	option = {
		trigger = {
			has_character_flag = vote_atlantis
			NOT = {
				has_character_flag = vote_rlyeh
			}
		}
		
		name = EVTOPTF_SOH_9114 # I have heard tales of lost continents...
		
		hidden_tooltip = {
			FROM = {
				change_variable = {
					which = tf_atlantis
					value = 10
				}
			}
		}
	}
	
	option = {
		trigger = {
			has_character_flag = vote_utter_east
			NOT = {
				has_character_flag = vote_rlyeh
			}
		}
		
		name = EVTOPTG_SOH_9114 # I have heard tales of the Utter East...
		
		hidden_tooltip = {
			FROM = {
				change_variable = {
					which = tf_utter_east
					value = 10
				}
			}
		}
	}
	
	option = {
		trigger = {
			has_character_flag = vote_zail_east
			NOT = {
				has_character_flag = vote_rlyeh
			}
		}
		
		name = EVTOPTH_SOH_9114 # I have heard tales of a great silence...
		
		hidden_tooltip = {
			FROM = {
				change_variable = {
					which = tf_utter_east
					value = 10
				}
			}
		}
	}
	
	option = {
		trigger = {
			NOT = {
				has_character_flag = vote_rlyeh
			}
		}
		
		name = EVTOPTI_SOH_9114 # I want to head east, for no particular reason
		
		hidden_tooltip = {
			FROM = {
				change_variable = {
					which = tf_generic_east
					value = 10
				}
			}
		}
	}
}

# Determine the outcome and decide where the Treasure Fleet heads if it heads east
province_event = {
	id = soh.9115
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		change_variable = {
			which = tf_head_east
			which = tf_penglai
		}
		change_variable = {
			which = tf_head_east
			which = tf_utter_east
		}
		change_variable = {
			which = tf_head_east
			which = tf_rlyeh
		}
		change_variable = {
			which = tf_head_east
			which = tf_zail_east
		}
		change_variable = {
			which = tf_head_east
			which = tf_yamatai
		}
		change_variable = {
			which = tf_head_east
			which = tf_atlantis
		}
		change_variable = {
			which = tf_head_east
			which = tf_kumari_kandam
		}
		change_variable = {
			which = tf_head_east
			which = tf_generic_east
		}
		
		if = {
			limit = {
				check_variable = {
					which = tf_head_east
					which = tf_head_home
				}
			}
				
			clr_global_flag = treasure_fleet_voyage
			set_global_flag = treasure_fleet_eastern_islands
			clr_province_flag = treasure_fleet_in_java
			
			# Determine where the Treasure Fleet will end up (assuming it isn't destroyed along the way...)
			random_list = {
				10 = {
					trigger = {
						NOT = {
							has_game_rule = {
								name = supernatural_events
								value = off
							}
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_penglai
							value >= 10
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_penglai
							value >= 20
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_penglai
							value >= 50
						}
					}
					
					set_global_flag = treasure_fleet_will_arrive_at_penglai
				}
				
				10 = {
					trigger = {
						NOT = {
							has_game_rule = {
								name = supernatural_events
								value = off
							}
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_utter_east
							value >= 10
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_utter_east
							value >= 20
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_utter_east
							value >= 50
						}
					}
					
					set_global_flag = treasure_fleet_will_arrive_at_utter_east
				}
				
				10 = {
					trigger = {
						NOT = {
							has_game_rule = {
								name = supernatural_events
								value = off
							}
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_rlyeh
							value >= 10
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_rlyeh
							value >= 20
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_rlyeh
							value >= 50
						}
					}
					
					set_global_flag = treasure_fleet_will_arrive_at_rlyeh
				}
				
				10 = {
					trigger = {
						NOT = {
							has_game_rule = {
								name = supernatural_events
								value = off
							}
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_zail_east
							value >= 10
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_zail_east
							value >= 20
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_zail_east
							value >= 50
						}
					}
					
					set_global_flag = treasure_fleet_will_arrive_at_salt
				}
				
				10 = {
					trigger = {
						NOT = {
							has_game_rule = {
								name = supernatural_events
								value = off
							}
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_yamatai
							value >= 10
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_yamatai
							value >= 20
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_yamatai
							value >= 50
						}
					}
					
					set_global_flag = treasure_fleet_will_arrive_at_yamatai
				}
				
				10 = {
					trigger = {
						NOT = {
							has_game_rule = {
								name = supernatural_events
								value = off
							}
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_atlantis
							value >= 10
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_atlantis
							value >= 20
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_atlantis
							value >= 50
						}
					}
					
					set_global_flag = treasure_fleet_will_arrive_at_atlantis
				}
				
				10 = {
					trigger = {
						NOT = {
							has_game_rule = {
								name = supernatural_events
								value = off
							}
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_kumari_kandam
							value >= 10
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_kumari_kandam
							value >= 20
						}
					}
					
					mult_modifier = {
						factor = 2
						check_variable = {
							which = tf_kumari_kandam
							value >= 50
						}
					}
					
					set_global_flag = treasure_fleet_will_arrive_at_kumari_kandam
				}
				
				10 = {
					mult_modifier = {
						factor = 1.5
						check_variable = {
							which = tf_generic_east
							value >= 10
						}
					}
					
					mult_modifier = {
						factor = 1.5
						check_variable = {
							which = tf_generic_east
							value >= 20
						}
					}
					
					mult_modifier = {
						factor = 1.5
						check_variable = {
							which = tf_generic_east
							value >= 50
						}
					}
					
					set_global_flag = treasure_fleet_will_arrive_at_nazca
				}
			}
		
			any_playable_ruler = {
				limit = {
					ai = no
					trait = treasure_fleet_voyage
					NOT = {
						has_character_flag = left_treasure_fleet_voyage
					}
				}
				
				if = {
					limit = {
						NOT = {
							has_character_flag = treasure_fleet_abort
						}
					}
					
					character_event = { id = soh.9120 }
				}
				
				else = {
					character_event = { id = soh.9121 }
				}
			}
			
			any_playable_ruler = {
				limit = {
					ai = no
					can_interact_with_treasure_fleet_trigger = yes
				}
				
				character_event = { id = soh.9122 }
			}
			
			e_china = {
				holder_scope = {
					character_event = { id = soh.9123 }
				}
			}
		}
		
		else = {
			any_playable_ruler = {
				limit = {
					ai = no
					trait = treasure_fleet_voyage
					NOT = {
						has_character_flag = left_treasure_fleet_voyage
					}
				}
				
				if = {
					limit = {
						NOT = {
							has_character_flag = treasure_fleet_abort
						}
					}
					
					character_event = { id = soh.9116 }
				}
				
				else = {
					character_event = { id = soh.9117 }
				}
			}
			
			any_playable_ruler = {
				limit = {
					ai = no
					can_interact_with_treasure_fleet_trigger = yes
				}
				
				character_event = { id = soh.9118 }
			}
			
			e_china = {
				holder_scope = {
					character_event = { id = soh.9119 }
				}
			}
			
			province_event = { id = soh.9102 days = 1 } # Head home
		}
	}
}

# Vote fails - Treasure Fleet heads home - members not heading home on their own
character_event = {
	id = soh.9116
	desc = EVTDESC_SOH_9116
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9116 # That's that...
	}
}

# Vote fails - Treasure Fleet heads home - members heading home on their own
character_event = {
	id = soh.9117
	desc = EVTDESC_SOH_9117
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9117 # That's that...
	}
}

# Vote fails - Treasure Fleet heads home - locals
character_event = {
	id = soh.9118
	desc = EVTDESC_SOH_9118
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9118 # That's that...
	}
}

# Vote fails - Treasure Fleet heads home - EoC
character_event = {
	id = soh.9119
	desc = EVTDESC_SOH_9119
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9119 # That's that...
	}
}

# Vote passes - Treasure Fleet heads east - members not heading home
character_event = {
	id = soh.9120
	desc = EVTDESC_SOH_9120
	picture = GFX_evt_tropicana
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9120 # East it is!
	}
	
	option = {
		trigger = {
			ai = no
		}
		
		name = EVTOPTB_SOH_9120 # Actually, I think I'll head home...
		
		set_character_flag = left_treasure_fleet_voyage
		
		any_child = {
			limit = {
				is_landed = no
				trait = treasure_fleet_voyage
				age < 10
			}
			set_character_flag = left_treasure_fleet_voyage
		
			character_event = { id = soh.7713 days = 181 } # One day after maximum for parent, in case parent dies
		}
		
		character_event = { id = soh.7713 days = 90 random = 90 }
	}
}

# Vote passes - Treasure Fleet heads east - members heading home on their own
character_event = {
	id = soh.9121
	desc = EVTDESC_SOH_9121
	picture = GFX_evt_tropicana
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9121 # East it is!
		
		clr_character_flag = treasure_fleet_abort
	}
	
	option = {
		trigger = {
			ai = no
		}
		
		name = EVTOPTB_SOH_9121 # I'll be leaving, then...
		
		set_character_flag = left_treasure_fleet_voyage
		
		any_child = {
			limit = {
				is_landed = no
				trait = treasure_fleet_voyage
				age < 10
			}
			set_character_flag = left_treasure_fleet_voyage
		
			character_event = { id = soh.7713 days = 181 } # One day after maximum for parent, in case parent dies
		}
		
		character_event = { id = soh.7713 days = 90 random = 90 }
	}
}

# Vote passes - Treasure Fleet heads east - locals
character_event = {
	id = soh.9122
	desc = EVTDESC_SOH_9122
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9123 # I wonder what they'll find...
	}
}

# Vote passes - Treasure Fleet heads east - EoC
character_event = {
	id = soh.9123
	desc = EVTDESC_SOH_9123
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_intrigue
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9123 # I wonder what they'll find...
	}
}

### Departure - heading home

# Set up follow-up events
province_event = {
	id = soh.9124
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				# TODO: Any local province has a disease
				always = no
			}
			
			d_treasure_fleet = {
				holder_scope = {
					character_event = { id = soh.9134 days = 5 random = 2 } # Illness
					any_courtier = {
						limit = {
							trait = treasure_fleet_voyage
						}
						
						random = {
							chance = 1
							character_event = { id = soh.9135 days = 2 random = 1 } # Fell behind
						}
						
						random = {
							chance = 25
							character_event = { id = soh.9134 days = 5 random = 2 } # Illness
						}
					}
				}
			}
			
			e_china = {
				holder_scope = {
					any_realm_character = {
						limit = {
							trait = treasure_fleet_voyage
							NOT = {
								has_character_flag = left_treasure_fleet_voyage
							}
						}
						
						if = {
							limit = {
								is_landed = no
							}
							
							random = {
								chance = 2
								character_event = { id = soh.9135 days = 2 random = 1 } # Fell behind
							}
						}
						
						random = {
							chance = 25
							character_event = { id = soh.9134 days = 5 random = 2 } # Illness
						}
					}
				}
			}
		}
		
		any_playable_ruler = {
			limit = {
				ai = no
				trait = treasure_fleet_voyage
				NOT = {
					has_character_flag = left_treasure_fleet_voyage
				}
			}
			
			if = {
				limit = {
					NOT = {
						has_character_flag = treasure_fleet_abort
					}
				}
				
				character_event = { id = soh.9125 }
			}
			
			else = {
				character_event = { id = soh.9126 }
			}
		}
		
		any_playable_ruler = {
			limit = {
				ai = no
				can_interact_with_treasure_fleet_trigger = yes
			}
			
			character_event = { id = soh.9127 }
		}
		
		e_china = {
			holder_scope = {
				character_event = { id = soh.9128 }
			}
		}
	}
}

# Treasure Fleet heads home - members not heading home on their own
character_event = {
	id = soh.9125
	desc = EVTDESC_SOH_9125
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9125 # We head home together!
	}
}

# Treasure Fleet heads home - members heading home on their own
character_event = {
	id = soh.9126
	desc = EVTDESC_SOH_9126
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9126 # We head home together!
		
		clr_character_flag = treasure_fleet_abort
	}
	
	option = {
		trigger = {
			ai = no
		}
		
		name = EVTOPTB_SOH_9126 # I'll be heading home on my own...
		
		set_character_flag = left_treasure_fleet_voyage
		
		any_child = {
			limit = {
				is_landed = no
				trait = treasure_fleet_voyage
				age < 10
			}
			set_character_flag = left_treasure_fleet_voyage
		
			character_event = { id = soh.7713 days = 181 } # One day after maximum for parent, in case parent dies
		}
		
		character_event = { id = soh.7713 days = 90 random = 90 }
	}
}

# Treasure Fleet heads home - locals
character_event = {
	id = soh.9127
	desc = EVTDESC_SOH_9127
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9127 # That's that...
	}
}

# Treasure Fleet heads home - EoC
character_event = {
	id = soh.9128
	desc = EVTDESC_SOH_9128
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9128 # Good to know!
	}
}

### Departure - continuing further away

# Set up follow-up events
province_event = {
	id = soh.9129
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		if = {
			limit = {
				# TODO: Any local province has a disease
				always = no
			}
			
			d_treasure_fleet = {
				holder_scope = {
					character_event = { id = soh.9134 days = 5 random = 2 } # Illness
					
					any_courtier = {
						limit = {
							trait = treasure_fleet_voyage
						}
						
						random = {
							chance = 1
							character_event = { id = soh.9135 days = 2 random = 1 } # Fell behind
						}
						
						random = {
							chance = 25
							character_event = { id = soh.9134 days = 5 random = 2 } # Illness
						}
					}
				}
			}
			
			e_china = {
				holder_scope = {
					any_realm_character = {
						limit = {
							trait = treasure_fleet_voyage
							NOT = {
								has_character_flag = left_treasure_fleet_voyage
							}
						}
						
						if = {
							limit = {
								is_landed = no
							}
							
							random = {
								chance = 2
								character_event = { id = soh.9135 days = 2 random = 1 } # Fell behind
							}
						}
						
						random = {
							chance = 25
							character_event = { id = soh.9134 days = 5 random = 2 } # Illness
						}
					}
				}
			}
		}
		any_playable_ruler = {
			limit = {
				ai = no
				trait = treasure_fleet_voyage
				NOT = {
					has_character_flag = left_treasure_fleet_voyage
				}
			}
			
			if = {
				limit = {
					NOT = {
						has_character_flag = treasure_fleet_abort
					}
				}
				
				character_event = { id = soh.9130 }
			}
			
			else = {
				character_event = { id = soh.9131 }
			}
		}
		
		any_playable_ruler = {
			limit = {
				ai = no
				can_interact_with_treasure_fleet_trigger = yes
			}
			
			character_event = { id = soh.9132 }
		}
		
		e_china = {
			holder_scope = {
				character_event = { id = soh.9133 }
			}
		}
	}
}

# Treasure Fleet heads further away - members not heading home
character_event = {
	id = soh.9130
	desc = EVTDESC_SOH_9130
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9125 # Onwards!
		
		clr_character_flag = treasure_fleet_abort
	}
}

# Treasure Fleet heads further away - members heading home on their own
character_event = {
	id = soh.9131
	desc = EVTDESC_SOH_9131
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9131 # Onwards!
		
		clr_character_flag = treasure_fleet_abort
	}
	
	option = {
		trigger = {
			ai = no
		}
		
		name = EVTOPTB_SOH_9131 # I'll be heading home...
		
		set_character_flag = left_treasure_fleet_voyage
		
		any_child = {
			limit = {
				is_landed = no
				trait = treasure_fleet_voyage
				age < 10
			}
			set_character_flag = left_treasure_fleet_voyage
		
			character_event = { id = soh.7713 days = 181 } # One day after maximum for parent, in case parent dies
		}
		
		character_event = { id = soh.7713 days = 90 random = 90 }
	}
}

# Treasure Fleet heads further away - locals
character_event = {
	id = soh.9132
	desc = EVTDESC_SOH_9132
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9132 # That's that...
	}
}

# Treasure Fleet heads further away - EoC
character_event = {
	id = soh.9133
	desc = EVTDESC_SOH_9133
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9133 # Good to know!
	}
}

### Shared normal departure events

# Character starts feeling ill
character_event = {
	id = soh.9134
	desc = EVTDESC_SOH_9134
	picture = GFX_evt_treasure_fleet
	border = GFX_event_normal_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9134 # I feel unwell...
		
		# TODO: Add appropriate illness; might need to flag in previous event...
	}
}

# Courtier failed to get to the ships in time - courtier
character_event = {
	id = soh.9135
	hide_window = yes
	
	is_triggered_only = yes
	
	trigger = {
		is_landed = no
	}
	
	immediate = {
		random_list = {
			25 = {
				death = {
					death_reason = death_missing
				}
			}
			
			25 = {
				set_character_flag = left_treasure_fleet_voyage
				character_event = { id = soh.7713 days = 90 random = 90 }
			}
			
			50 = {
				# TIANXIATODO: Select local ruler; might need to flag them somehow in the previous event
				character_event = { id = soh.9136 } # Local ruler informed
			}
		}
	}
}

# Local ruler informed of courtier that was stranded
character_event = {
	id = soh.9136
	desc = EVTDESC_SOH_9136
	picture = GFX_evt_emissary
	border = GFX_event_normal_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_9136 # I'll help you on your way!
		
		wealth = -25
		
		if = {
			limit = {
				has_dlc = "Jade Dragon"
				NOT = {
					has_global_flag = abort_treasure_fleet_asap
				}
			}
			
			add_grace_minor_effect = yes
		}
		
		FROM = {
			set_character_flag = left_treasure_fleet_voyage
		
			any_child = {
				limit = {
					is_landed = no
					trait = treasure_fleet_voyage
					age < 10
				}
				set_character_flag = left_treasure_fleet_voyage
			
				character_event = { id = soh.7713 days = 181 } # One day after maximum for parent, in case parent dies
			}
			
			character_event = { id = soh.7713 days = 90 random = 90 }
		}
		
		ai_chance = {
			trigger = {
				NOT = {
					is_rival = FROM
				}
			}
			
			factor = 100
		}
	}
	
	option = {
		name = EVTOPTB_SOH_9136 # You should stay here!
		
		FROM = {
			move_character = ROOT
			force_host = ROOT
			remove_trait = treasure_fleet_voyage
		
			any_child = {
				limit = {
					is_landed = no
					trait = treasure_fleet_voyage
					age < 10
				}
				
				move_character = ROOT
				force_host = ROOT
				remove_trait = treasure_fleet_voyage
			}
		}
		
		ai_chance = {
			factor = 100
			
			mult_modifier = {
				factor = 0.1
				NOR = {
					is_friend = FROM
					is_lover = FROM
				}
			}
		}
	}
	
	option = {
		trigger = {
			NOR = {
					is_friend = FROM
					is_lover = FROM
			}
		}
		
		name = EVTOPTC_SOH_9136 # You can stay... in the dungeon!
		
		FROM = {
			remove_trait = treasure_fleet_voyage
			imprison = ROOT
		
			any_child = {
				limit = {
					is_landed = no
					trait = treasure_fleet_voyage
					age < 10
				}
				
				imprison = ROOT
				remove_trait = treasure_fleet_voyage
			}
		}
		
		if = {
			limit = {
				has_dlc = "Jade Dragon"
				NOT = {
					has_global_flag = abort_treasure_fleet_asap
				}
			}
			
			detract_grace_minor_effect = yes # TODO: Appropriate penalty depending on who it is
		}
		
		ai_chance = {
			trigger = {
				NOT = {
					trait = kind
				}
			}
			
			factor = 100
			
			mult_modifier = {
				factor = 0.1
				NOT = {
					is_rival = FROM
				}
			}
		}
	}
	
	option = {
		trigger = {
			is_rival = FROM
		}
		
		name = EVTOPTD_SOH_9136 # And they were never seen again...
		
		piety = -25
		
		FROM = {
			death = {
				death_reason = death_murder_unknown
				killer = ROOT
			}
		
			any_child = {
				limit = {
					is_landed = no
					trait = treasure_fleet_voyage
					age < 10
				}
				
				death = {
					death_reason = death_murder_unknown
					killer = ROOT
				}
			}
		}
		
		ai_chance = {
			trigger = {
				trait = cruel
			}
			
			factor = 100
		}
	}
}