# Misc Grace events
# By Silverswee(e)per

namespace = soh

# soh.6401-6500 reserved

# Partially inspired by JD logic; MUST be JD-locked

# TODO: AI logic for event options
# TODO: Opinion modifiers
# TODO: Scripted triggers and effects
# TODO: Localization
# TODO: Testing



##### Misc

### Yearly Grace for tributaries

# on_yearly_pulse event granting Grace
character_event = {
	id = soh.6401
	hide_window = yes
	
	is_triggered_only = yes
	
	only_playable = yes
	only_independent = yes
	has_dlc = "Jade Dragon"
	
	trigger = {
		suzerain = {
			is_chinese_emperor_trigger = yes
		}
		NOT = {
			government = chinese_imperial_government
		}
	}
	
	immediate = {
		set_character_flag = grace_character
		if = {
			limit = {
				is_tributary = {
					type = chinese_client_state
				}
			}
			if = {
				limit = {
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
						}
						controls_religion = yes
					}
				}
				change_variable = {
					which = grace
					value = 48
				}
			}
			else_if = {
				limit = {
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = yes
						}
						real_tier = king
					}
				}
				change_variable = {
					which = grace
					value = 36
				}
			}
			else_if = {
				limit = {
					real_tier = duke
				}
				change_variable = {
					which = grace
					value = 24
				}
			}
			else = {
				change_variable = {
					which = grace
					value = 12
				}
			}
		}
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_protectorate
				}
			}
			if = {
				limit = {
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
						}
						controls_religion = yes
					}
				}
				change_variable = {
					which = grace
					value = 36
				}
			}
			else_if = {
				limit = {
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = yes
						}
						real_tier = king
					}
				}
				change_variable = {
					which = grace
					value = 27
				}
			}
			else_if = {
				limit = {
					real_tier = duke
				}
				change_variable = {
					which = grace
					value = 18
				}
			}
			else = {
				change_variable = {
					which = grace
					value = 9
				}
			}
		}
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_imperial_tributary
				}
			}
			if = {
				limit = {
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
						}
						controls_religion = yes
					}
				}
				change_variable = {
					which = grace
					value = 24
				}
			}
			else_if = {
				limit = {
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = yes
						}
						real_tier = king
					}
				}
				change_variable = {
					which = grace
					value = 18
				}
			}
			else_if = {
				limit = {
					real_tier = duke
				}
				change_variable = {
					which = grace
					value = 12
				}
			}
			else = {
				change_variable = {
					which = grace
					value = 6
				}
			}
		}
		else = {
			if = {
				limit = {
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
						}
						controls_religion = yes
					}
				}
				change_variable = {
					which = grace
					value = 12
				}
			}
			else_if = {
				limit = {
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = yes
						}
						real_tier = king
					}
				}
				change_variable = {
					which = grace
					value = 9
				}
			}
			else_if = {
				limit = {
					real_tier = duke
				}
				change_variable = {
					which = grace
					value = 6
				}
			}
			else = {
				change_variable = {
					which = grace
					value = 3
				}
			}
		}
	}
}

### Yearly Grace for vassals

# on_yearly_pulse event granting Grace
character_event = {
	id = soh.6402
	hide_window = yes
	
	is_triggered_only = yes
	
	only_playable = yes
	has_dlc = "Jade Dragon"
	
	trigger = {
		top_liege = {
			is_chinese_emperor_trigger = yes
		}
		NOT = {
			government = chinese_imperial_government
		}
	}
	
	immediate = {
		set_character_flag = grace_character
		if = {
			limit = {
				OR = {
					real_tier = king
					controls_religion = yes
				}
			}
			change_variable = {
				which = grace
				value = 36
			}
		}
		else_if = {
			limit = {
				real_tier = duke
			}
			change_variable = {
				which = grace
				value = 24
			}
		}
		else = {
			change_variable = {
				which = grace
				value = 12
			}
		}
	}
}

### Grace penalties for usurpation

# on_new_holder_usurpation - rel head title or king+
character_event = {
	id = soh.6403
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		FROMFROM = {
			OR = {
				is_chinese_emperor_trigger = yes
				any_dynasty_member = {
					is_chinese_emperor_trigger = yes
				}
			}
		}
		NOR = {
			is_chinese_emperor_trigger = yes
			any_dynasty_member = {
				is_chinese_emperor_trigger = yes
			}
		}
		FROM = {
			OR = {
				tier = emperor
				tier = king
				controls_religion = yes
			}
		}
	}
	
	immediate = {
		if = {
			limit = {
				FROMFROM = {
					is_chinese_emperor_trigger = yes
				}
			}
			detract_grace_super_huge_effect = yes
		}
		else_if = {
			limit = {
				FROMFROM = {
					any_close_relative = {
						dynasty = PREV
						is_chinese_emperor_trigger = yes
					}
				}
			}
			detract_grace_massive_effect = yes
		}
	}
}

# on_new_holder_usurpation - duchy
character_event = {
	id = soh.6404
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		FROMFROM = {
			OR = {
				is_chinese_emperor_trigger = yes
				any_dynasty_member = {
					is_chinese_emperor_trigger = yes
				}
			}
		}
		NOR = {
			is_chinese_emperor_trigger = yes
			any_dynasty_member = {
				is_chinese_emperor_trigger = yes
			}
		}
		FROM = {
			tier = duke
			controls_religion = no
		}
	}
	
	immediate = {
		if = {
			limit = {
				FROMFROM = {
					is_chinese_emperor_trigger = yes
				}
			}
			detract_grace_massive_effect = yes
		}
		else_if = {
			limit = {
				FROMFROM = {
					any_close_relative = {
						dynasty = PREV
						is_chinese_emperor_trigger = yes
					}
				}
			}
			detract_grace_major_effect = yes
		}
	}
}

# on_new_holder_usurpation - county
character_event = {
	id = soh.6405
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		FROMFROM = {
			OR = {
				is_chinese_emperor_trigger = yes
				any_dynasty_member = {
					is_chinese_emperor_trigger = yes
				}
			}
		}
		NOR = {
			is_chinese_emperor_trigger = yes
			any_dynasty_member = {
				is_chinese_emperor_trigger = yes
			}
		}
		FROM = {
			tier = county
		}
	}
	
	immediate = {
		if = {
			limit = {
				FROMFROM = {
					is_chinese_emperor_trigger = yes
				}
			}
			detract_grace_major_effect = yes
		}
		else_if = {
			limit = {
				FROMFROM = {
					any_close_relative = {
						dynasty = PREV
						is_chinese_emperor_trigger = yes
					}
				}
			}
			detract_grace_medium_effect = yes
		}
	}
}

### Grace penalties for divorce

# on_divorce penaltiy
character_event = {
	id = soh.6406
	is_triggered_only = yes
	hide_window = yes
	
	has_dlc = "Jade Dragon"
	
	trigger = {
		OR = {
			is_chinese_emperor_trigger = yes
			any_dynasty_member = {
				is_chinese_emperor_trigger = yes
			}
		}
		NOT = {
			FROM = {
				is_chinese_emperor_trigger = yes
			}
		}
	}
	
	immediate = {
		if = {
			limit = {
				is_chinese_emperor_trigger = yes
			}
			FROM = {
				detract_grace_super_huge_effect = yes
			}
		}
		else_if = {
			limit = {
				any_close_relative = {
					dynasty = ROOT
					is_chinese_emperor_trigger = yes
				}
			}
			FROM = {
				detract_grace_massive_effect = yes
			}
		}
	}
}

### Grace penalties for imprisonment

# on_become_imprisoned_any_reason event penalizing imprisonment of the EoC and his relatives
character_event = {
	id = soh.6407
	is_triggered_only = yes
	hide_window = yes
	
	trigger = {
		OR = {
			is_chinese_emperor_trigger = yes
			any_dynasty_member = {
				is_chinese_emperor_trigger = yes
			}
		}
		NOT = {
			FROM = {
				is_chinese_emperor_trigger = yes
			}
		}
	}
	
	immediate = {
		if = {
			limit = {
				is_chinese_emperor_trigger = yes
			}
			FROM = {
				detract_grace_super_huge_effect = yes
			}
		}
		else_if = {
			limit = {
				any_close_relative = {
					dynasty = ROOT
					is_chinese_emperor_trigger = yes
				}
			}
			FROM = {
				detract_grace_massive_effect = yes
			}
		}
	}
}

### Chinese Princess setup + updates

# on_startup for the EoC
character_event = {
	id = soh.6408
	hide_window = yes
	
	is_triggered_only = yes
	
	has_dlc = "Jade Dragon"
	only_playable = yes
	only_independent = yes
	
	trigger = {
		is_chinese_emperor_trigger = yes
	}
	
	immediate = {
		set_up_chinese_dynasty_effect = yes
	}
}

# on_yearly_pulse for the EoC
character_event = {
	id = soh.6409
	hide_window = yes
	
	is_triggered_only = yes
	
	has_dlc = "Jade Dragon"
	only_playable = yes
	only_independent = yes
	
	trigger = {
		is_chinese_emperor_trigger = yes
	}
	
	immediate = {
		set_up_chinese_dynasty_effect = yes
	}
}

# on_birth
character_event = {
	id = soh.6410
	hide_window = yes
	
	is_triggered_only = yes
	
	has_dlc = "Jade Dragon"
	only_women = yes
	
	trigger = {
		e_china = {
			has_law = agnatic_succession
			holder_scope = {
				is_chinese_emperor_trigger = yes
				dynasty = ROOT
			}
		}
		host = {
			OR = {
				is_chinese_emperor_trigger = yes
				any_liege = {
					OR = {
						is_chinese_emperor_trigger = yes
						liege_before_war = {
							is_chinese_emperor_trigger = yes
						}
					}
				}
				liege_before_war = {
					is_chinese_emperor_trigger = yes
				}
			}
		}
	}
	
	immediate = {
		add_trait = dragon_bride_unmarried
	}
}

# on_adolescende
character_event = {
	id = soh.6411
	hide_window = yes
	
	is_triggered_only = yes
	
	has_dlc = "Jade Dragon"
	only_women = yes
	
	trigger = {
		is_landed = no
		e_china = {
			holder_scope = {
				is_chinese_emperor_trigger = yes
				dynasty = ROOT
			}
		}
		host = {
			OR = {
				is_chinese_emperor_trigger = yes
				any_liege = {
					OR = {
						is_chinese_emperor_trigger = yes
						liege_before_war = {
							is_chinese_emperor_trigger = yes
						}
					}
				}
				liege_before_war = {
					is_chinese_emperor_trigger = yes
				}
			}
		}
	}
	
	immediate = {
		if = {
			limit = {
				e_china = {
					has_law = agnatic_succession
				}
			}
			add_trait = dragon_bride_unmarried
			if = {
				limit = {
					is_betrothed = yes
				}
				break_betrothal = yes
			}
		}
		else = {
			remove_trait = dragon_bride_unmarried
		}
	}
}

# on_adulthood
character_event = {
	id = soh.6412
	hide_window = yes
	
	is_triggered_only = yes
	
	has_dlc = "Jade Dragon"
	only_women = yes
	
	trigger = {
		is_landed = no
		e_china = {
			holder_scope = {
				is_chinese_emperor_trigger = yes
				dynasty = ROOT
			}
		}
		host = {
			OR = {
				is_chinese_emperor_trigger = yes
				any_liege = {
					OR = {
						is_chinese_emperor_trigger = yes
						liege_before_war = {
							is_chinese_emperor_trigger = yes
						}
					}
				}
				liege_before_war = {
					is_chinese_emperor_trigger = yes
				}
			}
		}
	}
	
	immediate = {
		if = {
			limit = {
				e_china = {
					has_law = agnatic_succession
				}
			}
			add_trait = dragon_bride_unmarried
			if = {
				limit = {
					is_betrothed = yes
				}
				break_betrothal = yes
			}
		}
		else = {
			remove_trait = dragon_bride_unmarried
		}
	}
}

### Grace inheritance

# Grace inheritance on_death
character_event= {
	id = soh.6413
	hide_window = yes
	
	is_triggered_only = yes
	
	has_dlc = "Jade Dragon"
	
	trigger = {
		has_character_flag = grace_character
	}
	
	immediate = {
		if = {
			limit = {
				player_heir = {
					is_chinese_emperor_trigger = no
				}
			}
			if = {
				limit = {
					top_liege = {
						government = chinese_imperial_government
						is_chinese_emperor_trigger = no
					}
				}
				player_heir = {
					set_character_flag = grace_character
					change_variable = {
						which = grace
						which = ROOT
					}
				}
			}
			else_if = {
				limit = {
					NOT = {
						check_variable = {
							which = grace
							value = 0
						}
					}
				}
				divide_variable = {
					which = grace
					value = 10
				}
				player_heir = {
					set_character_flag = grace_character
					change_variable = {
						which = grace
						which = ROOT
					}
				}
			}
			else = {
				divide_variable = {
					which = grace
					value = 2
				}
				player_heir = {
					set_character_flag = grace_character
					change_variable = {
						which = grace
						which = ROOT
					}
				}
			}
		}
	}
}



##### Revoke Chinese Peace Deal

### Inform target

# Inform target - target is EoC
letter_event = {
	id = soh.6414
	desc = EVTDESC_SOH_6414
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6414 # The Dragon's memory is long...
		
		opinion = {
			who = FROMFROM
			modifier = china_peace_deal_breaker
		}
	}
}

# Inform target - sender is EoC
letter_event = {
	id = soh.6415
	desc = EVTDESC_SOH_6415
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6415 # Dishonour on them, and their cow!
		
		opinion = {
			who = FROMFROM
			modifier = china_peace_deal_breaker
		}
	}
}



##### Bestow Grace

### Bestow Grace

# on_yearly_pulse for vassals and below of China, checking for an AI liege
character_event = {
	id = soh.6416
	hide_window = yes
	
	is_triggered_only = yes
	
	only_playable = yes
	has_dlc = "Jade Dragon"
	min_age = 16
	capable_only = yes
	
	trigger = {
		top_liege = {
			is_chinese_emperor_trigger = yes
			ai = yes
			NOT = {
				character = ROOT
			}
			is_inaccessible_or_incapable_trigger = no
			has_regent = no
		}
		is_inaccessible_or_incapable_trigger = no
		has_regent = no
		is_under_regency_trigger = no
		OR = { # Don't do it for silly people!
			government = chinese_vassal_government
			government = japanese_bureaucracy_government
		}
		top_liege = {
			OR = {
				AND = {
					ROOT = {
						OR = {
							real_tier = king
							controls_religion = yes
							AND = {
								liege = {
									independent = yes
								}
								is_voter = yes
							}
							any_close_relative = {
								OR = {
									real_tier = emperor
									real_tier = king
									controls_religion = yes
								}
							}
						}
					}
					prestige = 500
				}
				AND = {
					ROOT = {
						NOR = {
							real_tier = king
							controls_religion = yes
							AND = {
								liege = {
									independent = yes
								}
								is_voter = yes
							}
							any_close_relative = {
								OR = {
									real_tier = emperor
									real_tier = king
									controls_religion = yes
								}
							}
						}
						OR = {
							real_tier = duke
							any_close_relative = {
								real_tier = duke
							}
						}
					}
					prestige = 200
				}
				AND = {
					ROOT = {
						NOR = {
							real_tier = king
							controls_religion = yes
							AND = {
								liege = {
									independent = yes
								}
								is_voter = yes
							}
							any_close_relative = {
								OR = {
									real_tier = emperor
									real_tier = king
									controls_religion = yes
								}
							}
						}
						NOR = {
							real_tier = duke
							any_close_relative = {
								real_tier = duke
							}
						}
					}
					prestige = 100
				}
			}
		}
	}
	
	immediate = {
		top_liege = {
			character_event = { id = soh.6417 } # AI liege gets event
		}
	}
}

# AI liege might bestow Grace
character_event = {
	id = soh.6417
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		random_list = {
			95 = {
				# Do nothing
			}
			5 = {
				modifier = {
					factor = 0.1
					FROM = {
						NOT = {
							government = chinese_vassal_government
						}
					}
				}
				modifier = {
					factor = 0.1
					FROM = {
						liege = {
							NOT = {
								character = ROOT
							}
						}
					}
				}
				modifier = {
					factor = 0
					any_rival = {
						character = FROM
					}
				}
				modifier = {
					factor = 10
					any_friend = {
						character = FROM
					}
				}
				modifier = {
					factor = 10
					any_lover = {
						character = FROM
					}
				}
				modifier = {
					factor = 0
					NOT = {
						prestige = 1000
					}
				}
				modifier = {
					factor = 0.1
					FROM = {
						in_faction = yes
						NOT = {
							opinion = {
								who = ROOT
								value = 25
							}
						}
					}
				}
				modifier = {
					factor = 0.1
					trait = paranoid
				}
				modifier = {
					factor = 2
					trait = trusting
				}
				modifier = {
					factor = 5
					trait = charitable
				}
				modifier = {
					factor = 2
					trait = humble
				}
				modifier = {
					factor = 0.5
					trait = proud
				}
				modifier = {
					factor = 0.01
					FROM = {
						check_variable = {
							which = grace
							value = 2000
						}
					}
				}
				# Bestow Grace
				FROM = {
					if = {
						limit = {
							OR = {
								real_tier = king
								controls_religion = yes
								AND = {
									liege = {
										character = ROOT
									}
									is_voter = yes
								}
								any_close_relative = {
									OR = {
										real_tier = emperor
										real_tier = king
										controls_religion = yes
									}
								}
							}
						}
						ROOT = {
							prestige = -500
						}
					}
					else_if = {
						limit = {
							OR = {
								real_tier = duke
								any_close_relative = {
									real_tier = duke
								}
							}
						}
						ROOT = {
							prestige = -250
						}
					}
					else = {
						ROOT = {
							prestige = -100
						}
					}
					character_event = { id = soh.6418 } # Ping FROM
				}
			}
		}
	}
}

# Ping target
character_event = {
	id = soh.6418
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		letter_event = { id = soh.6419 } # Inform target
	}
}

# Inform target
letter_event = {
	id = soh.6419
	desc = EVTDESC_SOH_6419
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6419 # This might be useful...
		
		set_character_flag = grace_character
		
		if = {
			limit = {
				OR = {
					real_tier = king
					controls_religion = yes
					AND = {
						liege = {
							character = FROMFROM
							is_voter = yes
						}
					}
					any_close_relative = {
						OR = {
							real_tier = emperor
							real_tier = king
							controls_religion = yes
						}
					}
				}
			}
			change_variable = {
				which = grace
				value = 1000
			}
		}
		else_if = {
			limit = {
				OR = {
					real_tier = duke
					any_close_relative = {
						real_tier = duke
					}
				}
			}
			change_variable = {
				which = grace
				value = 500
			}
		}
		else = {
			change_variable = {
				which = grace
				value = 200
			}
		}
		opinion = {
			who = FROMFROM
			modifier = opinion_bestowed_grace
		}
	}
}



##### Border Adjustment

### China

# on_five_year_pulse event for the AI
character_event = {
	id = soh.6420
	hide_window = yes
	
	is_triggered_only = yes
	
	only_playable = yes
	only_independent = yes
	has_dlc = "Jade Dragon"
	min_age = 16
	capable_only = yes
	
	trigger = {
		is_chinese_emperor_trigger = yes
		any_tributary = {
			is_tributary = {
				type = chinese_client_state
			}
			any_realm_title = {
				tier = count
				OR = {
					de_jure_liege_or_above = e_china
					region = world_china
				}
				NOT = {
					de_jure_liege_or_above = PREV
				}
			}
			is_inaccessible_or_incapable_trigger = no
			NOT = {
				has_character_modifier = peace_deal_with_china
			}
			NOT = {
				government = chinese_imperial_government
			}
		}
		war = no
		prisoner = no
		NOT = { trait = incapable }
		is_inaccessible_trigger = no
		has_regent = no
		is_inaccessible_or_incapable_trigger = no
		prestige = 5000
		wealth = 2000
	}
	
	immediate = {
		random_tributary = {
			limit = {
				is_tributary = {
					type = chinese_client_state
				}
				any_realm_title = {
					tier = count
					OR = {
						de_jure_liege_or_above = e_china
						region = world_china
					}
					NOT = {
						de_jure_liege_or_above = PREV
					}
				}
				is_inaccessible_or_incapable_trigger = no
				NOT = {
					has_character_modifier = peace_deal_with_china
				}
			}
			preferred_limit = {
				any_rival = {
					character = ROOT
				}
			}
			preferred_limit = {
				NOR = {
					any_friend = {
						character = ROOT
					}
					any_lover = {
						character = ROOT
					}
				}
			}
			random_realm_title = {
				limit = {
					tier = count
					OR = {
						de_jure_liege_or_above = e_china
						region = world_china
					}
					NOT = {
						de_jure_liege_or_above = PREV
					}
				}
				preferred_limit = {
					de_jure_liege_or_above = e_china
					region = world_china
				}
				duchy = {
					save_event_target_as = border_adjustment_duchy
				}
			}
		}
		
		random_list = {
			75 = {
				# Do nothing
			}
			25 = {
				modifier = {
					factor = 10
					trait = ambitious
				}
				modifier = {
					factor = 0
					trait = content
				}
				modifier = {
					factor = 2
					trait = greedy
				}
				modifier = {
					factor = 0.5
					trait = charitable
				}
				modifier = {
					factor = 5
					trait = proud
				}
				modifier = {
					factor = 0.2
					trait = humble
				}
				modifier = {
					factor = 5
					trait = envious
				}
				modifier = {
					factor = 0
					NOT = {
						wealth = 5000
					}
				}
				modifier = {
					factor = 0
					NOT = {
						prestige = 10000
					}
				}
				# Demand border adjustment
				prestige = -5000
				wealth = -2000
				any_tributary = {
					limit = {
						is_tributary = {
							type = chinese_client_state
						}
						any_realm_title = {
							tier = count
							OR = {
								de_jure_liege_or_above = e_china
								region = world_china
							}
							NOT = {
								de_jure_liege_or_above = PREV
							}
						}
						is_inaccessible_or_incapable_trigger = no
						NOT = {
							has_character_modifier = peace_deal_with_china
						}
						NOT = {
							government = chinese_imperial_government
						}
					}
					character_event = { id = soh.6421 } # Ping target
				}
			}
		}
	}
}

# Ping target to set up scopes
character_event = {
	id = soh.6421
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		narrative_event = { id = soh.6422 } # Inform target
	}
}

# Target gets request
narrative_event = {
	id = soh.6422
	is_triggered_only = yes
	title = EVTTITLE_SOH_6422
	desc = EVTDESC_SOH_6422
	picture = GFX_evt_chinese_bureaucrat
	window = EventWindowOffmap
	background = GFX_event_window_news_from_china
	
	option = {
		name = EVTOPTA_SOH_6422 # Accept the offer
		
		event_target:border_adjustment_duchy = {
			any_direct_de_jure_vassal_title = {
				limit = {
					holder_scope = {
						top_liege = {
							character = event_target:grace_decision_taker
						}
					}
				}
				if = {
					limit = {
						holder_scope = {
							NOR = {
								any_demesne_title = {
									NOR = {
										de_jure_liege_or_above = event_target:border_adjustment_duchy
										title = event_target:border_adjustment_duchy
									}
								}
								any_vassal = {
									any_demesne_title = {
										NOR = {
											de_jure_liege_or_above = event_target:border_adjustment_duchy
											title = event_target:border_adjustment_duchy
										}
									}
								}
							}
						}
					}
					holder_scope = {
						set_defacto_liege = FROMFROM
					}
				}
				else = {
					FROMFROM = {
						grant_title_no_opinion = PREV
					}
				}
			}
			if = {
				limit = {
					has_holder = yes
					holder_scope = {
						top_liege = {
							character = event_target:grace_decision_taker
						}
					}
				}
				FROMFROM = {
					grant_title_no_opinion = PREV
				}
			}
		}
		
		set_truce = {
			who = FROMFROM
			years = 10
		}
		FROMFROM = {
			set_truce = {
				who = ROOT
				years = 10
			}
		}
		
		FROMFROM = {
			letter_event = { id = soh.6423 } # Inform EoC
		}
	}
	
	option = {
		name = EVTOPTB_SOH_6422 # Refuse
		
		prestige = 100
		
		event_target:grace_decision_taker = {
			letter_event = { id = soh.6424 } # Inform EoC
		}
	}
}

# Target accepted
letter_event = {
	id = soh.6423
	desc = EVTDESC_SOH_6423
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6423 # Great!
	}
}

# Target refused - China claims the relevant titles
letter_event = {
	id = soh.6424
	desc = EVTDESC_SOH_6424
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6424 # How rude!
		
		FROM = {
			any_realm_title = {
				limit = {
					OR = {
						title = event_target:border_adjustment_duchy
						de_jure_liege = border_adjustment_duchy
					}
				}
				add_claim = ROOT
			}
		}
	}
}



##### Increase Tributary Tier

### Decision events

# on_bi_yearly_pulse event for the AI
character_event = {
	id = soh.6425
	hide_window = yes
	
	is_triggered_only = yes
	
	only_independent = yes
	only_playable = yes
	has_dlc = "Jade Dragon"
	min_age = 16
	capable_only = yes
	
	trigger = {
		is_chinese_emperor_trigger = yes
		war = no
		prisoner = no
		NOT = { trait = incapable }
		is_inaccessible_trigger = no
		has_regent = no
		is_inaccessible_or_incapable_trigger = no
		prestige = 5000
		wealth = 2000
		any_tributary = {
			war = no
			is_inaccessible_or_incapable_trigger = no
			NOR = {
				has_character_modifier = peace_deal_with_china
				has_non_aggression_pact_with = ROOT
				has_truce = ROOT
				ROOT = {
					has_truce = PREV
				}
			}
			OR = {
				AND = {
					is_tributary = {
						type = chinese_client_state
					}
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = ROOT
											top_liege = {
												character = ROOT
											}
										}
									}
								}
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
													}
												}
											}
											AND = {
												is_land = no
												any_neighbor_province = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
					# China isn't interested in integrating tribal or nomadic land
					NOR = {
						is_tribal = yes
						is_nomadic = yes
					}
				}
				AND = {
					is_tributary = {
						type = chinese_protectorate
					}
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = ROOT
											top_liege = {
												character = ROOT
											}
										}
									}
								}
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
													}
												}
											}
											AND = {
												is_land = no
												any_neighbor_province = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
					# China isn't really interested in nomads, and only cares about tribals in China/its de jure
					NOR = {
						AND = {
							is_tribal = yes
							NOT = {
								any_realm_province = {
									OR = {
										region = world_china
										county = {
											de_jure_liege_or_above = e_china
										}
									}
								}
							}
						}
						is_nomadic = yes
					}
				}
				AND = {
					is_tributary = {
						type = chinese_imperial_tributary
					}
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = ROOT
											top_liege = {
												character = ROOT
											}
											is_tributary = {
												type = chinese_client_state
											}
											is_tributary = {
												type = chinese_protectorate
											}
											top_liege = {
												OR = {
													is_tributary = {
														type = chinese_client_state
													}
													is_tributary = {
														type = chinese_protectorate
													}
												}
											}
										}
									}
								}
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														top_liege = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
															}
														}
													}
												}
											}
											AND = {
												is_land = no
												any_neighbor_province = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
															is_tributary = {
																type = chinese_client_state
															}
															is_tributary = {
																type = chinese_protectorate
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
					# China doesn't want to get dragged into messy wars in the steppes
					NOT = {
						is_nomadic = yes
					}
				}
				AND = {
					NOR = {
						is_tributary = {
							type = chinese_client_state
						}
						is_tributary = {
							type = chinese_protectorate
						}
						is_tributary = {
							type = chinese_imperial_tributary
						}
					}
					any_realm_province = {
						any_neighbor_province = {
							OR = {
								AND = {
									has_owner = yes
									owner = {
										OR = {
											character = ROOT
											top_liege = {
												character = ROOT
											}
											AND = {
												OR = {
													is_tributary = {
														type = chinese_client_state
													}
													is_tributary = {
														type = chinese_protectorate
													}
													is_tributary = {
														type = chinese_imperial_tributary
													}
												}
												suzerain = {
													is_chinese_emperor_trigger = yes
												}
											}
											top_liege = {
												OR = {
													is_tributary = {
														type = chinese_client_state
													}
													is_tributary = {
														type = chinese_protectorate
													}
													is_tributary = {
														type = chinese_imperial_tributary
													}
												}
												suzerain = {
													is_chinese_emperor_trigger = yes
												}
											}
										}
									}
								}
								AND = {
									is_land = no
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
														AND = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
																is_tributary = {
																	type = chinese_imperial_tributary
																}
															}
															suzerain = {
																is_chinese_emperor_trigger = yes
															}
														}
														top_liege = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
																is_tributary = {
																	type = chinese_imperial_tributary
																}
															}
															suzerain = {
																is_chinese_emperor_trigger = yes
															}
														}
													}
												}
											}
											AND = {
												is_land = no
												any_neighbor_province = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
															AND = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	is_tributary = {
																		type = chinese_imperial_tributary
																	}
																}
																suzerain = {
																	is_chinese_emperor_trigger = yes
																}
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	is_tributary = {
																		type = chinese_imperial_tributary
																	}
																}
																suzerain = {
																	is_chinese_emperor_trigger = yes
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
			}
			OR = {
				AND = {
					is_tributary = {
						type = chinese_client_state
					}
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
							ROOT = {
								prestige = 5000
								wealth = 10000
							}
						}
						AND = {
							OR = {
								real_tier = king
								AND = {
									real_tier = emperor
									is_nomadic = yes
								}
							}
							ROOT = {
								prestige = 2500
								wealth = 5000
							}
						}
						AND = {
							OR = {
								real_tier = duke
								real_tier = count
							}
							ROOT = {
								prestige = 1000
								wealth = 1000
							}
						}
					}
				}
				AND = {
					is_tributary = {
						type = chinese_protectorate
					}
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
							ROOT = {
								prestige = 2500
								wealth = 5000
							}
						}
						AND = {
							OR = {
								real_tier = king
								AND = {
									real_tier = emperor
									is_nomadic = yes
								}
							}
							ROOT = {
								prestige = 1000
								wealth = 1000
							}
						}
						AND = {
							OR = {
								real_tier = duke
								real_tier = count
							}
							ROOT = {
								prestige = 500
								wealth = 500
							}
						}
					}
				}
				AND = {
					is_tributary = {
						type = chinese_imperial_tributary
					}
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
							ROOT = {
								prestige = 1000
								wealth = 1000
							}
						}
						AND = {
							OR = {
								real_tier = king
								AND = {
									real_tier = emperor
									is_nomadic = yes
								}
							}
							ROOT = {
								prestige = 500
								wealth = 500
							}
						}
						AND = {
							OR = {
								real_tier = duke
								real_tier = count
							}
							ROOT = {
								prestige = 250
								wealth = 100
							}
						}
					}
				}
				AND = {
					NOR = {
						is_tributary = {
							type = chinese_client_state
						}
						is_tributary = {
							type = chinese_protectorate
						}
						is_tributary = {
							type = chinese_imperial_tributary
						}
					}
					OR = {
						AND = {
							real_tier = emperor
							is_nomadic = no
							ROOT = {
								prestige = 500
								wealth = 500
							}
						}
						AND = {
							OR = {
								real_tier = king
								AND = {
									real_tier = emperor
									is_nomadic = yes
								}
							}
							ROOT = {
								prestige = 250
								wealth = 100
							}
						}
						AND = {
							OR = {
								real_tier = duke
								real_tier = count
							}
							ROOT = {
								prestige = 100
								wealth = 50
							}
						}
					}
				}
			}
		}
	}
	
	immediate = {
		random_tributary = {
			limit = {
				war = no
				is_inaccessible_or_incapable_trigger = no
				NOR = {
					has_character_modifier = peace_deal_with_china
					has_non_aggression_pact_with = ROOT
					has_truce = ROOT
					ROOT = {
						has_truce = PREV
					}
				}
				OR = {
					AND = {
						is_tributary = {
							type = chinese_client_state
						}
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
											}
										}
									}
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
						# China isn't interested in integrating tribal or nomadic land
						NOR = {
							is_tribal = yes
							is_nomadic = yes
						}
					}
					AND = {
						is_tributary = {
							type = chinese_protectorate
						}
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
											}
										}
									}
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
						# China isn't really interested in nomads, and only cares about tribals in China/its de jure
						NOR = {
							AND = {
								is_tribal = yes
								NOT = {
									any_realm_province = {
										OR = {
											region = world_china
											county = {
												de_jure_liege_or_above = e_china
											}
										}
									}
								}
							}
							is_nomadic = yes
						}
					}
					AND = {
						is_tributary = {
							type = chinese_imperial_tributary
						}
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
												is_tributary = {
													type = chinese_client_state
												}
												is_tributary = {
													type = chinese_protectorate
												}
												top_liege = {
													OR = {
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
													}
												}
											}
										}
									}
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
															is_tributary = {
																type = chinese_client_state
															}
															is_tributary = {
																type = chinese_protectorate
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																}
															}
														}
													}
												}
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
																top_liege = {
																	OR = {
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
						# China doesn't want to get dragged into messy wars in the steppes
						NOT = {
							is_nomadic = yes
						}
					}
					AND = {
						NOR = {
							is_tributary = {
								type = chinese_client_state
							}
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_imperial_tributary
							}
						}
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
												AND = {
													OR = {
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														is_tributary = {
															type = chinese_imperial_tributary
														}
													}
													suzerain = {
														is_chinese_emperor_trigger = yes
													}
												}
												top_liege = {
													OR = {
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														is_tributary = {
															type = chinese_imperial_tributary
														}
													}
													suzerain = {
														is_chinese_emperor_trigger = yes
													}
												}
											}
										}
									}
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
															AND = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	is_tributary = {
																		type = chinese_imperial_tributary
																	}
																}
																suzerain = {
																	is_chinese_emperor_trigger = yes
																}
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	is_tributary = {
																		type = chinese_imperial_tributary
																	}
																}
																suzerain = {
																	is_chinese_emperor_trigger = yes
																}
															}
														}
													}
												}
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
																AND = {
																	OR = {
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																		is_tributary = {
																			type = chinese_imperial_tributary
																		}
																	}
																	suzerain = {
																		is_chinese_emperor_trigger = yes
																	}
																}
																top_liege = {
																	OR = {
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																		is_tributary = {
																			type = chinese_imperial_tributary
																		}
																	}
																	suzerain = {
																		is_chinese_emperor_trigger = yes
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
				OR = {
					AND = {
						is_tributary = {
							type = chinese_client_state
						}
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
								ROOT = {
									prestige = 5000
									wealth = 10000
								}
							}
							AND = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
								ROOT = {
									prestige = 2500
									wealth = 5000
								}
							}
							AND = {
								OR = {
									real_tier = duke
									real_tier = count
								}
								ROOT = {
									prestige = 1000
									wealth = 1000
								}
							}
						}
					}
					AND = {
						is_tributary = {
							type = chinese_protectorate
						}
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
								ROOT = {
									prestige = 2500
									wealth = 5000
								}
							}
							AND = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
								ROOT = {
									prestige = 1000
									wealth = 1000
								}
							}
							AND = {
								OR = {
									real_tier = duke
									real_tier = count
								}
								ROOT = {
									prestige = 500
									wealth = 500
								}
							}
						}
					}
					AND = {
						is_tributary = {
							type = chinese_imperial_tributary
						}
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
								ROOT = {
									prestige = 1000
									wealth = 1000
								}
							}
							AND = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
								ROOT = {
									prestige = 500
									wealth = 500
								}
							}
							AND = {
								OR = {
									real_tier = duke
									real_tier = count
								}
								ROOT = {
									prestige = 250
									wealth = 100
								}
							}
						}
					}
					AND = {
						NOR = {
							is_tributary = {
								type = chinese_client_state
							}
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_imperial_tributary
							}
						}
						OR = {
							AND = {
								real_tier = emperor
								is_nomadic = no
								ROOT = {
									prestige = 500
									wealth = 500
								}
							}
							AND = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
								ROOT = {
									prestige = 250
									wealth = 100
								}
							}
							AND = {
								OR = {
									real_tier = duke
									real_tier = count
								}
								ROOT = {
									prestige = 100
									wealth = 50
								}
							}
						}
					}
				}
			}
			preferred_limit = {
				is_tributary = {
					type = chinese_client_state
				}
				any_rival = {
					character = ROOT
				}
			}
			preferred_limit = {
				is_tributary = {
					type = chinese_protectorate
				}
				any_rival = {
					character = ROOT
				}
			}
			preferred_limit = {
				is_tributary = {
					type = chinese_imperial_tributary
				}
				any_rival = {
					character = ROOT
				}
			}
			preferred_limit = {
				is_tributary = {
					type = chinese_client_state
				}
				NOR = {
					any_friend = {
						character = ROOT
					}
					any_lover = {
						character = ROOT
					}
				}
			}
			preferred_limit = {
				is_tributary = {
					type = chinese_protectorate
				}
				NOR = {
					any_friend = {
						character = ROOT
					}
					any_lover = {
						character = ROOT
					}
				}
			}
			preferred_limit = {
				is_tributary = {
					type = chinese_imperial_tributary
				}
				NOR = {
					any_friend = {
						character = ROOT
					}
					any_lover = {
						character = ROOT
					}
				}
			}
			save_event_target_as = target_tributary
		}
		random_list = {
			75 = {
				# Do nothing
			}
			25 = {
				modifier = {
					factor = 10
					trait = ambitious
				}
				modifier = {
					factor = 0
					trait = content
				}
				modifier = {
					factor = 2
					trait = greedy
				}
				modifier = {
					factor = 0.5
					trait = charitable
				}
				modifier = {
					factor = 10
					trait = proud
				}
				modifier = {
					factor = 0.1
					trait = humble
				}
				modifier = {
					factor = 5
					trait = envious
				}
				# Do it
				event_target:target_tributary = {
					if = {
						limit = {
							is_tributary = {
								type = chinese_client_state
							}
						}
						if = {
							limit = {
								real_tier = emperor
								is_nomadic = no
							}
							ROOT = {
								prestige = -5000
								wealth = -10000
							}
						}
						else_if = {
							limit = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
							}
							ROOT = {
								prestige = -2500
								wealth = -5000
							}
						}
						else = {
							ROOT = {
								prestige = -1000
								wealth = -1000
							}
						}
					}
					else_if = {
						limit = {
							is_tributary = {
								type = chinese_protectorate
							}
						}
						if = {
							limit = {
								real_tier = emperor
								is_nomadic = no
							}
							ROOT = {
								prestige = -2500
								wealth = -5000
							}
						}
						else_if = {
							limit = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
							}
							ROOT = {
								prestige = -1000
								wealth = -1000
							}
						}
						else = {
							ROOT = {
								prestige = 500
								wealth = 500
							}
						}
					}
					else_if = {
						limit = {
							is_tributary = {
								type = chinese_imperial_tributary
							}
						}
						if = {
							limit = {
								real_tier = emperor
								is_nomadic = no
							}
							ROOT = {
								prestige = -1000
								wealth = -1000
							}
						}
						else_if = {
							limit = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
							}
							ROOT = {
								prestige = -500
								wealth = -500
							}
						}
						else = {
							ROOT = {
								prestige = -250
								wealth = -100
							}
						}
					}
					else = {
						if = {
							limit = {
								real_tier = emperor
								is_nomadic = no
							}
							ROOT = {
								prestige = -500
								wealth = -500
							}
						}
						else_if = {
							limit = {
								OR = {
									real_tier = king
									AND = {
										real_tier = emperor
										is_nomadic = yes
									}
								}
							}
							ROOT = {
								prestige = -250
								wealth = -100
							}
						}
						else = {
							ROOT = {
								prestige = -100
								wealth = -50
							}
						}
					}
					character_event = { id = soh.6426 } # Ping target
				}
			}
		}
	}
}

# Ping target to set up scopes
character_event = {
	id = soh.6426
	hide_window = yes
	
	is_triggered_only = yes
	
	immediate = {
		narrative_event = { id = soh.6427 } # Inform target
	}
}

# Target gets request
narrative_event = {
	id = soh.6427
	is_triggered_only = yes
	title = EVTTITLE_SOH_6427
	desc = EVTDESC__SOH_6427
	picture = GFX_evt_chinese_bureaucrat
	window = EventWindowOffmap
	background = GFX_event_window_news_from_china
	
	option = {
		trigger = {
			controls_religion = no
			NAND = {
				can_have_any_japanese_government_trigger = yes
				any_realm_lord = {
					OR = {
						government = japanese_imperial_government
						government = divine_imperial_government
					}
				}
			}
		}
		name = ETOPTA_SOH_6427 # Very well...
		
		# If we accept, we get half of the wealth the EoC paid
		if = {
			limit = {
				is_tributary = {
					type = chinese_client_state
				}
			}
			if = {
				limit = {
					tier = emperor
					is_nomadic = no
				}
				wealth = 5000
			}
			else_if = {
				limit = {
					OR = {
						tier = king
						AND = {
							tier = emperor
							is_nomadic = yes
						}
					}
				}
				wealth = 2500
			}
			else = {
				wealth = 500
			}
		}
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_protectorate
				}
			}
			if = {
				limit = {
					tier = emperor
					is_nomadic = no
				}
				wealth = 2500
			}
			else_if = {
				limit = {
					OR = {
						tier = king
						AND = {
							tier = emperor
							is_nomadic = yes
						}
					}
				}
				wealth = 500
			}
			else = {
				wealth = 250
			}
		}
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_imperial_tributary
				}
			}
			if = {
				limit = {
					tier = emperor
					is_nomadic = no
				}
				wealth = 500
			}
			else_if = {
				limit = {
					OR = {
						tier = king
						AND = {
							tier = emperor
							is_nomadic = yes
						}
					}
				}
				wealth = 250
			}
			else = {
				wealth = 50
			}
		}
		else = {
			if = {
				limit = {
					tier = emperor
					is_nomadic = no
				}
				wealth = 250
			}
			else_if = {
				limit = {
					OR = {
						tier = king
						AND = {
							tier = emperor
							is_nomadic = yes
						}
					}
				}
				wealth = 50
			}
			else = {
				wealth = 50
			}
		}
		increase_tributary_tier_or_vassalize_effect = yes
		
		FROMFROM = {
			letter_event = { id = soh.6428 } # Inform EoC
		}
	}
	
	option = {
		trigger = {
			OR = { # We do not have enough Grace to avoid the request (half the cost of downgrading from our current tier)
				AND = {
					is_tributary = {
						type = chinese_client_state
					}
					OR = {
						AND = {
							NOT = { # If a Client State is too distant, China will be more willing to let them go
								any_realm_province = {
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														is_chinese_emperor_trigger = yes
														top_liege = {
															is_chinese_emperor_trigger = yes
														}
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														top_liege = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
															}
														}
													}
													NOR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
													}
												}
											}
											AND = {
												is_land = no
												any_neighbor_province = {
													OR = {
														AND = {
															has_owner = yes
															owner = {
																OR = {
																	is_chinese_emperor_trigger = yes
																	top_liege = {
																		is_chinese_emperor_trigger = yes
																	}
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	top_liege = {
																		OR = {
																			is_tributary = {
																				type = chinese_client_state
																			}
																			is_tributary = {
																				type = chinese_protectorate
																			}
																		}
																	}
																}
																NOR = {
																	character = ROOT
																	top_liege = {
																		character = ROOT
																	}
																}
															}
														}
														AND = {
															is_land = no
															any_neighbor_province = {
																has_owner = yes
																owner = {
																	OR = {
																		is_chinese_emperor_trigger = yes
																		top_liege = {
																			is_chinese_emperor_trigger = yes
																		}
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																		top_liege = {
																			OR = {
																				is_tributary = {
																					type = chinese_client_state
																				}
																				is_tributary = {
																					type = chinese_protectorate
																				}
																			}
																		}
																	}
																	NOR = {
																		character = ROOT
																		top_liege = {
																			character = ROOT
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
							check_variable = {
								which = grace
								value = 2500
							}
						}
						check_variable = {
							which = grace
							value = 5000
						}
					}
				}
				AND = {
					is_tributary = {
						type = chinese_protectorate
					}
					OR = {
						AND = {
							NOT = { # If a Protectorate is too distant, China will be more willing to let them go
								any_realm_province = {
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														is_chinese_emperor_trigger = yes
														top_liege = {
															is_chinese_emperor_trigger = yes
														}
													}
												}
											}
											AND = {
												is_land = no
												any_neighbor_province = {
													OR = {
														AND = {
															has_owner = yes
															owner = {
																OR = {
																	is_chinese_emperor_trigger = yes
																	top_liege = {
																		is_chinese_emperor_trigger = yes
																	}
																}
															}
														}
														AND = {
															is_land = no
															any_neighbor_province = {
																has_owner = yes
																owner = {
																	OR = {
																		is_chinese_emperor_trigger = yes
																		top_liege = {
																			is_chinese_emperor_trigger = yes
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
							check_variable = {
								which = grace
								value = 1000
							}
						}
						check_variable = {
							which = grace
							value = 2000
						}
					}
				}
				AND = {
					is_tributary = {
						type = chinese_imperial_tributary
					}
					check_variable = {
						which = grace
						value = 500
					}
				}
				AND = {
					NOR = {
						is_tributary = {
							type = chinese_client_state
						}
						is_tributary = {
							type = chinese_protectorate
						}
						is_tributary = {
							type = chinese_imperial_tributary
						}
					}
					check_variable = {
						which = grace
						value = 250
					}
				}
			}
		}
		name = EVTOPTB_SOH_6427 # I think you'll reconsider...
		
		if = {
			limit = {
				is_tributary = {
					type = chinese_client_state
				}
			}
			if = {
				limit = {
					NOT = { # If a Client State is too distant, China will be more willing to let them go
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												is_chinese_emperor_trigger = yes
												top_liege = {
													is_chinese_emperor_trigger = yes
												}
												is_tributary = {
													type = chinese_client_state
												}
												is_tributary = {
													type = chinese_protectorate
												}
												top_liege = {
													OR = {
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
													}
												}
											}
											NOR = {
												character = ROOT
												top_liege = {
													character = ROOT
												}
											}
										}
									}
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															is_chinese_emperor_trigger = yes
															top_liege = {
																is_chinese_emperor_trigger = yes
															}
															is_tributary = {
																type = chinese_client_state
															}
															is_tributary = {
																type = chinese_protectorate
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																}
															}
														}
														NOR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																is_chinese_emperor_trigger = yes
																top_liege = {
																	is_chinese_emperor_trigger = yes
																}
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
																top_liege = {
																	OR = {
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																	}
																}
															}
															NOR = {
																character = ROOT
																top_liege = {
																	character = ROOT
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
				change_variable = {
					which = grace
					value = -2500
				}
			}
			else = {
				change_variable = {
					which = grace
					value = -5000
				}
			}
		}
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_protectorate
				}
			}
			if = {
				limit = {
					NOT = { # If a Protectorate is too distant, China will be more willing to let them go
						any_realm_province = {
							any_neighbor_province = {
								OR = {
									AND = {
										has_owner = yes
										owner = {
											OR = {
												is_chinese_emperor_trigger = yes
												top_liege = {
													is_chinese_emperor_trigger = yes
												}
											}
										}
									}
									AND = {
										is_land = no
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															is_chinese_emperor_trigger = yes
															top_liege = {
																is_chinese_emperor_trigger = yes
															}
														}
													}
												}
												AND = {
													is_land = no
													any_neighbor_province = {
														has_owner = yes
														owner = {
															OR = {
																is_chinese_emperor_trigger = yes
																top_liege = {
																	is_chinese_emperor_trigger = yes
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
					}
				}
				change_variable = {
					which = grace
					value = -1000
				}
			}
			else = {
				change_variable = {
					which = grace
					value = -2000
				}
			}
		}
		else_if = {
			limit = {
				is_tributary = {
					type = chinese_imperial_tributary
				}
			}
			change_variable = {
				which = grace
				value = -500
			}
		}
		else = {
			change_variable = {
				which = grace
				value = -2500
			}
		}
		
		FROMFROM = {
			letter_event = { id = soh.6429 } # Inform EoC
		}
	}
	
	option = {
		trigger = {
			NOR = { # We do not have enough Grace to avoid the request (half the cost of downgrading from our current tier)
				AND = {
					is_tributary = {
						type = chinese_client_state
					}
					OR = {
						AND = {
							NOT = { # If a Client State is too distant, China will be more willing to let them go
								any_realm_province = {
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														is_chinese_emperor_trigger = yes
														top_liege = {
															is_chinese_emperor_trigger = yes
														}
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														top_liege = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
															}
														}
													}
													NOR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
													}
												}
											}
											AND = {
												is_land = no
												any_neighbor_province = {
													OR = {
														AND = {
															has_owner = yes
															owner = {
																OR = {
																	is_chinese_emperor_trigger = yes
																	top_liege = {
																		is_chinese_emperor_trigger = yes
																	}
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	top_liege = {
																		OR = {
																			is_tributary = {
																				type = chinese_client_state
																			}
																			is_tributary = {
																				type = chinese_protectorate
																			}
																		}
																	}
																}
																NOR = {
																	character = ROOT
																	top_liege = {
																		character = ROOT
																	}
																}
															}
														}
														AND = {
															is_land = no
															any_neighbor_province = {
																has_owner = yes
																owner = {
																	OR = {
																		is_chinese_emperor_trigger = yes
																		top_liege = {
																			is_chinese_emperor_trigger = yes
																		}
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																		top_liege = {
																			OR = {
																				is_tributary = {
																					type = chinese_client_state
																				}
																				is_tributary = {
																					type = chinese_protectorate
																				}
																			}
																		}
																	}
																	NOR = {
																		character = ROOT
																		top_liege = {
																			character = ROOT
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
							check_variable = {
								which = grace
								value = 2500
							}
						}
						check_variable = {
							which = grace
							value = 5000
						}
					}
				}
				AND = {
					is_tributary = {
						type = chinese_protectorate
					}
					OR = {
						AND = {
							NOT = { # If a Protectorate is too distant, China will be more willing to let them go
								any_realm_province = {
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														is_chinese_emperor_trigger = yes
														top_liege = {
															is_chinese_emperor_trigger = yes
														}
													}
												}
											}
											AND = {
												is_land = no
												any_neighbor_province = {
													OR = {
														AND = {
															has_owner = yes
															owner = {
																OR = {
																	is_chinese_emperor_trigger = yes
																	top_liege = {
																		is_chinese_emperor_trigger = yes
																	}
																}
															}
														}
														AND = {
															is_land = no
															any_neighbor_province = {
																has_owner = yes
																owner = {
																	OR = {
																		is_chinese_emperor_trigger = yes
																		top_liege = {
																			is_chinese_emperor_trigger = yes
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
							check_variable = {
								which = grace
								value = 1000
							}
						}
						check_variable = {
							which = grace
							value = 2000
						}
					}
				}
				AND = {
					is_tributary = {
						type = chinese_imperial_tributary
					}
					check_variable = {
						which = grace
						value = 500
					}
				}
				AND = {
					NOR = {
						is_tributary = {
							type = chinese_client_state
						}
						is_tributary = {
							type = chinese_protectorate
						}
						is_tributary = {
							type = chinese_imperial_tributary
						}
					}
					check_variable = {
						which = grace
						value = 250
					}
				}
			}
		}
		name = EVTOPTC_SOH_6427 # You're bluffing!
		
		FROMFROM = {
			letter_event = { id = soh.6430 } # Inform EoC
		}
	}
}

# Target accepted
letter_event = {
	id = soh.6428
	desc = EVTDESC_SOH_6428
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6428 # Great!
	}
}

# Target refused - used Grace to avoid war
letter_event = {
	id = soh.6429
	desc = EVTDESC_SOH_6429
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6429 # I see...
	}
}

# Target refused - not enough Grace to dodge war
letter_event = {
	id = soh.6430
	desc = EVTDESC_SOH_6430
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6430 # Then war it is!
		
		unsafe_war = {
			target = FROM
			casus_belli = chinese_tributary_tier_war
		}
		
		opinion = {
			who = FROM
			modifier = opinion_tributary_refused_increase_tributary_tier
		}
	}
	
	option = {
		name = EVTOPTB_SOH_6430 # I see...
		
		hidden_tooltip = {
			if = {
				limit = {
					FROM = {
						is_tributary = {
							type = chinese_client_state
						}
					}
				}
				change_variable = {
					which = mandate_of_heaven
					value = -10
				}
			}
			else_if = {
				limit = {
					FROM = {
						is_tributary = {
							type = chinese_protectorate
						}
					}
				}
				change_variable = {
					which = mandate_of_heaven
					value = -5
				}
			}
			else_if = {
				limit = {
					FROM = {
						is_tributary = {
							type = chinese_imperial_tributary
						}
					}
				}
				change_variable = {
					which = mandate_of_heaven
					value = -2
				}
			}
			else = {
				change_variable = {
					which = mandate_of_heaven
					value = -1
				}
			}
		}
		
		opinion = {
			who = FROM
			modifier = opinion_tributary_refused_increase_tributary_tier
		}
		
		FROM = {
			letter_event = { id = soh.6431 } # Inform tributary
		}
	}
}

# EoC backed down
letter_event = {
	id = soh.6431
	desc = EVTDESC_SOH_6431
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6431 # Great!
		prestige = 500
	}
}

### War ends

# Other tributaries informed - lower tier?
narrative_event = {
	id = soh.6432
	is_triggered_only = yes
	title = EVTTITLE_SOH_6432
	desc = EVTDESC_SOH_6432
	picture = GFX_evt_china_civil_war
	window = EventWindowOffmap
	background = GFX_event_window_news_from_china
	
	option = {
		name = EVTOPTA_SOH_6432 # My current relationship with China is fine
		
		e_china = {
			holder_scope = {
				letter_event = { id = soh.6433 } # Inform China that the tributary lowered its tier
			}
		}
	}
	
	option = {
		name = EVTOPTB_SOH_6432 # It is time to re-define our relationship!
		
		log = "GRACE SYSTEM: [Root.GetTitledName] opted to reduce their tributary tier!"
		
		decrease_tributary_tier_or_release_effect = yes
		
		e_china = {
			holder_scope = {
				letter_event = { id = soh.6434 } # Inform China that the tributary lowered its tier
			}
		}
	}
}

# Tributary remained loyal - EoC
letter_event = {
	id = soh.6433
	desc = EVTDESC_SOH_6433
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6433 # Great!
	}
}

# Tributary lowered tier or broke free - EoC
letter_event = {
	id = soh.6434
	desc = EVTDESC_SOH_6434
	border = GFX_event_letter_frame_diplomacy
	
	is_triggered_only = yes
	
	option = {
		name = EVTOPTA_SOH_6434 # How ungrateful!
	}
}