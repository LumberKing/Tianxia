# This file borrows heavily from the vanilla jd_grace_decisions.txt file when it comes to AI logic and requirements on people being sent to China
# All Grace decisions MUST be DLC-locked to JD to avoid conflict with modding rule 7, even though we cannot use the offmap mechanics
# Important scripted triggers are located in the tianxia_grace_triggers.txt file in the /common/scripted_triggers directory

# ONLY the EoC will be using the Grace system, regardless of whether someone else has the Chinese Imperial government type
# A fully dynamic system is not possible due to the need to name the variables, but it should be possible to implement the same (or similar) decisions for specific titles, if desired

# The AI does all of this using offset on_x_pulse events

# TODO: Scripted triggers for availability
# TODO: Opinion modifiers
# TODO: Events
# TODO: Test

targeted_decisions = {
	request_truce_china = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			is_close_to_china_or_along_the_silk_road_trigger = yes
			independent = yes
			top_liege = {
				NOT = {
					government = chinese_imperial_government # Either under a pretender or a vassal of China
				}
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				any_war = {
					attacker = {
						is_chinese_emperor_trigger = yes
					}
					defender = {
						character = FROM
					}
				}
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				check_variable = {
					which = grace
					value = 500
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -500
				}
			}
			character_event = { id = soh.6202 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_peace_deal_china = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
	
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			is_close_to_china_or_along_the_silk_road_trigger = yes
			independent = yes
			top_liege = {
				NOT = {
					government = chinese_imperial_government # Either under a pretender or a vassal of China
				}
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
		
		allow = {
			show_only_failed_conditions = yes
			NOR = {
				FROM = {
					has_character_modifier = peace_deal_with_china
				}
				has_non_aggression_pact_with = FROM
			}
			FROM = {
				show_scope_change = no
				war = no
				in_revolt = no
				independent = yes
				NOT = { pays_tribute_to = ROOT }
				check_variable = {
					which = grace
					value = 500
				}
				NOT = {
					suzerain = {
						is_chinese_emperor_trigger = yes
					}
				}
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -500
				}
			}
			character_event = { id = soh.6208 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_favor_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			has_dlc = "Zeus"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				check_variable = {
					which = grace
					value = 1000
				}
			}
			is_inaccessible_or_incapable_trigger = no
			NOR = {
				holds_favor_on = FROM
				owes_favor_to = FROM
			}
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -1000
				}
			}
			character_event = { id = soh.6214 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	cancel_favor_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			has_dlc = "Zeus"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				check_variable = {
					which = grace
					value = 1000
				}
			}
			is_inaccessible_or_incapable_trigger = no
			holds_favor_on = FROM
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -1000
				}
			}
			character_event = { id = soh.6220 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_county_china_self_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
			OR = {
				any_demesne_title = {
					count = 2
					tier = count
					location = {
						capital_holding = {
							holding_type = castle
						}
					}
				}
				AND = {
					primary_title = {
						NOR = {
							has_law = ci_vassal_law_3
							has_law = ci_vassal_law_4
						}
					}
					any_realm_lord = {
						war = no
						NOT = {
							character = FROM
						}
						NOT = {
							has_minor_title = title_grand_chancellor
						}
						any_demesne_title = {
							count = 2
							tier = count
							location = {
								capital_holding = {
									holding_type = castle
								}
							}
						}
					}
				}
			}
		}
	
		allow = {
			war = no
			show_only_failed_conditions = yes
			FROM = {
				is_feudal = yes
				war = no
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					check_variable = {
						which = grace
						value = 2000
					}
					AND = {
						has_minor_title = title_grand_chancellor
						check_variable = {
							which = grace
							value = 1500
						}
					}
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						has_minor_title = title_grand_chancellor
					}
					change_variable = {
						which = grace
						value = -1500
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -2000
					}
				}
			}
			character_event = { id = soh.6226 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_county_china_other_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		third_party_filter = home_court
		ai_third_party_filter = none
		third_party = FROM
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
			OR = {
				any_demesne_title = {
					count = 2
					tier = count
					location = {
						capital_holding = {
							holding_type = castle
						}
					}
				}
				AND = {
					primary_title = {
						NOR = {
							has_law = ci_vassal_law_3
							has_law = ci_vassal_law_4
						}
					}
					any_realm_lord = {
						war = no
						NOT = {
							has_minor_title = title_grand_chancellor
						}
						any_demesne_title = {
							count = 2
							tier = count
							location = {
								capital_holding = {
									holding_type = castle
								}
							}
						}
					}
				}
			}
		}
	
		allow = {
			war = no
			show_only_failed_conditions = yes
			FROM = {
				war = no
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				is_feudal = yes
				OR = {
					check_variable = {
						which = grace
						value = 2000
					}
					AND = {
						has_minor_title = title_grand_chancellor
						check_variable = {
							which = grace
							value = 1500
						}
					}
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		third_party_potential = {
			show_only_failed_conditions = yes
			FROMFROM = {
				hidden_tooltip = {
					liege = {
						character = ROOT_FROM
					}
				}
				show_scope_change = no
				NOT = { is_ruler = yes }
				is_adult = yes
				prisoner = no
				OR = {
					is_female = no
					ROOT_FROM = {
						OR = {
							has_game_rule = {
								name = gender
								value = all
							}
							primary_title = {
								has_law = status_of_women_4
							}
							has_religion_feature = religion_matriarchal
							has_religion_feature = religion_equal
							has_religion_feature = religion_feature_bon
							has_religion_feature = religion_feature_ryukyuan_three_mountains
							has_religion_feature = religion_feature_ryukyuan_historical
						}
					}
				}
				custom_tooltip = {
					text = is_not_incapable_inbred_or_imbecile_tt
					NOT = { trait = incapable }
					NOT = { trait = inbred }
					NOT = { trait = imbecile }
				}
			}
		}
		
		third_party_allow = {
			show_only_failed_conditions = yes
			FROMFROM = {
				is_ill = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				NOT = { is_landed = yes }
				OR = {
					dynasty = ROOT_FROM
					any_friend = {
						character = ROOT_FROM
					}
					any_lover = {
						character = ROOT_FROM
					}
					is_close_relative = ROOT_FROM
				}
			}
		}
		
		effect = {
			ROOT_FROMFROM = {
				save_event_target_as = character_getting_county
			}
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						has_minor_title = title_grand_chancellor
					}
					change_variable = {
						which = grace
						value = -1500
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -2000
					}
				}
			}
			character_event = { id = soh.6237 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_imperial_marriage_china = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		third_party_filter = realm_including_me
		ai_third_party_filter = none
		third_party = FROM
		show_third_party_potential = yes
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			is_close_to_china_or_along_the_silk_road_trigger = yes
			OR = {
				independent = yes
				real_tier = king
				has_minor_title = title_grand_chancellor
				i_am_appropriate_regent_trigger = yes
				liege = {
					independent = yes
				}
			}
			top_liege = {
				NOT = {
					government = chinese_imperial_government # Either under a pretender or a vassal of China
				}
			}
			OR = {
				is_feudal = yes
				is_tribal = yes
				is_nomadic = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
			any_dynasty_member = {
				is_valid_dragon_bride_candidate = yes
			}
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				OR = {
					independent = yes
					real_tier = king
					has_minor_title = title_grand_chancellor
					i_am_appropriate_regent_trigger = yes
					AND = {
						liege = {
							independent = yes
						}
						is_powerful_vassal = yes
					}
				}
				NOR = {
					any_war = {
						any_attacker = {
							character = FROM
						}
						any_defender = {
							is_chinese_emperor_trigger = yes
						}
					}
					any_war = {
						any_attacker = {
							is_chinese_emperor_trigger = yes
						}
						any_defender = {
							character = FROM
						}
					}
				}
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				conditional_tooltip = {
					trigger = { NOT = { has_character_modifier = peace_deal_with_china } }
					OR = {
						check_variable = {
							which = grace
							value = 2000
						}
						AND = {
							suzerain = {
								is_chinese_emperor_trigger = yes
							}
							OR = {
								is_tributary = {
									type = chinese_protectorate
								}
								is_tributary = {
									type = chinese_client_state
								}
							}
							check_variable = {
								which = grace
								value = 1500
							}
						}
					}
				}
				conditional_tooltip = {
					trigger = { has_character_modifier = peace_deal_with_china }
					OR = {
						check_variable = {
							which = grace
							value = 1500
						}
						AND = {
							suzerain = {
								is_chinese_emperor_trigger = yes
							}
							OR = {
								is_tributary = {
									type = chinese_protectorate
								}
								is_tributary = {
									type = chinese_client_state
								}
							}
							check_variable = {
								which = grace
								value = 1000
							}
						}
					}
				}
				OR = {
					#custom_tooltip = {
						#text = can_marry_chinese_royal_tt
						AND = {
							is_adult = yes
							is_married = no
							is_female = no
						}
					#}
					custom_tooltip = {
						text = has_courtier_eligible_for_marriage_tt
						OR = {
							any_dynasty_member = {
								is_adult = yes
								is_married = no
								host = { character = ROOT_FROM }
								is_female = no
								is_landed = no
							}
							any_close_relative = {
								is_adult = yes
								is_married = no
								host = { character = ROOT_FROM }
								NOT = { any_spouse = { character = ROOT_FROM } } #turns out without this, it includes your spouse
								is_female = no
								is_landed = no
							}
						}
					}
				}
				prisoner = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
			}
			is_inaccessible_or_incapable_trigger = no
		}

		third_party_potential = {
			show_only_failed_conditions = yes
			FROMFROM = {
				show_scope_change = no
				OR = {
					dynasty = ROOT_FROM
					is_close_relative = ROOT_FROM
				}
				OR = {
					character = ROOT_FROM
					AND = {
						liege = { character = ROOT_FROM }
						ai = yes
					}
				}
				NOT = { any_spouse = { character = ROOT_FROM } }
				is_adult = yes
				is_betrothed = no
				is_female = no # Vanilla allows women to get Chinese Imperial Marriages, but it would be VERY problematic to disallow regular marriages for the EoC's male relatives as they are more likely to inherit
			}
		}

		third_party_allow = {
			show_only_failed_conditions = yes
			FROMFROM = {
				#custom_tooltip = {
					#text = can_marry_chinese_royal_tt
					can_marry = yes
					is_married = no
				#}
			}
		}

		effect = {
			FROM = {
				show_scope_change = no
				sound_effect = china_grace_spend
				if = {
					limit = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
					}
					if = {
						limit = { has_character_modifier = peace_deal_with_china }
						change_variable = {
							which = grace
							value = -1000
						}
					}
					else = {
						change_variable = {
							which = grace
							value = -1500
						}
						custom_tooltip = { text = chinese_imperial_marriage_peace_deal_tt }	
					}	
				}
				else = {
					if = {
						limit = { has_character_modifier = peace_deal_with_china }
						change_variable = {
							which = grace
							value = -1500
						}
					}
					else = {
						change_variable = {
							which = grace
							value = -2000
						}
						custom_tooltip = { text = chinese_imperial_marriage_peace_deal_tt }	
					}
				}
			}
			ROOT_FROMFROM = {
				save_event_target_as = husband_to_be
			}
			character_event = { id = soh.6355 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_imperial_marriage_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		third_party_filter = realm_including_me
		ai_third_party_filter = none
		third_party = FROM
		show_third_party_potential = yes
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
			is_chinese_emperor_trigger = no
			OR = {
				is_feudal = yes
				is_tribal = yes
				is_nomadic = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
			any_dynasty_member = {
				is_valid_dragon_bride_candidate = yes
			}
		}
		
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					check_variable = {
						which = grace
						value = 1000
					}
					AND = {
						has_minor_title = title_grand_chancellor
						check_variable = {
							which = grace
							value = 500
						}
					}
				}
				OR = {
					#custom_tooltip = {
						#text = can_marry_chinese_royal_tt
						AND = {
							is_adult = yes
							is_married = no
							is_female = no
						}
					#}
					custom_tooltip = {
						text = has_courtier_eligible_for_marriage_tt
						OR = {
							any_dynasty_member = {
								is_adult = yes
								is_married = no
								host = { character = ROOT_FROM }
								is_female = no
								is_landed = no
							}
							any_close_relative = {
								is_adult = yes
								is_married = no
								host = { character = ROOT_FROM }
								NOT = { any_spouse = { character = ROOT_FROM } } #turns out without this, it includes your spouse
								is_female = no
								is_landed = no
							}
						}
					}
				}
				prisoner = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
			}
			is_inaccessible_or_incapable_trigger = no
		}

		third_party_potential = {
			show_only_failed_conditions = yes
			FROMFROM = {
				show_scope_change = no
				OR = {
					dynasty = ROOT_FROM
					is_close_relative = ROOT_FROM
				}
				OR = {
					character = ROOT_FROM
					AND = {
						liege = { character = ROOT_FROM }
						ai = yes
					}
				}
				NOT = { any_spouse = { character = ROOT_FROM } }
				is_adult = yes
				is_betrothed = no
				is_female = no # Vanilla allows women to get Chinese Imperial Marriages, but it would be VERY problematic to disallow regular marriages for the EoC's male relatives as they are more likely to inherit
			}
		}

		third_party_allow = {
			show_only_failed_conditions = yes
			FROMFROM = {
				#custom_tooltip = {
					#text = can_marry_chinese_royal_tt
					can_marry = yes
					is_married = no
				#}
			}
		}

		effect = {
			FROM = {
				show_scope_change = no
				sound_effect = china_grace_spend
				if = {
					limit = {
						has_minor_title = title_grand_chancellor
					}
					change_variable = {
						which = grace
						value = -500
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -1000
					}
				}
			}
			ROOT_FROMFROM = {
				save_event_target_as = husband_to_be
			}
			character_event = { id = soh.6363 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_imperial_marriage_targeted_china = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		third_party_filter = realm_including_me
		ai_third_party_filter = none
		third_party = FROM
		show_third_party_potential = yes
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			is_close_to_china_or_along_the_silk_road_trigger = yes
			OR = {
				independent = yes
				real_tier = king
				has_minor_title = title_grand_chancellor
				i_am_appropriate_regent_trigger = yes
				liege = {
					independent = yes
				}
			}
			top_liege = {
				NOT = {
					government = chinese_imperial_government # Either under a pretender or a vassal of China
				}
			}
			OR = {
				is_feudal = yes
				is_tribal = yes
				is_nomadic = yes
			}
		}
		
		potential = {
			# The EoC must be using Grace mechanics
			e_china = {
				holder_scope = {
					is_chinese_emperor_trigger = yes
					# The target must be a Chinese princess
					ROOT = {
						is_valid_dragon_bride_candidate = yes
					}
				}
			}
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				OR = {
					independent = yes
					real_tier = king
					has_minor_title = title_grand_chancellor
					i_am_appropriate_regent_trigger = yes
					AND = {
						liege = {
							independent = yes
						}
						is_powerful_vassal = yes
					}
				}
				NOR = {
					any_war = {
						any_attacker = {
							character = FROM
						}
						any_defender = {
							is_chinese_emperor_trigger = yes
						}
					}
					any_war = {
						any_attacker = {
							is_chinese_emperor_trigger = yes
						}
						any_defender = {
							character = FROM
						}
					}
				}
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				conditional_tooltip = {
					trigger = { NOT = { has_character_modifier = peace_deal_with_china } }
					OR = {
						check_variable = {
							which = grace
							value = 2000
						}
						AND = {
							suzerain = {
								is_chinese_emperor_trigger = yes
							}
							OR = {
								is_tributary = {
									type = chinese_protectorate
								}
								is_tributary = {
									type = chinese_client_state
								}
							}
							check_variable = {
								which = grace
								value = 1500
							}
						}
					}
				}
				conditional_tooltip = {
					trigger = { has_character_modifier = peace_deal_with_china }
					OR = {
						check_variable = {
							which = grace
							value = 1500
						}
						AND = {
							suzerain = {
								is_chinese_emperor_trigger = yes
							}
							OR = {
								is_tributary = {
									type = chinese_protectorate
								}
								is_tributary = {
									type = chinese_client_state
								}
							}
							check_variable = {
								which = grace
								value = 1000
							}
						}
					}
				}
				OR = {
					#custom_tooltip = {
						#text = can_marry_chinese_royal_tt
						AND = {
							is_adult = yes
							is_married = no
							is_female = no
						}
					#}
					custom_tooltip = {
						text = has_courtier_eligible_for_marriage_tt
						OR = {
							any_dynasty_member = {
								is_adult = yes
								is_married = no
								host = { character = ROOT_FROM }
								is_female = no
								is_landed = no
							}
							any_close_relative = {
								is_adult = yes
								is_married = no
								host = { character = ROOT_FROM }
								NOT = { any_spouse = { character = ROOT_FROM } } #turns out without this, it includes your spouse
								is_female = no
								is_landed = no
							}
						}
					}
				}
				prisoner = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
			}
			e_china = {
				holder_scope = {
					is_inaccessible_or_incapable_trigger = no
				}
			}
		}

		third_party_potential = {
			show_only_failed_conditions = yes
			FROMFROM = {
				show_scope_change = no
				OR = {
					dynasty = ROOT_FROM
					is_close_relative = ROOT_FROM
				}
				OR = {
					character = ROOT_FROM
					AND = {
						liege = { character = ROOT_FROM }
						ai = yes
					}
				}
				NOT = { any_spouse = { character = ROOT_FROM } }
				is_adult = yes
				is_betrothed = no
				is_female = no # Vanilla allows women to get Chinese Imperial Marriages, but it would be VERY problematic to disallow regular marriages for the EoC's male relatives as they are more likely to inherit
			}
		}

		third_party_allow = {
			show_only_failed_conditions = yes
			FROMFROM = {
				#custom_tooltip = {
					#text = can_marry_chinese_royal_tt
					can_marry = yes
					is_married = no
				#}
			}
		}

		effect = {
			FROM = {
				show_scope_change = no
				sound_effect = china_grace_spend
				if = {
					limit = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
					}
					if = {
						limit = { has_character_modifier = peace_deal_with_china }
						change_variable = {
							which = grace
							value = -1000
						}
					}
					else = {
						change_variable = {
							which = grace
							value = -1500
						}
						custom_tooltip = { text = chinese_imperial_marriage_peace_deal_tt }	
					}	
				}
				else = {
					if = {
						limit = { has_character_modifier = peace_deal_with_china }
						change_variable = {
							which = grace
							value = -1500
						}
					}
					else = {
						change_variable = {
							which = grace
							value = -2000
						}
						custom_tooltip = { text = chinese_imperial_marriage_peace_deal_tt }	
					}
				}
			}
			save_event_target_as = dragon_bride_to_be
			ROOT_FROMFROM = {
				save_event_target_as = husband_to_be
			}
			character_event = { id = soh.6368 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_imperial_marriage_targeted_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		third_party_filter = realm_including_me
		ai_third_party_filter = none
		third_party = FROM
		show_third_party_potential = yes
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
			is_chinese_emperor_trigger = no
			OR = {
				is_feudal = yes
				is_tribal = yes
				is_nomadic = yes
			}
		}
		
		potential = {
			# The EoC must be using Grace mechanics
			e_china = {
				holder_scope = {
					is_chinese_emperor_trigger = yes
					# The target must be a Chinese princess
					ROOT = {
						is_valid_dragon_bride_candidate = yes
					}
				}
			}
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					check_variable = {
						which = grace
						value = 1000
					}
					AND = {
						has_minor_title = title_grand_chancellor
						check_variable = {
							which = grace
							value = 500
						}
					}
				}
				OR = {
					#custom_tooltip = {
						#text = can_marry_chinese_royal_tt
						AND = {
							is_adult = yes
							is_married = no
							is_female = no
						}
					#}
					custom_tooltip = {
						text = has_courtier_eligible_for_marriage_tt
						OR = {
							any_dynasty_member = {
								is_adult = yes
								is_married = no
								host = { character = ROOT_FROM }
								is_female = no
								is_landed = no
							}
							any_close_relative = {
								is_adult = yes
								is_married = no
								host = { character = ROOT_FROM }
								NOT = { any_spouse = { character = ROOT_FROM } } #turns out without this, it includes your spouse
								is_female = no
								is_landed = no
							}
						}
					}
				}
				prisoner = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
			}
			e_china = {
				holder_scope = {
					is_inaccessible_or_incapable_trigger = no
				}
			}
		}

		third_party_potential = {
			show_only_failed_conditions = yes
			FROMFROM = {
				show_scope_change = no
				OR = {
					dynasty = ROOT_FROM
					is_close_relative = ROOT_FROM
				}
				OR = {
					character = ROOT_FROM
					AND = {
						liege = { character = ROOT_FROM }
						ai = yes
					}
				}
				NOT = { any_spouse = { character = ROOT_FROM } }
				is_adult = yes
				is_betrothed = no
				is_female = no # Vanilla allows women to get Chinese Imperial Marriages, but it would be VERY problematic to disallow regular marriages for the EoC's male relatives as they are more likely to inherit
			}
		}

		third_party_allow = {
			show_only_failed_conditions = yes
			FROMFROM = {
				#custom_tooltip = {
					#text = can_marry_chinese_royal_tt
					can_marry = yes
					is_married = no
				#}
			}
		}

		effect = {
			FROM = {
				show_scope_change = no
				sound_effect = china_grace_spend
				if = {
					limit = {
						has_minor_title = title_grand_chancellor
					}
					change_variable = {
						which = grace
						value = -500
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -1000
					}
				}
			}
			save_event_target_as = dragon_bride_to_be
			ROOT_FROMFROM = {
				save_event_target_as = husband_to_be
			}
			character_event = { id = soh.6375 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_doctor_china = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			has_dlc = "Reapers"
			is_close_to_china_or_along_the_silk_road_trigger = yes
			OR = {
				independent = yes
				real_tier = king
				has_minor_title = title_grand_chancellor
				i_am_appropriate_regent_trigger = yes
				liege = {
					independent = yes
				}
			}
			top_liege = {
				NOT = {
					government = chinese_imperial_government # Either under a pretender or a vassal of China
				}
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				OR = {
					independent = yes
					real_tier = king
					has_minor_title = title_grand_chancellor
					i_am_appropriate_regent_trigger = yes
					AND = {
						liege = {
							independent = yes
						}
						is_powerful_vassal = yes
					}
				}
				NOR = {
					any_war = {
						any_attacker = {
							character = FROM
						}
						any_defender = {
							is_chinese_emperor_trigger = yes
						}
					}
					any_war = {
						any_attacker = {
							is_chinese_emperor_trigger = yes
						}
						any_defender = {
							character = FROM
						}
					}
				}
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					check_variable = {
						which = grace
						value = 400
					}
					AND = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
						check_variable = {
							which = grace
							value = 200
						}
					}
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
					}
					change_variable = {
						which = grace
						value = -200
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -400
					}
				}
			}
			character_event = { id = soh.6248 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_doctor_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			has_dlc = "Reapers"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				check_variable = {
					which = grace
					value = 200
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -200
				}
			}
			character_event = { id = soh.6254 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_siege_engineer_china = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			is_close_to_china_or_along_the_silk_road_trigger = yes
			OR = {
				independent = yes
				real_tier = king
				has_minor_title = title_grand_chancellor
				i_am_appropriate_regent_trigger = yes
				liege = {
					independent = yes
				}
			}
			top_liege = {
				NOT = {
					government = chinese_imperial_government # Either under a pretender or a vassal of China
				}
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				OR = {
					independent = yes
					real_tier = king
					has_minor_title = title_grand_chancellor
					i_am_appropriate_regent_trigger = yes
					AND = {
						liege = {
							independent = yes
						}
						is_powerful_vassal = yes
					}
				}
				NOR = {
					any_war = {
						any_attacker = {
							character = FROM
						}
						any_defender = {
							is_chinese_emperor_trigger = yes
						}
					}
					any_war = {
						any_attacker = {
							is_chinese_emperor_trigger = yes
						}
						any_defender = {
							character = FROM
						}
					}
				}
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					AND = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
						check_variable = {
							which = grace
							value = 500
						}
					}
					check_variable = {
						which = grace
						value = 1000
					}
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
					}
					change_variable = {
						which = grace
						value = -500
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -1000
					}
				}
			}
			character_event = { id = soh.6258 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_siege_engineer_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				check_variable = {
					which = grace
					value = 500
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -500
				}
			}
			character_event = { id = soh.6264 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_strategist_china = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			is_close_to_china_or_along_the_silk_road_trigger = yes
			OR = {
				independent = yes
				real_tier = king
				has_minor_title = title_grand_chancellor
				i_am_appropriate_regent_trigger = yes
				liege = {
					independent = yes
				}
			}
			top_liege = {
				NOT = {
					government = chinese_imperial_government # Either under a pretender or a vassal of China
				}
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				OR = {
					independent = yes
					real_tier = king
					has_minor_title = title_grand_chancellor
					i_am_appropriate_regent_trigger = yes
					AND = {
						liege = {
							independent = yes
						}
						is_powerful_vassal = yes
					}
				}
				NOR = {
					any_war = {
						any_attacker = {
							character = FROM
						}
						any_defender = {
							is_chinese_emperor_trigger = yes
						}
					}
					any_war = {
						any_attacker = {
							is_chinese_emperor_trigger = yes
						}
						any_defender = {
							character = FROM
						}
					}
				}
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					check_variable = {
						which = grace
						value = 1500
					}
					AND = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
						check_variable = {
							which = grace
							value = 750
						}
					}
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
					}
					change_variable = {
						which = grace
						value = -750
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -1500
					}
				}
			}
			character_event = { id = soh.6268 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_strategist_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				check_variable = {
					which = grace
					value = 750
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -750
				}
			}
			character_event = { id = soh.6274 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_administrator_china = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			is_close_to_china_or_along_the_silk_road_trigger = yes
			OR = {
				independent = yes
				real_tier = king
				has_minor_title = title_grand_chancellor
				i_am_appropriate_regent_trigger = yes
				liege = {
					independent = yes
				}
			}
			top_liege = {
				NOT = {
					government = chinese_imperial_government # Either under a pretender or a vassal of China
				}
			}
			NOR = {
				is_tribal = yes
				is_nomadic = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				OR = {
					independent = yes
					real_tier = king
					has_minor_title = title_grand_chancellor
					i_am_appropriate_regent_trigger = yes
					AND = {
						liege = {
							independent = yes
						}
						is_powerful_vassal = yes
					}
				}
				NOR = {
					any_war = {
						any_attacker = {
							character = FROM
						}
						any_defender = {
							is_chinese_emperor_trigger = yes
						}
					}
					any_war = {
						any_attacker = {
							is_chinese_emperor_trigger = yes
						}
						any_defender = {
							character = FROM
						}
					}
				}
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					check_variable = {
						which = grace
						value = 1500
					}
					AND = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
						check_variable = {
							which = grace
							value = 750
						}
					}
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
					}
					change_variable = {
						which = grace
						value = -750
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -1500
					}
				}
			}
			character_event = { id = soh.6278 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_administrator_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
			NOR = {
				is_tribal = yes
				is_nomadic = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				check_variable = {
					which = grace
					value = 750
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -750
				}
			}
			character_event = { id = soh.6284 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_master_engineer_china = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			is_close_to_china_or_along_the_silk_road_trigger = yes
			OR = {
				independent = yes
				real_tier = king
				has_minor_title = title_grand_chancellor
				i_am_appropriate_regent_trigger = yes
				liege = {
					independent = yes
				}
			}
			top_liege = {
				NOT = {
					government = chinese_imperial_government # Either under a pretender or a vassal of China
				}
			}
			NOR = {
				is_tribal = yes
				is_nomadic = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				OR = {
					independent = yes
					real_tier = king
					has_minor_title = title_grand_chancellor
					i_am_appropriate_regent_trigger = yes
					AND = {
						liege = {
							independent = yes
						}
						is_powerful_vassal = yes
					}
				}
				NOR = {
					any_war = {
						any_attacker = {
							character = FROM
						}
						any_defender = {
							is_chinese_emperor_trigger = yes
						}
					}
					any_war = {
						any_attacker = {
							is_chinese_emperor_trigger = yes
						}
						any_defender = {
							character = FROM
						}
					}
				}
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					check_variable = {
						which = grace
						value = 1500
					}
					AND = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
						check_variable = {
							which = grace
							value = 750
						}
					}
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
					}
					change_variable = {
						which = grace
						value = -750
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -1500
					}
				}
			}
			character_event = { id = soh.6288 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_master_engineer_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
			NOR = {
				is_tribal = yes
				is_nomadic = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				check_variable = {
					which = grace
					value = 750
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -1500
				}
			}
			character_event = { id = soh.6294 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	dismiss_councillor_china_vassal = {
		only_playable = yes
		ai = no
		filter = realm
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			is_chinese_emperor_trigger = no
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_voter = yes
			liege = {
				is_chinese_emperor_trigger = yes
			}
			NOT = {
				character = FROM
			}
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					custom_tooltip = {
						text = grace_can_fire_grand_chancellor
						AND = {
							ROOT = {
								has_minor_title = title_grand_chancellor
							}
							e_china = {
								NOT = {
									has_law = grand_chancellor_law_2
								}
							}
							check_variable = {
								which = grace
								value = 5000
							}
						}
					}
					custom_tooltip = {
						text = grace_can_fire_powerful_vassal
						AND = {
							ROOT = {
								NOT = {
									has_minor_title = title_grand_chancellor
								}
								is_landed = yes
								is_powerful_vassal = yes
							}
							e_china = {
								NOR = {
									has_law = ci_vassal_law_3
									has_law = ci_vassal_law_4
								}
							}
							OR = {
								AND = {
									has_minor_title = title_grand_chancellor
									check_variable = {
										which = grace
										value = 1000
									}
								}
								check_variable = {
									which = grace
									value = 2000
								}
							}
						}
					}
					custom_tooltip = {
						text = grace_can_fire_vassal
						AND = {
							ROOT = {
								NOT = {
									has_minor_title = title_grand_chancellor
								}
								is_landed = yes
								is_powerful_vassal = no
							}
							e_china = {
								NOT= {
									has_law = ci_vassal_law_4
								}
							}
							OR = {
								AND = {
									has_minor_title = title_grand_chancellor
									check_variable = {
										which = grace
										value = 500
									}
								}
								check_variable = {
									which = grace
									value = 1000
								}
							}
						}
					}
					custom_tooltip = {
						text = grace_can_fire_eunuch
						AND = {
							ROOT = {
								NOT = {
									has_minor_title = title_grand_chancellor
								}
								is_landed = no
								is_council_eunuch_trigger = yes
							}
							e_china = {
								NOR= {
									has_law = eunuch_law_3
									has_law = eunuch_law_4
								}
							}
							OR = {
								AND = {
									has_minor_title = title_grand_chancellor
									check_variable = {
										which = grace
										value = 500
									}
								}
								check_variable = {
									which = grace
									value = 1000
								}
							}
						}
					}
					custom_tooltip = {
						text = grace_can_fire_courtier
						AND = {
							ROOT = {
								NOT = {
									has_minor_title = title_grand_chancellor
								}
								is_landed = no
								is_council_eunuch_trigger = no
							}
							e_china = {
								NOT= {
									has_law = ci_courtier_law_4
								}
							}
							OR = {
								AND = {
									has_minor_title = title_grand_chancellor
									check_variable = {
										which = grace
										value = 500
									}
								}
								check_variable = {
									which = grace
									value = 1000
								}
							}
						}
					}
				}
			}
			e_china = {
				holder_scope = {
					is_inaccessible_or_incapable_trigger = no
				}
			}
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						ROOT = {
							has_minor_title = title_grand_chancellor
						}
					}
					change_variable = {
						which = grace
						value = -5000
					}
				}
				else_if = {
					limit = {
						ROOT = {
							is_powerful_vassal = yes
						}
					}
					if = {
						limit = {
							has_minor_title = title_grand_chancellor
						}
						change_variable = {
							which = grace
							value = -1000
						}
					}
					else = {
						change_variable = {
							which = grace
							value = -2000
						}
					}
				}
				else = {
					if = {
						limit = {
							has_minor_title = title_grand_chancellor
						}
						change_variable = {
							which = grace
							value = -500
						}
					}
					else = {
						change_variable = {
							which = grace
							value = -1000
						}
					}
				}
			}
			save_event_target_as = councillor_to_fire
			e_china = {
				holder_scope = {
					character_event = { id = soh.6308 } # EoC gets event
				}
			}
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	become_grand_chancellor_china_vassal = {
		only_playable = yes
		filter = independent_rulers
		ai_target_filter = none
		ai_check_interval = 12
		
		from_potential = {
			is_feudal = yes
			has_ambition = obj_become_grand_chancellor
			ai = no
			has_dlc = "Conclave"
			has_dlc = "Jade Dragon"
			liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				check_variable = {
					which = grace
					value = 10000
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -10000
				}
				custom_tooltip = {
					text = create_grand_chancellor_bloodline_effect
					character_event = { id = soh.5414 } # Create the bloodline
				}
			}
		}
		
		ai_will_do = {
			factor = 1
		}
	}
	
	request_command_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			is_chinese_emperor_trigger = no # The EoC cannot pay tribute to himself!
			liege = {
				is_chinese_emperor_trigger = yes
			}
			NOT = {
				has_minor_title = title_commander
			}
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				check_variable = {
					which = grace
					value = 500
				}
				is_adult = yes
				can_hold_title = title_commander
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -500
				}
			}
			character_event = { id = soh.6315 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	renounce_claims_eoc_china_vassal = {
		only_playable = yes
		ai = no 
		filter = independent_rulers
		ai_target_filter = none

		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			is_chinese_emperor_trigger = no # The EoC cannot pay tribute to himself!
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			# The receiver must be the EoC and the Grace mechanics must be active
			is_chinese_emperor_trigger = yes
		}
		
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					check_variable = {
						which = grace
						value = 5000
					}
					AND = {
						has_minor_title = title_grand_chancellor
						check_variable = {
							which = grace
							value = 2500
						}
					}
				}
				any_demesne_title = {
					claimed_by = ROOT
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						has_minor_title = title_grand_chancellor
					}
					change_variable = {
						which = grace
						value = -2500
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -5000
					}
				}
			}
			character_event = { id = soh.6322 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_imperial_praise_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			is_chinese_emperor_trigger = no # The EoC cannot pay tribute to himself!
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				OR = {
					check_variable = {
						which = grace
						value = 2000
					}
					AND = {
						has_minor_title = title_grand_chancellor
						check_variable = {
							which = grace
							value = 1000
						}
					}
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						has_minor_title = title_grand_chancellor
					}
					change_variable = {
						which = grace
						value = -1000
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -2000
					}
				}
			}
			character_event = { id = soh.6328 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_artifact_china = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			is_close_to_china_or_along_the_silk_road_trigger = yes
			is_chinese_emperor_trigger = no # The EoC cannot pay tribute to himself!
			OR = {
				independent = yes
				real_tier = king
				has_minor_title = title_grand_chancellor
				i_am_appropriate_regent_trigger = yes
				liege = {
					independent = yes
				}
			}
			top_liege = {
				NOT = {
					government = chinese_imperial_government # Either under a pretender or a vassal of China
				}
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				OR = {
					independent = yes
					real_tier = king
					has_minor_title = title_grand_chancellor
					i_am_appropriate_regent_trigger = yes
					AND = {
						liege = {
							independent = yes
						}
						is_powerful_vassal = yes
					}
				}
				NOR = {
					any_war = {
						any_attacker = {
							character = FROM
						}
						any_defender = {
							is_chinese_emperor_trigger = yes
						}
					}
					any_war = {
						any_attacker = {
							is_chinese_emperor_trigger = yes
						}
						any_defender = {
							character = FROM
						}
					}
				}
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				custom_tooltip = {
					text = chinese_artifact_has_all_tt
					hidden_tooltip = {
						has_all_grace_artifacts_trigger = no # TODO
					}
				}
				OR = {
					check_variable = {
						which = grace
						value = 1000
					}
					AND = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
						check_variable = {
							which = grace
							value = 500
						}
					}
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						suzerain = {
							is_chinese_emperor_trigger = yes
						}
						OR = {
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_client_state
							}
						}
					}
					change_variable = {
						which = grace
						value = -500
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -1000
					}
				}
			}
			character_event = { id = soh.6298 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	request_artifact_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			is_chinese_emperor_trigger = no # The EoC cannot pay tribute to himself!
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				custom_tooltip = {
					text = chinese_artifact_has_all_tt
					hidden_tooltip = {
						has_all_grace_artifacts_trigger = no # TODO
					}
				}
				check_variable = {
					which = grace
					value = 500
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -500
				}
			}
			character_event = { id = soh.6304 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	ask_to_decrease_tributary_tier = {
		only_independent = yes
		ai = no # The AI uses a regular decision
		filter = independent_rulers
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			is_chinese_emperor_trigger = no # The EoC cannot pay tribute to himself!
			NOT = {
				top_liege = {
					is_chinese_emperor_trigger = yes # Vassals of the EoC do not use Grace!
				}
			}
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
			any_tributary = {
				character = FROM
			}
		}
		
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				has_regent = no
				is_under_regency_trigger = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
			}
			is_inaccessible_or_incapable_trigger = no
			war = no
			FROM = {
				war = no # Is at peace
				suzerain = {
					character = ROOT
				}
			}
			FROM = {
				OR = {
					AND = {
						is_tributary = {
							type = chinese_client_state
						}
						OR = {
							AND = {
								NOT = { # If a Client State is too distant, China will be more willing to let them go
									any_realm_province = {
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
															is_tributary = {
																type = chinese_client_state
															}
															is_tributary = {
																type = chinese_protectorate
															}
															top_liege = {
																OR = {
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																}
															}
														}
														NOR = {
															character = FROM
															top_liege = {
																character = FROM
															}
														}
													}
												}
												AND = {
													is_land = no
													any_neighbor_province = {
														OR = {
															AND = {
																has_owner = yes
																owner = {
																	OR = {
																		character = ROOT
																		top_liege = {
																			character = ROOT
																		}
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																		top_liege = {
																			OR = {
																				is_tributary = {
																					type = chinese_client_state
																				}
																				is_tributary = {
																					type = chinese_protectorate
																				}
																			}
																		}
																	}
																	NOR = {
																		character = FROM
																		top_liege = {
																			character = FROM
																		}
																	}
																}
															}
															AND = {
																is_land = no
																any_neighbor_province = {
																	has_owner = yes
																	owner = {
																		OR = {
																			character = ROOT
																			top_liege = {
																				character = ROOT
																			}
																			is_tributary = {
																				type = chinese_client_state
																			}
																			is_tributary = {
																				type = chinese_protectorate
																			}
																			top_liege = {
																				OR = {
																					is_tributary = {
																						type = chinese_client_state
																					}
																					is_tributary = {
																						type = chinese_protectorate
																					}
																				}
																			}
																		}
																		NOR = {
																			character = FROM
																			top_liege = {
																				character = FROM
																			}
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
								check_variable = {
									which = grace
									value = 2500
								}
							}
							check_variable = {
								which = grace
								value = 5000
							}
						}
					}
					AND = {
						is_tributary = {
							type = chinese_protectorate
						}
						OR = {
							AND = {
								NOT = { # If a Protectorate is too distant, China will be more willing to let them go
									any_realm_province = {
										any_neighbor_province = {
											OR = {
												AND = {
													has_owner = yes
													owner = {
														OR = {
															character = ROOT
															top_liege = {
																character = ROOT
															}
														}
													}
												}
												AND = {
													is_land = no
													any_neighbor_province = {
														OR = {
															AND = {
																has_owner = yes
																owner = {
																	OR = {
																		character = ROOT
																		top_liege = {
																			character = ROOT
																		}
																	}
																}
															}
															AND = {
																is_land = no
																any_neighbor_province = {
																	has_owner = yes
																	owner = {
																		OR = {
																			character = ROOT
																			top_liege = {
																				character = ROOT
																			}
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
								check_variable = {
									which = grace
									value = 1000
								}
							}
							check_variable = {
								which = grace
								value = 2000
							}
						}
					}
					AND = {
						is_tributary = {
							type = chinese_imperial_tributary
						}
						check_variable = {
							which = grace
							value = 500
						}
					}
					AND = {
						NOR = {
							is_tributary = {
								type = chinese_client_state
							}
							is_tributary = {
								type = chinese_protectorate
							}
							is_tributary = {
								type = chinese_imperial_tributary
							}
						}
						check_variable = {
							which = grace
							value = 250
						}
					}
				}
			}
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				if = {
					limit = {
						is_tributary = {
							type = chinese_client_state
						}
					}
					if = {
						limit = {
							NOT = { # If a Client State is too distant, China will be more willing to let them go
								any_realm_province = {
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
														is_tributary = {
															type = chinese_client_state
														}
														is_tributary = {
															type = chinese_protectorate
														}
														top_liege = {
															OR = {
																is_tributary = {
																	type = chinese_client_state
																}
																is_tributary = {
																	type = chinese_protectorate
																}
															}
														}
													}
													NOR = {
														character = FROM
														top_liege = {
															character = FROM
														}
													}
												}
											}
											AND = {
												is_land = no
												any_neighbor_province = {
													OR = {
														AND = {
															has_owner = yes
															owner = {
																OR = {
																	character = ROOT
																	top_liege = {
																		character = ROOT
																	}
																	is_tributary = {
																		type = chinese_client_state
																	}
																	is_tributary = {
																		type = chinese_protectorate
																	}
																	top_liege = {
																		OR = {
																			is_tributary = {
																				type = chinese_client_state
																			}
																			is_tributary = {
																				type = chinese_protectorate
																			}
																		}
																	}
																}
																NOR = {
																	character = FROM
																	top_liege = {
																		character = FROM
																	}
																}
															}
														}
														AND = {
															is_land = no
															any_neighbor_province = {
																has_owner = yes
																owner = {
																	OR = {
																		character = ROOT
																		top_liege = {
																			character = ROOT
																		}
																		is_tributary = {
																			type = chinese_client_state
																		}
																		is_tributary = {
																			type = chinese_protectorate
																		}
																		top_liege = {
																			OR = {
																				is_tributary = {
																					type = chinese_client_state
																				}
																				is_tributary = {
																					type = chinese_protectorate
																				}
																			}
																		}
																	}
																	NOR = {
																		character = FROM
																		top_liege = {
																			character = FROM
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
						change_variable = {
							which = grace
							value = -2500
						}
					}
					else = {
						change_variable = {
							which = grace
							value = -5000
						}
					}
				}
				else_if = {
					limit = {
						is_tributary = {
							type = chinese_protectorate
						}
					}
					if = {
						limit = {
							NOT = { # If a Protectorate is too distant, China will be more willing to let them go
								any_realm_province = {
									any_neighbor_province = {
										OR = {
											AND = {
												has_owner = yes
												owner = {
													OR = {
														character = ROOT
														top_liege = {
															character = ROOT
														}
													}
												}
											}
											AND = {
												is_land = no
												any_neighbor_province = {
													OR = {
														AND = {
															has_owner = yes
															owner = {
																OR = {
																	character = ROOT
																	top_liege = {
																		character = ROOT
																	}
																}
															}
														}
														AND = {
															is_land = no
															any_neighbor_province = {
																has_owner = yes
																owner = {
																	OR = {
																		character = ROOT
																		top_liege = {
																			character = ROOT
																		}
																	}
																}
															}
														}
													}
												}
											}
										}
									}
								}
							}
						}
						change_variable = {
							which = grace
							value = -1000
						}
					}
					else = {
						change_variable = {
							which = grace
							value = -2000
						}
					}
				}
				else_if = {
					limit = {
						is_tributary = {
							type = chinese_imperial_tributary
						}
					}
					change_variable = {
						which = grace
						value = -500
					}
				}
				else = {
					change_variable = {
						which = grace
						value = -2500
					}
				}
			}
			character_event = { id = soh.6342 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
	
	ask_to_stop_mourning_china_vassal = {
		only_playable = yes
		ai = no
		filter = independent_rulers
		ai_target_filter = none
		
		from_potential = {
			ai = no
			has_dlc = "Jade Dragon"
			is_chinese_emperor_trigger = no # The EoC cannot pay tribute to himself!
			top_liege = {
				is_chinese_emperor_trigger = yes
			}
			trait = in_mourning
		}
		
		potential = {
			is_chinese_emperor_trigger = yes
		}
	
		allow = {
			show_only_failed_conditions = yes
			FROM = {
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				prisoner = no
				check_variable = {
					which = grace
					value = 1000
				}
			}
			is_inaccessible_or_incapable_trigger = no
		}
		
		effect = {
			FROM = {
				sound_effect = china_grace_spend
				change_variable = {
					which = grace
					value = -1000
				}
			}
			character_event = { id = soh.6335 } # EoC gets event
		}
		
		ai_will_do = {
			factor = 0
		}
	}
}

title_decisions = {
	request_border_adjustment = {
		only_independent = yes
		filter = all
		ai_target_filter = none
		
		from_potential = {
			ai = no
			is_new_world_invader_or_vassal_trigger = no
			has_dlc = "Jade Dragon"
			higher_tier_than = count
			is_tribal = no
			is_nomadic = no
			is_tributary = {
				type = chinese_client_state
			}
			suzerain = {
				is_chinese_emperor_trigger = yes
			}
			NOT = {
				top_liege = {
					government = chinese_imperial_government
				}
			}
		}
		
		potential = {
			tier = duke # Individual counties would be too performace-intensive
			# We either hold the relevant duchy or hold a liege title
			OR = {
				holder_scope = {
					character = FROM
				}
				de_jure_liege_or_above = FROM
			}
			# Any county belonging to the duchy is held by China or a vassal of China
			any_direct_de_jure_vassal_title = { # Checking individual baronies would be too much
				holder_scope = {
					OR = {
						is_chinese_emperor_trigger = yes
						top_liege = {
							is_chinese_emperor_trigger = yes
						}
					}
				}
				# The county in question is neither part of de jure China nor the China region
				NOR = {
					region = world_china
					de_jure_liege_or_above = e_china
				}
			}
		}
		
		allow = {
			FROM = {
				war = no
				prisoner = no
				NOT = { trait = incapable }
				is_inaccessible_trigger = no
				has_regent = no
				is_under_regency_trigger = no
				suzerain = {
					war = no
					prisoner = no
					NOT = { trait = incapable }
					is_inaccessible_or_incapable_trigger = no
					NOT = {
						has_truce = FROM
					}
				}
			}
			FROM = {
				check_variable = {
					which = grace
					value = 5000 # Expensive, both because you're getting land from China and because it is meant to be a trap to drain your Grace so that you can't use that to avoid becoming a vassal
				}
			}
		}
		
		effect = {
			ROOT = {
				save_event_target_as = border_adjustment_duchy
			}
			FROM = {
				change_variable = {
					which = grace
					value = -5000 
				}
				suzerain = {
					character_event = { id = soh.6348 } # EoC gets event
				}
			}
		}
		
		ai_will_do = {
			factor = 0
		}
	}
}